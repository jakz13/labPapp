<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/Logica/ManejadorCategoria.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/Logica/ManejadorCategoria.java" />
              <option name="originalContent" value="package Logica;&#10;&#10;import jakarta.persistence.EntityManager;&#10;import jakarta.persistence.EntityTransaction;&#10;import jakarta.persistence.TypedQuery;&#10;&#10;import java.util.HashMap;&#10;import java.util.List;&#10;import java.util.Map;&#10;&#10;public class ManejadorCategoria {&#10;&#10;    private Map&lt;String, Categoria&gt; categorias;&#10;    private static ManejadorCategoria instancia;&#10;&#10;    private ManejadorCategoria() {&#10;        categorias = new HashMap&lt;&gt;();&#10;    }&#10;&#10;    public static ManejadorCategoria getInstance() {&#10;        if (instancia == null) {&#10;            instancia = new ManejadorCategoria();&#10;        }&#10;        return instancia;&#10;    }&#10;&#10;    // === Cargar todas las categorías desde la BD a memoria ===&#10;    public void cargarCategoriasDesdeBD(EntityManager em) {&#10;        TypedQuery&lt;Categoria&gt; query = em.createQuery(&quot;SELECT c FROM Categoria c&quot;, Categoria.class);&#10;        List&lt;Categoria&gt; categoriasPersistidas = query.getResultList();&#10;        for (Categoria c : categoriasPersistidas) {&#10;            categorias.put(c.getNombre(), c);&#10;        }&#10;    }&#10;&#10;    // === Agregar categoría en memoria y en BD ===&#10;    public void agregarCategoria(Categoria categoria, EntityManager em) {&#10;        categorias.put(categoria.getNombre(), categoria);&#10;&#10;        EntityTransaction tx = em.getTransaction();&#10;        try {&#10;            tx.begin();&#10;            em.persist(categoria);&#10;            tx.commit();&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            e.printStackTrace();&#10;        }&#10;    }&#10;&#10;    // === Buscar categoría en memoria ===&#10;    public Categoria buscarCategorias(String nombre) {&#10;        return categorias.get(nombre);&#10;    }&#10;&#10;    // === Obtener todas las categorías ===&#10;    public Map&lt;String, Categoria&gt; getCategorias() {&#10;        return categorias;&#10;    }&#10;&#10;}&#10;" />
              <option name="updatedContent" value="package Logica;&#10;&#10;import jakarta.persistence.EntityManager;&#10;import jakarta.persistence.EntityTransaction;&#10;import jakarta.persistence.TypedQuery;&#10;&#10;import java.util.HashMap;&#10;import java.util.List;&#10;import java.util.Map;&#10;&#10;public class ManejadorCategoria {&#10;&#10;    private Map&lt;String, Categoria&gt; categorias;&#10;    private static ManejadorCategoria instancia;&#10;&#10;    private ManejadorCategoria() {&#10;        categorias = new HashMap&lt;&gt;();&#10;    }&#10;&#10;    public static ManejadorCategoria getInstance() {&#10;        if (instancia == null) {&#10;            instancia = new ManejadorCategoria();&#10;        }&#10;        return instancia;&#10;    }&#10;&#10;    // === Cargar todas las categorías desde la BD a memoria ===&#10;    public void cargarCategoriasDesdeBD(EntityManager em) {&#10;        TypedQuery&lt;Categoria&gt; query = em.createQuery(&quot;SELECT c FROM Categoria c&quot;, Categoria.class);&#10;        List&lt;Categoria&gt; categoriasPersistidas = query.getResultList();&#10;        for (Categoria c : categoriasPersistidas) {&#10;            categorias.put(c.getNombre(), c);&#10;        }&#10;    }&#10;&#10;    // === Agregar categoría en memoria y en BD ===&#10;    public void agregarCategoria(Categoria categoria, EntityManager em) {&#10;        categorias.put(categoria.getNombre(), categoria);&#10;&#10;        EntityTransaction tx = em.getTransaction();&#10;        try {&#10;            tx.begin();&#10;            em.persist(categoria);&#10;            tx.commit();&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            e.printStackTrace();&#10;        }&#10;    }&#10;&#10;    // === Buscar categoría en memoria ===&#10;    public Categoria buscarCategorias(String nombre) {&#10;        return categorias.get(nombre);&#10;    }&#10;&#10;    // === Obtener todas las categorías ===&#10;    public Map&lt;String, Categoria&gt; getCategorias() {&#10;        return categorias;&#10;    }&#10;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/logica/Sistema.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/logica/Sistema.java" />
              <option name="originalContent" value="package logica;&#10;&#10;import jakarta.persistence.EntityManager;&#10;import jakarta.persistence.EntityManagerFactory;&#10;import jakarta.persistence.EntityTransaction;&#10;import jakarta.persistence.Persistence;&#10;import jakarta.persistence.PersistenceException;&#10;&#10;import DataTypes.DtCliente;&#10;import DataTypes.DtAerolinea;&#10;import DataTypes.DtCiudad;&#10;import DataTypes.DtCategoria;&#10;import DataTypes.DtVuelo;&#10;import DataTypes.DtReserva;&#10;import DataTypes.DtPaquete;&#10;import DataTypes.DtRutaVuelo;&#10;import DataTypes.DtItemPaquete;&#10;&#10;&#10;import java.time.LocalDate;&#10;import java.time.LocalTime;&#10;import java.util.List;&#10;import java.util.ArrayList;&#10;&#10;import java.util.logging.Level;&#10;import java.util.logging.Logger;&#10;&#10;import static logica.EstadoRuta.*;&#10;&#10;/**&#10; * Implementación de la interfaz ISistema que actúa como fachada para la&#10; * lógica de negocio. Maneja inicialización, operaciones CRUD y coordinación&#10; * entre los manejadores (clientes, aerolíneas, rutas, vuelos, paquetes, etc.).&#10; */&#10;public class Sistema implements ISistema {&#10;&#10;    private static final Logger LOGGER = Logger.getLogger(Sistema.class.getName());&#10;&#10;    private EntityManagerFactory emf;&#10;    private EntityManager entManager;&#10;&#10;    private ManejadorCliente manejadorCliente;&#10;    private ManejadorAerolinea manejadorAerolinea;&#10;    private ManejadorCiudad manejadorCiudad;&#10;    private ManejadorRutaVuelo manejadorRutaVuelo;&#10;    private ManejadorVuelo manejadorVuelo;&#10;    private ManejadorPaquete manejadorPaquete;&#10;    private ManejadorCategoria manejadorCategoria;&#10;    private ManejadorFollow manejadorFollow;&#10;&#10;    public Sistema() {&#10;        this.emf = Persistence.createEntityManagerFactory(&quot;LAB_PA&quot;);&#10;        this.entManager = emf.createEntityManager();&#10;        this.manejadorCliente = ManejadorCliente.getInstance();&#10;        this.manejadorPaquete = ManejadorPaquete.getInstance();&#10;        this.manejadorAerolinea = ManejadorAerolinea.getInstance();&#10;        this.manejadorRutaVuelo = ManejadorRutaVuelo.getInstance();&#10;        this.manejadorVuelo = ManejadorVuelo.getInstance();&#10;        this.manejadorCiudad = ManejadorCiudad.getInstance();&#10;        this.manejadorCategoria = ManejadorCategoria.getInstance();&#10;        this.manejadorFollow = ManejadorFollow.getInstance();&#10;        // Precargar datos si la base está vacía&#10;&#10;    }&#10;&#10;    /** Carga todos los datos desde la base de datos a los manejadores en memoria. */&#10;    @Override&#10;    public void cargarDesdeBd() {&#10;        // Usar un EntityManager local para la recarga, evitando cerrar el EntityManager&#10;        // compartido del Sistema que puede estar en uso por otras operaciones.&#10;        EntityManager emLocal = null;&#10;        try {&#10;            emLocal = emf.createEntityManager();&#10;&#10;            manejadorCliente.cargarClientesDesdeBD(emLocal);&#10;            manejadorAerolinea.cargarAerolineasDesdeBD(emLocal);&#10;            manejadorCiudad.cargarCiudadesDesdeBD(emLocal);&#10;            manejadorRutaVuelo.cargarRutasDesdeBD(emLocal);&#10;            manejadorVuelo.cargarVuelosDesdeBD(emLocal);&#10;            manejadorPaquete.cargarPaquetesDesdeBD(emLocal);&#10;            manejadorCategoria.cargarCategoriasDesdeBD(emLocal);&#10;            manejadorFollow.cargarFollowsDesdeBD(emLocal);&#10;        } finally {&#10;            if (emLocal != null &amp;&amp; emLocal.isOpen()) emLocal.close();&#10;        }&#10;    }&#10;&#10;    // =================== USUARIOS CON CONTRASEÑA ===================&#10;&#10;    /**&#10;     * Alta de cliente con contraseña. Valida unicidad y persiste el cliente.&#10;     */&#10;    @Override&#10;    public void altaCliente(String nickname, String nombre, String apellido, String correo,&#10;                            LocalDate fechaNac, String nacionalidad, TipoDoc tipoDoc,&#10;                            String numDoc, String password, String imagenUrl) {&#10;        if (manejadorAerolinea.obtenerAerolinea(nickname) == null&#10;                &amp;&amp; manejadorCliente.obtenerCliente(nickname) == null) {&#10;            Cliente cliente = new Cliente(nickname, nombre, apellido, correo, fechaNac, nacionalidad, tipoDoc, numDoc, password, imagenUrl);&#10;            manejadorCliente.agregarCliente(cliente, entManager);&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Ya existe un usuario con ese nickname&quot;);&#10;        }&#10;    }&#10;&#10;    /** Método de compatibilidad: indica que se debe usar la versión con contraseña. */&#10;    public void altaCliente(String nickname, String nombre, String apellido, String correo,&#10;                            LocalDate fechaNac, String nacionalidad, TipoDoc tipoDoc, String numDoc) {&#10;        throw new UnsupportedOperationException(&quot;Use el método con contraseña: altaCliente(..., password)&quot;);&#10;    }&#10;&#10;    /** Alta de aerolínea con contraseña y persistencia. */&#10;    @Override&#10;    public void altaAerolinea(String nickname, String nombre, String descripcion,&#10;                              String email, String sitioWeb, String password, String imagenUrl) {&#10;        if (manejadorAerolinea.obtenerAerolinea(nickname) == null&#10;                &amp;&amp; manejadorCliente.obtenerCliente(nickname) == null) {&#10;            Aerolinea aerolinea = new Aerolinea(nickname, nombre, email, password, descripcion, sitioWeb, imagenUrl);&#10;            manejadorAerolinea.agregarAerolinea(aerolinea, entManager);&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Ya existe un usuario con ese nickname&quot;);&#10;        }&#10;    }&#10;&#10;    /** Método de compatibilidad para alta de aerolínea sin contraseña (no soportado). */&#10;    public void altaAerolinea(String nickname, String nombre, String descripcion,&#10;                              String email, String sitioWeb) {&#10;        throw new UnsupportedOperationException(&quot;Use el método con contraseña: altaAerolinea(..., password)&quot;);&#10;    }&#10;&#10;    /**&#10;     * Actualiza la contraseña de un usuario (cliente o aerolínea) identificado por email.&#10;     */&#10;    @Override&#10;    public void actualizarPassword(String email, String nuevaPassword) {&#10;        try {&#10;            manejadorCliente.actualizarPassword(email, nuevaPassword, entManager);&#10;            LOGGER.info(() -&gt; &quot;Contraseña actualizada para cliente: &quot; + email);&#10;            return;&#10;        } catch (IllegalArgumentException e) {&#10;            // Si no es cliente, continuar&#10;            LOGGER.log(Level.FINE, () -&gt; &quot;El usuario con email &quot; + email + &quot; no es un cliente. Intentando con aerolínea...&quot;);&#10;        }&#10;&#10;        try {&#10;            manejadorAerolinea.actualizarPassword(email, nuevaPassword, entManager);&#10;            LOGGER.info(() -&gt; &quot;Contraseña actualizada para aerolínea: &quot; + email);&#10;            return;&#10;        } catch (IllegalArgumentException e) {&#10;            // Si no es aerolínea, lanzar error&#10;            LOGGER.log(Level.FINE, () -&gt; &quot;El usuario con email &quot; + email + &quot; no es una aerolínea.&quot;);&#10;        }&#10;        throw new IllegalArgumentException(&quot;Usuario no encontrado: &quot; + email);&#10;    }&#10;&#10;    /** Modifica los datos completos de un cliente y persiste los cambios. */&#10;    @Override&#10;    public void modificarDatosClienteCompleto(String nickname, String nombre, String apellido,&#10;                                              String nacionalidad, LocalDate fechaNacimiento, TipoDoc tipoDocumento,&#10;                                              String numeroDocumento, String password, String imagenUrl) {&#10;        manejadorCliente.modificarDatosClienteCompleto(nickname, nombre, apellido, nacionalidad, fechaNacimiento,&#10;                tipoDocumento, numeroDocumento, password, imagenUrl, entManager);&#10;    }&#10;&#10;    /** Modifica los datos completos de una aerolínea y persiste los cambios. */&#10;    @Override&#10;    public void modificarDatosAerolineaCompleto(String nickname, String nombre, String descripcion,&#10;                                                String sitioWeb, String password, String imagenUrl) {&#10;        manejadorAerolinea.modificarDatosAerolineaCompleto(nickname, nombre, descripcion, sitioWeb, password, imagenUrl, entManager);&#10;    }&#10;&#10;    // =================== LOGIN ===================&#10;&#10;    /** Verifica credenciales buscando primero en clientes y luego en aerolíneas. */&#10;    @Override&#10;    public boolean verificarLogin(String email, String password) {&#10;        // Primero buscar como cliente&#10;        if (manejadorCliente.verificarLogin(email, password)) {&#10;            return true;&#10;        }&#10;        // Si no es cliente, buscar como aerolínea&#10;        return manejadorAerolinea.verificarLogin(email, password);&#10;    }&#10;&#10;    /** Devuelve el tipo de usuario ('CLIENTE' o 'AEROLINEA') según el email. */&#10;    @Override&#10;    public String obtenerTipoUsuario(String email) {&#10;        if (manejadorCliente.obtenerClientePorEmail(email) != null) {&#10;            return &quot;CLIENTE&quot;;&#10;        } else if (manejadorAerolinea.obtenerAerolineaPorEmail(email) != null) {&#10;            return &quot;AEROLINEA&quot;;&#10;        }&#10;        return null;&#10;    }&#10;// =================== MÉTODOS PARA IMÁGENES ===================&#10;&#10;    /** Actualiza la URL de la imagen de un cliente. */&#10;    @Override&#10;    public void actualizarImagenCliente(String nickname, String imagenUrl) {&#10;        manejadorCliente.actualizarImagenCliente(nickname, imagenUrl, entManager);&#10;    }&#10;&#10;    /** Actualiza la URL de la imagen de una aerolínea. */&#10;    @Override&#10;    public void actualizarImagenAerolinea(String nickname, String imagenUrl) {&#10;        manejadorAerolinea.actualizarImagenAerolinea(nickname, imagenUrl, entManager);&#10;    }&#10;&#10;    /** Actualiza la imagen de una ruta y persiste el cambio. */&#10;    @Override&#10;    public void actualizarImagenRuta(String nombreRuta, String imagenUrl) {&#10;        manejadorRutaVuelo.actualizarImagenRuta(nombreRuta, imagenUrl, entManager);&#10;    }&#10;&#10;    // Métodos para obtener URLs de imagen (si los necesitan)&#10;    public String obtenerImagenCliente(String nickname) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        return cliente != null ? cliente.getImagenUrl() : null;&#10;    }&#10;&#10;    public String obtenerImagenAerolinea(String nickname) {&#10;        DtAerolinea aerolinea = manejadorAerolinea.getDtAerolineas().stream()&#10;                .filter(a -&gt; a.getNickname().equals(nickname))&#10;                .findFirst()&#10;                .orElse(null);&#10;        return aerolinea != null ? aerolinea.getImagenUrl() : null;&#10;    }&#10;&#10;    public String obtenerImagenRuta(String nombreRuta) {&#10;        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);&#10;        return ruta != null ? ruta.getImagenUrl() : null;&#10;    }&#10;&#10;    // ======================================&#10;&#10;&#10;    @Override&#10;    public List&lt;DtCliente&gt; listarClientes() {&#10;        return manejadorCliente.getClientes();&#10;    }&#10;&#10;    @Override&#10;    public Cliente verInfoCliente(String nickname) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        Cliente cliente1 = manejadorCliente.obtenerClientePorEmail(cliente.getEmail());&#10;        if (cliente1 != null) {&#10;            return cliente1;&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public DtCliente obtenerCliente(String nickname) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        return cliente;&#10;    }&#10;&#10;    @Override&#10;    public Aerolinea verInfoAerolinea(String nickname) {&#10;        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        if (aerolinea != null) {&#10;            return aerolinea;&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public DtAerolinea obtenerAerolinea(String nickname) {&#10;        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        if (aerolinea == null) {&#10;            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);&#10;        }&#10;        return new DtAerolinea(&#10;                aerolinea.getNickname(),&#10;                aerolinea.getNombre(),&#10;                aerolinea.getEmail(),&#10;                aerolinea.getDescripcion(),&#10;                aerolinea.getSitioWeb(),&#10;                aerolinea.getImagenUrl(),&#10;                aerolinea.getRutasVuelo()&#10;        );&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtAerolinea&gt; listarAerolineas() {&#10;        return manejadorAerolinea.getDtAerolineas();&#10;    }&#10;&#10;    // --- CIUDADES ---&#10;    @Override&#10;    public void altaCiudad(String nombre, String pais) {&#10;        String clave = nombre.trim().toLowerCase();&#10;&#10;        if (manejadorCiudad.obtenerCiudad(clave) != null) {&#10;            throw new IllegalArgumentException(&quot;Ya existe una ciudad con el nombre: &quot; + nombre);&#10;        }&#10;&#10;        Ciudad ciudad = new Ciudad(nombre, pais);&#10;        manejadorCiudad.agregarCiudad(ciudad, entManager);&#10;    }&#10;&#10;    @Override&#10;    public void altaRutaVuelo(String nombre, String descripcion, String descripcionCorta, DtAerolinea aerolinea,&#10;                              String ciudadOrigen, String ciudadDestino, String hora,&#10;                              LocalDate fechaAlta, double costoTurista, double costoEjecutivo,&#10;                              double costoEquipajeExtra, String[] categorias, String imagenUrl, String videoUrl) {&#10;&#10;        Aerolinea aero = manejadorAerolinea.obtenerAerolinea(aerolinea.getNickname());&#10;        if (aero == null) {&#10;            throw new IllegalArgumentException(&quot;No existe Aerolínea con nickname: &quot; + aerolinea.getNickname());&#10;        }&#10;&#10;        if (manejadorRutaVuelo.getRuta(nombre) != null) {&#10;            throw new IllegalArgumentException(&quot;Ya existe una ruta de vuelo con el nombre: &quot; + nombre);&#10;        }&#10;&#10;        if (ciudadOrigen.equalsIgnoreCase(ciudadDestino)) {&#10;            throw new IllegalArgumentException(&quot;La ciudad de origen y destino no pueden ser iguales.&quot;);&#10;        }&#10;&#10;        List&lt;String&gt; categoriaValida = new ArrayList&lt;&gt;();&#10;        for (String cat : categorias) {&#10;            Categoria categoria = manejadorCategoria.buscarCategorias(cat);&#10;            if (categoria != null) {&#10;                categoriaValida.add(cat);&#10;            }&#10;        }&#10;        if (categoriaValida.isEmpty()) {&#10;            throw new IllegalArgumentException(&quot;La ruta debe pertenecer a al menos una categoría válida.&quot;);&#10;        }&#10;&#10;        RutaVuelo rutaVuelo = new RutaVuelo(nombre, descripcion, descripcionCorta, aero, ciudadOrigen, ciudadDestino,&#10;                hora, fechaAlta, costoTurista, costoEjecutivo,&#10;                costoEquipajeExtra, categoriaValida, imagenUrl, videoUrl);&#10;&#10;        manejadorRutaVuelo.agregarRutaVuelo(rutaVuelo, entManager);&#10;        manejadorAerolinea.agregarRutaVueloAAerolinea(aero.getNickname(), rutaVuelo, entManager);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtAerolinea&gt; obtenerAerolineasConRutasPendientes() {&#10;        List&lt;DtAerolinea&gt; aerolineasConPendientes = new ArrayList&lt;&gt;();&#10;        for (DtAerolinea aero : manejadorAerolinea.getDtAerolineas()) {&#10;            List&lt;RutaVuelo&gt; rutasPendientes = manejadorRutaVuelo.getRutasPorEstadoYAerolinea(&#10;                    aero.getNombre(), INGRESADA);&#10;            if (!rutasPendientes.isEmpty()) {&#10;                aerolineasConPendientes.add(aero);&#10;            }&#10;        }&#10;&#10;        return aerolineasConPendientes;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; obtenerRutasPendientesPorAerolinea(String nombreAerolinea) {&#10;&#10;        cargarDesdeBd();&#10;        List&lt;RutaVuelo&gt; rutasPendientes = manejadorRutaVuelo.getRutasPorEstadoYAerolinea(&#10;                nombreAerolinea, INGRESADA);&#10;&#10;        List&lt;DtRutaVuelo&gt; dtRutasPendientes = new ArrayList&lt;&gt;();&#10;        for (RutaVuelo ruta : rutasPendientes) {&#10;            dtRutasPendientes.add(ruta.getDtRutaVuelo());&#10;        }&#10;        return dtRutasPendientes;&#10;    }&#10;&#10;    @Override&#10;    public void aceptarRutaVuelo(String nombreRuta) {&#10;        EntityManager emLocal = null;&#10;        try {&#10;            emLocal = emf.createEntityManager();&#10;            manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, EstadoRuta.CONFIRMADA, emLocal);&#10;            cargarDesdeBd();&#10;        } finally {&#10;            if (emLocal != null &amp;&amp; emLocal.isOpen()) emLocal.close();&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void rechazarRutaVuelo(String nombreRuta) {&#10;        EntityManager emLocal = null;&#10;        try {&#10;            emLocal = emf.createEntityManager();&#10;            manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, EstadoRuta.RECHAZADA, emLocal);&#10;            // Recargar datos en memoria para reflejar cambios en la UI&#10;            cargarDesdeBd();&#10;        } finally {&#10;            if (emLocal != null &amp;&amp; emLocal.isOpen()) emLocal.close();&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public RutaVuelo obtenerRuta(String nombreRuta) {&#10;        return manejadorRutaVuelo.getRuta(nombreRuta);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; listarRutasPorAerolinea(String nombreAerolinea) {&#10;        cargarDesdeBd();&#10;        return manejadorAerolinea.obtenerRutaVueloDeAerolinea(nombreAerolinea);&#10;    }&#10;&#10;    @Override&#10;    public void altaVuelo(String nombreVuelo, String nombreAereolinea, String nombreRuta,&#10;                          LocalDate fecha, int duracion, int asientosTurista,&#10;                          int asientosEjecutivo, LocalDate fechaAlta, String imagenUrl) {&#10;&#10;        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);&#10;        if (ruta == null) {&#10;            throw new IllegalArgumentException(&quot;La ruta &quot; + nombreRuta + &quot; no existe.&quot;);&#10;        }&#10;&#10;        // **Validar estado de la ruta**&#10;        EstadoRuta estado = ruta.getEstado();&#10;        if (estado != EstadoRuta.CONFIRMADA) {&#10;            if (estado == EstadoRuta.INGRESADA) {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No se puede dar de alta un vuelo para la ruta &quot; + nombreRuta +&#10;                                &quot; porque su estado es INGRESADA. Primero debe ser confirmada.&quot;&#10;                );&#10;            } else if (estado == EstadoRuta.FINALIZADA) {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No se puede dar de alta un vuelo para la ruta &quot; + nombreRuta +&#10;                                &quot; porque está FINALIZADA.&quot;&#10;                );&#10;            } else {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No se puede dar de alta un vuelo para la ruta &quot; + nombreRuta +&#10;                                &quot; porque no está CONFIRMADA. Estado actual: &quot; + estado&#10;                );&#10;            }&#10;        }&#10;&#10;        // Evitar acceder a colecciones lazy de RutaVuelo (puede causar LazyInitializationException)&#10;        if (manejadorVuelo.existeVuelo(nombreVuelo)) {&#10;            throw new IllegalArgumentException(&quot;Ya existe un vuelo con el nombre &quot; + nombreVuelo + &quot; en el sistema&quot;);&#10;        }&#10;&#10;        Vuelo vuelo = new Vuelo(nombreVuelo, nombreAereolinea, ruta, fecha, duracion,&#10;                asientosTurista, asientosEjecutivo, fechaAlta, imagenUrl);&#10;&#10;        manejadorVuelo.agregarVuelo(vuelo, entManager);&#10;        manejadorRutaVuelo.agregarVueloARuta(nombreRuta, vuelo, entManager);&#10;    }&#10;&#10;&#10;    public Vuelo obtenerVuelo(String nombreVuelo) {&#10;        return manejadorVuelo.getVuelo(nombreVuelo);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtVuelo&gt; listarVuelosPorRuta(String nombreRuta) {&#10;        return manejadorRutaVuelo.obtenerVuelosPorRuta(nombreRuta);&#10;    }&#10;&#10;    @Override&#10;    public DtVuelo verInfoVueloDt(String nombreVuelo) {&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);&#10;        }&#10;        return vuelo.getDtVuelo();&#10;    }&#10;&#10;    @Override&#10;    public Vuelo verInfoVuelo(String nombreVuelo) {&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);&#10;        }&#10;        return vuelo;&#10;    }&#10;&#10;    // --- RESERVA ---&#10;    /*@Override&#10;    public void crearYRegistrarReserva(String nicknameCliente, String nombreVuelo, LocalDate fechaReserva, double costo,&#10;                                       TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra,&#10;                                       List&lt;Pasajero&gt; pasajeros) {&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;El vuelo no existe: &quot; + nombreVuelo);&#10;        }&#10;&#10;        if (ManejadorVuelo.getInstance().tieneReservaDeCliente(nicknameCliente, vuelo)) {&#10;            throw new IllegalArgumentException(&#10;                    &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo +&#10;                            &quot;. Debe elegir otro vuelo o ruta.&quot;&#10;            );&#10;        }&#10;&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        if (cliente != null) {&#10;            for (DtReserva r : cliente.getReservas()) {&#10;                if (r.getVuelo().equals(nombreVuelo)) {&#10;                    throw new IllegalArgumentException(&#10;                            &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo + &quot;.&quot;&#10;                    );&#10;                }&#10;            }&#10;        }&#10;&#10;        // CREAR RESERVA SIN ID - se generará automáticamente&#10;        Reserva reserva = new Reserva(&#10;                costo, tipoAsiento, cantidadPasajes, unidadesEquipajeExtra, pasajeros, vuelo&#10;        );&#10;&#10;        registrarReservaVuelo(nicknameCliente, nombreVuelo, reserva);&#10;    }*/&#10;&#10;    @Override&#10;    public void crearYRegistrarReserva(String nicknameCliente, String nombreVuelo, LocalDate fechaReserva, double costo,&#10;                                       TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra,&#10;                                       List&lt;Pasajero&gt; pasajeros) {&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;El vuelo no existe: &quot; + nombreVuelo);&#10;        }&#10;        List&lt;DtReserva&gt; reservas= vuelo.getDtReservas();&#10;        int asientosOcupadosTurista = 0;&#10;        int asientosOcupadosEjecutivo = 0;&#10;        // Comprobar disponibilidad de asientos&#10;        for (DtReserva reserva : reservas) {&#10;            if (reserva.getTipoAsiento() == tipoAsiento) {&#10;                if (tipoAsiento == TipoAsiento.TURISTA) {&#10;                    asientosOcupadosTurista +=reserva.getCantidadPasajes();&#10;&#10;                } else if (tipoAsiento == TipoAsiento.EJECUTIVO) {&#10;                    asientosOcupadosEjecutivo += reserva.getCantidadPasajes();&#10;&#10;                }&#10;            }&#10;        }&#10;        if (tipoAsiento == TipoAsiento.TURISTA) {&#10;            if (asientosOcupadosTurista + cantidadPasajes &gt; vuelo.getAsientosTurista()) {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No hay suficientes asientos disponibles en clase TURISTA para el vuelo &quot; + nombreVuelo&#10;                );&#10;            }&#10;        }else {&#10;            if (asientosOcupadosEjecutivo + cantidadPasajes &gt; vuelo.getAsientosEjecutivo()) {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No hay suficientes asientos disponibles en clase EJECUTIVO para el vuelo &quot; + nombreVuelo&#10;                );&#10;            }&#10;        }&#10;&#10;        // Comprobar si el cliente ya tiene una reserva en ese vuelo (buscar por nickname en las reservas del vuelo)&#10;        if (manejadorVuelo.tieneReservaDeCliente(nicknameCliente, vuelo)) {&#10;            throw new IllegalArgumentException(&#10;                    &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo +&#10;                            &quot;. Debe elegir otro vuelo o ruta.&quot;&#10;            );&#10;        }&#10;&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        if (cliente != null) {&#10;            for (DtReserva r : cliente.getReservas()) {&#10;                if (r.getVuelo().equals(nombreVuelo)) {&#10;                    throw new IllegalArgumentException(&#10;                            &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo + &quot;.&quot;&#10;                    );&#10;                }&#10;            }&#10;        }&#10;&#10;        // CREAR RESERVA SIN ID - se generará automáticamente&#10;        Reserva reserva = new Reserva(&#10;                costo, tipoAsiento, cantidadPasajes, unidadesEquipajeExtra, pasajeros, vuelo&#10;        );&#10;&#10;        registrarReservaVuelo(nicknameCliente, nombreVuelo, reserva);&#10;    }&#10;&#10;&#10;    @Override&#10;    public void registrarReservaVuelo(String nicknameCliente, String nombreVuelo, Reserva reserva) {&#10;        EntityTransaction entTransaction = entManager.getTransaction();&#10;        try {&#10;            entTransaction.begin();&#10;&#10;            DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;            Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;&#10;            if (cliente == null) {&#10;                throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;            }&#10;            if (vuelo == null) {&#10;                throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);&#10;            }&#10;&#10;            if (manejadorVuelo.tieneReservaDeCliente(nicknameCliente, vuelo)) {&#10;                throw new IllegalArgumentException(&quot;El cliente ya tiene una reserva para este vuelo&quot;);&#10;            }&#10;&#10;            // Persistir reserva para generar ID automático&#10;            entManager.persist(reserva);&#10;            entManager.flush(); // Forzar generación del ID&#10;&#10;            // Agregar reserva al vuelo y al cliente&#10;            vuelo.agregarReserva(reserva);&#10;            manejadorCliente.agregarReserva(reserva, nicknameCliente, reserva.getId(), entManager);&#10;            manejadorVuelo.actualizarVuelo(vuelo, entManager); // Ahora sin transacción interna&#10;&#10;            entTransaction.commit();&#10;&#10;        } catch (PersistenceException e) {&#10;            if (entTransaction.isActive()) {&#10;                entTransaction.rollback();&#10;            }&#10;            throw new IllegalStateException(&quot;Error al registrar reserva: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public DtReserva obtenerReserva(Long idReserva, String nicknameCliente) { // Cambiado a Long&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        try {&#10;            if (cliente == null) {&#10;                throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;            }&#10;            for (DtReserva r : cliente.getReservas()) {&#10;                if (r.getId().equals(idReserva)) {&#10;                    return r;&#10;                }&#10;            }&#10;            throw new IllegalArgumentException(&quot;Reserva no encontrada&quot;);&#10;        } catch (PersistenceException e) {&#10;            throw new IllegalArgumentException(&quot;Error al obtener la reserva: &quot; + e.getMessage());&#10;        }&#10;    }&#10;&#10;    // --- PAQUETES ---&#10;    @Override&#10;    public void altaPaquete(String nombre, String descripcion, int descuentoPorc, int periodoValidezDias) {&#10;        if (manejadorPaquete.obtenerPaquete(nombre) != null) {&#10;            throw new IllegalArgumentException(&quot;Ya existe un paquete con el nombre: &quot; + nombre);&#10;        }&#10;&#10;        if (nombre == null || nombre.trim().isEmpty()) {&#10;            throw new IllegalArgumentException(&quot;El nombre del paquete no puede estar vacío.&quot;);&#10;        }&#10;        if (descuentoPorc &lt; 0 || descuentoPorc &gt; 100) {&#10;            throw new IllegalArgumentException(&quot;El descuento debe estar entre 0 y 100 por ciento.&quot;);&#10;        }&#10;        if (periodoValidezDias &lt; 0) {&#10;            throw new IllegalArgumentException(&quot;El período de validez no puede ser negativo.&quot;);&#10;        }&#10;&#10;        Paquete paquete = new Paquete(nombre.trim(), descripcion, descuentoPorc, periodoValidezDias);&#10;        manejadorPaquete.agregarPaquete(paquete, entManager);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtPaquete&gt; listarPaquetes() {&#10;        return manejadorPaquete.getPaquetes();&#10;    }&#10;&#10;    @Override&#10;    public void modificarDatosDeCliente(String nickname, String nombre, String apellido, String nacionalidad, LocalDate fechaNacimiento, TipoDoc tipoDoc, String numeroDocumento) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        if (cliente != null) {&#10;            cliente.setApellido(apellido);&#10;            cliente.setNombre(nombre);&#10;            cliente.setNacionalidad(nacionalidad);&#10;            cliente.setFechaNacimiento(fechaNacimiento);&#10;            cliente.setTipoDocumento(tipoDoc);&#10;            cliente.setNumeroDocumento(numeroDocumento);&#10;            manejadorCliente.modificarDatosCliente(cliente, entManager);&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void modificarDatosAerolinea(String nickname, String descripcion, String url) {&#10;        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        if (aerolinea != null) {&#10;            aerolinea.setDescripcion(descripcion);&#10;            aerolinea.setSitioWeb(url);&#10;            manejadorAerolinea.modificarDatosAerolinea(aerolinea, entManager);&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtPaquete&gt; listarPaquetesDisp() {&#10;        return manejadorPaquete.getPaquetesDisp();&#10;    }&#10;&#10;    @Override&#10;    public double calcularCostoReserva(String nombreVuelo, TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra) {&#10;        ManejadorVuelo manejadorVuelo = ManejadorVuelo.getInstance();&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;Vuelo no encontrado: &quot; + nombreVuelo);&#10;        }&#10;&#10;        double costoBase;&#10;        if (tipoAsiento == TipoAsiento.TURISTA) {&#10;            costoBase = 100.0;&#10;        } else {&#10;            costoBase = 200.0;&#10;        }&#10;&#10;        double costoPasajes = costoBase * cantidadPasajes;&#10;        double costoEquipaje = 30.0 * unidadesEquipajeExtra;&#10;&#10;        return costoPasajes + costoEquipaje;&#10;    }&#10;&#10;    @Override&#10;    public Pasajero crearPasajero(String nombre, String apellido) {&#10;        if (nombre == null || nombre.trim().isEmpty()) {&#10;            throw new IllegalArgumentException(&quot;El nombre del pasajero no puede estar vacío.&quot;);&#10;        }&#10;        if (apellido == null || apellido.trim().isEmpty()) {&#10;            throw new IllegalArgumentException(&quot;El apellido del pasajero no puede estar vacío.&quot;);&#10;        }&#10;        return new Pasajero(nombre.trim(), apellido.trim());&#10;    }&#10;&#10;    @Override&#10;    public void compraPaquete(String nomPaquete, String nomCliente, int validezDias, LocalDate fechaC, double costo) {&#10;        Paquete paquete = manejadorPaquete.obtenerPaquete(nomPaquete);&#10;        if (paquete == null) {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);&#10;        }&#10;&#10;        DtCliente dtCliente = manejadorCliente.obtenerCliente(nomCliente);&#10;        if (dtCliente == null) {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;&#10;        for (CompraPaqLogica cp : paquete.getCompras()) {&#10;            if (cp.getCliente().getNickname().equals(dtCliente.getNickname())) {&#10;                throw new IllegalArgumentException(&quot;Error, el cliente &quot; + dtCliente.getNombre() + &quot; ya compró el paquete &quot; + paquete.getNombre() + &quot;. Elija otro o cancele.&quot;);&#10;            }&#10;        }&#10;&#10;        try {&#10;            manejadorPaquete.compraPaquete(paquete, dtCliente, validezDias, fechaC, costo, entManager);&#10;            LOGGER.info(() -&gt; &quot;Paquete comprado correctamente para cliente: &quot; + dtCliente.getNickname() + &quot;, paquete: &quot; + paquete.getNombre());&#10;        } catch (IllegalStateException e) {&#10;            LOGGER.log(Level.SEVERE, () -&gt; &quot;Error comprando paquete: &quot; + e.getMessage());&#10;            throw e;&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void altaCategoria(String nomCat) {&#10;        Categoria cat = manejadorCategoria.buscarCategorias(nomCat);&#10;        if (cat != null) {&#10;            throw new IllegalArgumentException(&quot;Error, la categoria ya existe.&quot;);&#10;        }&#10;&#10;        try {&#10;            Categoria categoria = new Categoria(nomCat);&#10;            manejadorCategoria.agregarCategoria(categoria, entManager);&#10;            LOGGER.info(() -&gt; &quot;Categoría creada correctamente: &quot; + nomCat);&#10;        } catch (IllegalStateException e) {&#10;            LOGGER.log(Level.SEVERE, () -&gt; &quot;Error creando categoría: &quot; + e.getMessage());&#10;            throw e;&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;Object&gt; obtenerDatosAdicionalesUsuario(String nickname) {&#10;        List&lt;Object&gt; adicionales = new ArrayList&lt;&gt;();&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        if (cliente != null) {&#10;            adicionales.addAll(cliente.getReservas());&#10;            adicionales.addAll(cliente.getPaquetesComprados());&#10;            return adicionales;&#10;        }&#10;        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        if (aerolinea != null) {&#10;            adicionales.addAll(aerolinea.getRutasVuelo());&#10;            return adicionales;&#10;        }&#10;        return adicionales;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtCiudad&gt; listarCiudades() {&#10;        List&lt;DtCiudad&gt; dtCiudades = new ArrayList&lt;&gt;();&#10;        for (Ciudad ciudad : manejadorCiudad.getCiudades()) {&#10;            dtCiudades.add(new DtCiudad(ciudad.getNombre(), ciudad.getPais()));&#10;        }&#10;        return dtCiudades;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtCategoria&gt; listarCategorias() {&#10;        List&lt;DtCategoria&gt; lista = new ArrayList&lt;&gt;();&#10;        for (Categoria c : manejadorCategoria.getCategorias().values()) {&#10;            lista.add(new DtCategoria(c.getNombre()));&#10;        }&#10;        return lista;&#10;    }&#10;&#10;    @Override&#10;    public void altaRutaPaquete(String nombrePaquete, String nomRuta, int cantidadAsientos, TipoAsiento tipoAsiento) {&#10;        Paquete paquete = manejadorPaquete.obtenerPaquete(nombrePaquete);&#10;        if (paquete == null) {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);&#10;        }&#10;&#10;        if (paquete.estaComprado()) {&#10;            throw new IllegalArgumentException(&quot;No se pueden agregar rutas a un paquete que ya ha sido comprado.&quot;);&#10;        }&#10;&#10;        // En lugar de usar la instancia en memoria, leer directamente desde la BD&#10;        RutaVuelo rutaGestionada = null;&#10;        final int MAX_INTENTOS = 20;&#10;        final long RETRY_DELAY_MS = 100;&#10;        int intento = 0;&#10;        while (intento &lt; MAX_INTENTOS) {&#10;            EntityManager emLocal = null;&#10;            try {&#10;                emLocal = emf.createEntityManager();&#10;                jakarta.persistence.TypedQuery&lt;RutaVuelo&gt; q = emLocal.createQuery(&quot;SELECT r FROM RutaVuelo r WHERE r.nombre = :n&quot;, RutaVuelo.class);&#10;                q.setParameter(&quot;n&quot;, nomRuta);&#10;                java.util.List&lt;RutaVuelo&gt; res = q.getResultList();&#10;                if (!res.isEmpty()) {&#10;                    rutaGestionada = res.get(0);&#10;                    // Forzar inicialización de la colección de vuelos mientras el EntityManager está abierto&#10;                    try {&#10;                        if (rutaGestionada.getVuelos() != null) {&#10;                            rutaGestionada.getVuelos().size();&#10;                        }&#10;                    } catch (Exception ignore) {&#10;                        // ignorar problemas de inicialización y reintentar en el loop&#10;                    }&#10;                    if (rutaGestionada.getEstado() == CONFIRMADA) {&#10;                        break; // confirmada en BD, ya podemos continuar&#10;                    }&#10;                }&#10;            } catch (Exception e) {&#10;                // ignoro y reintento&#10;            } finally {&#10;                if (emLocal != null &amp;&amp; emLocal.isOpen()) emLocal.close();&#10;            }&#10;&#10;            intento++;&#10;            try {&#10;                Thread.sleep(RETRY_DELAY_MS);&#10;            } catch (InterruptedException ie) {&#10;                Thread.currentThread().interrupt();&#10;                break;&#10;            }&#10;        }&#10;&#10;        if (rutaGestionada == null) {&#10;            throw new IllegalArgumentException(&quot;No se encontró la ruta con ese nombre en la BD: &quot; + nomRuta);&#10;        }&#10;&#10;        if (rutaGestionada.getEstado() != CONFIRMADA) {&#10;            throw new IllegalArgumentException(&quot;No se puede agregar una ruta que no esté CONFIRMADA al paquete. Ruta actual: &quot; + rutaGestionada.getEstado());&#10;        }&#10;&#10;        // Pasar la instancia gestionada (detached) al manejador del paquete; el manejador reatachará/mergeará&#10;        manejadorPaquete.agregarRutaAPaquete(paquete, rutaGestionada, cantidadAsientos, tipoAsiento, entManager);&#10;&#10;        DtPaquete dtPaquete = obtenerDtPaquete(nombrePaquete);&#10;        if (dtPaquete != null) {&#10;            DtRutaVuelo dtRuta = rutaGestionada.getDtRutaVuelo();&#10;            DtItemPaquete dtItem = new DtItemPaquete(dtRuta, cantidadAsientos, tipoAsiento.toString());&#10;            dtPaquete.getItems().add(dtItem);&#10;        }&#10;        LOGGER.info(() -&gt; &quot;Ruta agregada al paquete correctamente: &quot; + nombrePaquete + &quot;, ruta: &quot; + nomRuta);&#10;    }&#10;&#10;    @Override&#10;    public Paquete obtenerPaquete(String nombrePaquete) {&#10;        Paquete paquete = manejadorPaquete.obtenerPaquete(nombrePaquete);&#10;        if (paquete == null) {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);&#10;        }&#10;        return paquete;&#10;    }&#10;&#10;    @Override&#10;    public DtPaquete obtenerDtPaquete(String nombrePaquete) {&#10;        DtPaquete paquete = manejadorPaquete.obtenerDtPaquete(nombrePaquete);&#10;        if (paquete == null) {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);&#10;        }&#10;        return paquete;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtAerolinea&gt; getAerolineas() {&#10;        return manejadorAerolinea.getDtAerolineas();&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtPaquete&gt; getPaquetesDisp() {&#10;        return manejadorPaquete.getPaquetes();&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtCliente&gt; getClientes() {&#10;        return manejadorCliente.getClientes();&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtReserva&gt; getReservasCliente(String nickname) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        if (cliente != null) {&#10;            return cliente.getReservas();&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtItemPaquete&gt; getDtItemRutasPaquete(String nombrePaquete) {&#10;        List&lt;DtItemPaquete&gt; items = manejadorPaquete.obtenerDtItemsPaquete(nombrePaquete);&#10;        if (items != null &amp;&amp; !items.isEmpty()) {&#10;            return items;&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado o sin rutas asociadas&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; listarRutasConfirmadas(int limite) {&#10;        List&lt;DtRutaVuelo&gt; rutasConfirmadas = new ArrayList&lt;&gt;();&#10;        List&lt;DtAerolinea&gt; aerolineas = listarAerolineas();&#10;&#10;        for (DtAerolinea aerolinea : aerolineas) {&#10;            try {&#10;                List&lt;DtRutaVuelo&gt; rutasAerolinea = listarRutasPorAerolinea(aerolinea.getNickname());&#10;                for (DtRutaVuelo ruta : rutasAerolinea) {&#10;                    if (&quot;CONFIRMADA&quot;.equals(ruta.getEstado())) {&#10;                        rutasConfirmadas.add(ruta);&#10;                        if (rutasConfirmadas.size() &gt;= limite) {&#10;                            return rutasConfirmadas;&#10;                        }&#10;                    }&#10;                }&#10;            } catch (PersistenceException  e) {&#10;                continue;&#10;            }&#10;        }&#10;        return rutasConfirmadas;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; obtenerTopRutasMasVisitadas(int limite) {&#10;        try {&#10;            List&lt;RutaVuelo&gt; rutasMasVisitadas = manejadorRutaVuelo.getTopRutasConfirmadasMasVisitadas(limite);&#10;            List&lt;DtRutaVuelo&gt; dtRutas = new ArrayList&lt;&gt;();&#10;&#10;            for (RutaVuelo ruta : rutasMasVisitadas) {&#10;                dtRutas.add(ruta.getDtRutaVuelo());&#10;            }&#10;&#10;            System.out.println(&quot;[SISTEMA] Top &quot; + dtRutas.size() + &quot; rutas más visitadas obtenidas&quot;);&#10;            return dtRutas;&#10;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;[SISTEMA] Error obteniendo DTOs de rutas visitadas: &quot; + e.getMessage());&#10;            return new ArrayList&lt;&gt;();&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void finalizarRutaVuelo(String nombreRuta) {&#10;        if (puedeFinalizarRuta(nombreRuta) != 4) {&#10;            throw new IllegalArgumentException(&quot;La ruta no puede ser finalizada: &quot; + nombreRuta);&#10;        }&#10;&#10;        manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, EstadoRuta.FINALIZADA, entManager);&#10;        LOGGER.info(&quot;Ruta finalizada: &quot; + nombreRuta);&#10;    }&#10;&#10;    @Override&#10;    public int puedeFinalizarRuta(String nombreRuta) {&#10;        System.out.println(&quot;[DEBUG] Verificando si puede finalizar ruta: &quot; + nombreRuta);&#10;&#10;        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);&#10;        if (ruta == null) {&#10;            System.out.println(&quot;[DEBUG] Ruta no encontrada: &quot; + nombreRuta);&#10;            return 0;&#10;        }&#10;&#10;        System.out.println(&quot;[DEBUG] Estado de la ruta: &quot; + ruta.getEstado());&#10;&#10;        // 1. Verificar que esté en estado CONFIRMADA&#10;        if (ruta.getEstado() != EstadoRuta.CONFIRMADA) {&#10;            System.out.println(&quot;[DEBUG] No puede finalizar - Estado incorrecto: &quot; + ruta.getEstado());&#10;            return 1;&#10;        }&#10;&#10;        // 2. Verificar que no tenga vuelos pendientes (fecha futura)&#10;        if (tieneVuelosPendientes(ruta)) {&#10;            System.out.println(&quot;[DEBUG] No puede finalizar - Tiene vuelos pendientes&quot;);&#10;            return 2;&#10;        }&#10;&#10;        // 3. Verificar que no esté en ningún paquete activo&#10;        if (estaEnPaqueteActivo(ruta)) {&#10;            System.out.println(&quot;[DEBUG] No puede finalizar - Está en paquete activo&quot;);&#10;            return 3;&#10;        }&#10;&#10;        System.out.println(&quot;[DEBUG] Ruta puede finalizar - código 4&quot;);&#10;        return 4;&#10;    }&#10;&#10;    private boolean tieneVuelosPendientes(RutaVuelo ruta) {&#10;        try {&#10;            LocalDate hoy = LocalDate.now();&#10;            for (Vuelo vuelo : ruta.getVuelos()) {&#10;                if (vuelo.getFecha().isAfter(hoy)) {&#10;                    return true;&#10;                }&#10;            }&#10;            return false;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;Error en tieneVuelosPendientes: &quot; + e.getMessage());&#10;            return true; // Por seguridad, asumir que tiene vuelos pendientes si hay error&#10;        }&#10;    }&#10;&#10;    private boolean estaEnPaqueteActivo(RutaVuelo ruta) {&#10;        try {&#10;            List&lt;DtPaquete&gt; paquetes = listarPaquetes();&#10;            for (DtPaquete paquete : paquetes) {&#10;                if (paqueteContieneRuta(paquete.getNombre(), ruta.getNombre())) {&#10;                    return true;&#10;                }&#10;            }&#10;            return false;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;Error en estaEnPaqueteActivo: &quot; + e.getMessage());&#10;            return true; // Por seguridad, asumir que está en paquete activo si hay error&#10;        }&#10;    }&#10;&#10;    // Método auxiliar - implementado usando ManejadorPaquete&#10;    private boolean paqueteContieneRuta(String nombrePaquete, String nombreRuta) {&#10;        Paquete paquete = manejadorPaquete.obtenerPaquete(nombrePaquete);&#10;        if (paquete == null) {&#10;            return false;&#10;        }&#10;&#10;        // Verificar si el paquete contiene la ruta en sus items&#10;        for (ItemPaquete item : paquete.getItemPaquetes()) {&#10;            if (item.getRutaVuelo().getNombre().equals(nombreRuta)) {&#10;                return true;&#10;            }&#10;        }&#10;        return false;&#10;    }&#10;&#10;    // =================== MÉTODOS DE SEGUIMIENTO (FOLLOW) ===================&#10;&#10;    @Override&#10;    public void incrementarVisitasRuta(String nombreRuta) {&#10;        try {&#10;            manejadorRutaVuelo.incrementarVisitasRuta(nombreRuta, entManager);&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;[SISTEMA] Error incrementando visitas: &quot; + e.getMessage());&#10;            throw new RuntimeException(&quot;Error al incrementar visitas para ruta: &quot; + nombreRuta, e);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public int obtenerTotalVisitasRuta(String nombreRuta) {&#10;        try {&#10;            RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);&#10;            return ruta != null ? ruta.getContadorVisitas() : 0;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;[SISTEMA] Error obteniendo total de visitas: &quot; + e.getMessage());&#10;            return 0;&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtReserva&gt; obtenerReservasConCheckin(String nicknameCliente) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        if (cliente == null) {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;&#10;        List&lt;DtReserva&gt; reservasConCheckin = new ArrayList&lt;&gt;();&#10;        for (DtReserva reserva : cliente.getReservas()) {&#10;            // Aquí necesitarías verificar el estado de la reserva&#10;            // Esto requiere cargar la reserva completa desde la base de datos&#10;            Reserva reservaCompleta = obtenerReservaCompleta(reserva.getId());&#10;            if (reservaCompleta != null &amp;&amp; reservaCompleta.getEstado() == EstadoReserva.CHECKIN_REALIZADO) {&#10;                reservasConCheckin.add(new DtReserva(reservaCompleta));&#10;            }&#10;        }&#10;        return reservasConCheckin;&#10;    }&#10;&#10;    @Override&#10;    public DtReserva consultarCheckinReserva(Long idReserva, String nicknameCliente) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        if (cliente == null) {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;&#10;        // Verificar que la reserva pertenece al cliente&#10;        boolean reservaPertenece = false;&#10;        for (DtReserva r : cliente.getReservas()) {&#10;            if (r.getId().equals(idReserva)) {&#10;                reservaPertenece = true;&#10;                break;&#10;            }&#10;        }&#10;&#10;        if (!reservaPertenece) {&#10;            throw new IllegalArgumentException(&quot;La reserva no pertenece al cliente&quot;);&#10;        }&#10;&#10;        Reserva reservaCompleta = obtenerReservaCompleta(idReserva);&#10;        if (reservaCompleta == null) {&#10;            throw new IllegalArgumentException(&quot;Reserva no encontrada&quot;);&#10;        }&#10;&#10;        if (reservaCompleta.getEstado() != EstadoReserva.CHECKIN_REALIZADO) {&#10;            throw new IllegalStateException(&quot;Check-in no realizado para esta reserva&quot;);&#10;        }&#10;&#10;        return new DtReserva(reservaCompleta);&#10;    }&#10;&#10;    @Override&#10;    public void realizarCheckinReserva(Long idReserva, List&lt;String&gt; asientosAsignados, LocalTime horaEmbarque) {&#10;        EntityTransaction tx = entManager.getTransaction();&#10;        try {&#10;            tx.begin();&#10;&#10;            Reserva reserva = entManager.find(Reserva.class, idReserva);&#10;            if (reserva == null) {&#10;                throw new IllegalArgumentException(&quot;Reserva no encontrada&quot;);&#10;            }&#10;&#10;            reserva.realizarCheckin(asientosAsignados, horaEmbarque);&#10;            entManager.merge(reserva);&#10;&#10;            tx.commit();&#10;            LOGGER.info(&quot;Check-in realizado para reserva: &quot; + idReserva);&#10;&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            throw new IllegalStateException(&quot;Error al realizar check-in: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    // Método auxiliar para obtener reserva completa&#10;    private Reserva obtenerReservaCompleta(Long idReserva) {&#10;        return entManager.find(Reserva.class, idReserva);&#10;    }&#10;&#10;    @Override&#10;    public void followUsuario(String followerNickname, String targetNickname) {&#10;        if (followerNickname == null || targetNickname == null)&#10;            throw new IllegalArgumentException(&quot;Nick null&quot;);&#10;&#10;        if (followerNickname.equals(targetNickname))&#10;            throw new IllegalArgumentException(&quot;No puede seguirse a sí mismo&quot;);&#10;&#10;        // Buscar en manejadores en memoria primero (compatibilidad con tu esquema)&#10;        Usuario follower = manejadorCliente.obtenerClienteReal(followerNickname);&#10;        if (follower == null) follower = manejadorAerolinea.obtenerAerolinea(followerNickname);&#10;&#10;        Usuario target = manejadorCliente.obtenerClienteReal(targetNickname);&#10;        if (target == null) target = manejadorAerolinea.obtenerAerolinea(targetNickname);&#10;&#10;        if (follower == null || target == null)&#10;            throw new IllegalArgumentException(&quot;Usuario no encontrado&quot;);&#10;&#10;        // Delegar la persistencia al manejador, pasándole el EntityManager del Sistema&#10;        manejadorFollow.followUsuario(followerNickname, targetNickname, entManager);&#10;&#10;        // Actualizar sets locales&#10;        follower.agregarSeguido(target);&#10;        target.agregarSeguidor(follower);&#10;    }&#10;&#10;    @Override&#10;    public void unfollowUsuario(String followerNickname, String targetNickname) {&#10;        if (followerNickname == null || targetNickname == null)&#10;            throw new IllegalArgumentException(&quot;Nick null&quot;);&#10;&#10;        if (followerNickname.equals(targetNickname))&#10;            throw new IllegalArgumentException(&quot;No puede dejar de seguirse a sí mismo&quot;);&#10;&#10;        // Buscar en manejadores en memoria primero&#10;        Usuario follower = manejadorCliente.obtenerClienteReal(followerNickname);&#10;        if (follower == null) follower = manejadorAerolinea.obtenerAerolinea(followerNickname);&#10;&#10;        Usuario target = manejadorCliente.obtenerClienteReal(targetNickname);&#10;        if (target == null) target = manejadorAerolinea.obtenerAerolinea(targetNickname);&#10;&#10;        if (follower == null || target == null)&#10;            throw new IllegalArgumentException(&quot;Usuario no encontrado&quot;);&#10;&#10;        // Delegar la eliminación al manejador, pasando el EntityManager&#10;        manejadorFollow.unfollowUsuario(followerNickname, targetNickname, entManager);&#10;&#10;        follower.quitarSeguido(target);&#10;        target.quitarSeguidor(follower);&#10;    }&#10;&#10;    // Devuelve la cantidad de seguidores de un usuario&#10;    @Override&#10;    public int obtenerCantidadSeguidores(String nickname) {&#10;        try {&#10;            // Consultar directamente desde memoria del ManejadorFollow (ya sincronizado con BD)&#10;            return manejadorFollow.countSeguidores(nickname);&#10;        } catch (Exception e) {&#10;            LOGGER.log(Level.SEVERE, &quot;Error obteniendo cantidad de seguidores&quot;, e);&#10;            return 0;&#10;        }&#10;    }&#10;&#10;    // Devuelve la cantidad de seguidos de un usuario&#10;    @Override&#10;    public int obtenerCantidadSeguidos(String nickname) {&#10;        try {&#10;            // Consultar directamente desde memoria del ManejadorFollow (ya sincronizado con BD)&#10;            return manejadorFollow.countSeguidos(nickname);&#10;        } catch (Exception e) {&#10;            LOGGER.log(Level.SEVERE, &quot;Error obteniendo cantidad de seguidos&quot;, e);&#10;            return 0;&#10;        }&#10;    }&#10;&#10;    private Usuario obtenerUsuarioPorNickname(String nickname) {&#10;        // Primero buscar como cliente&#10;        Usuario usuario = manejadorCliente.obtenerClienteReal(nickname);&#10;        if (usuario == null) {&#10;            // Si no es cliente, buscar como aerolínea&#10;            usuario = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        }&#10;        return usuario;&#10;    }&#10;&#10;    @Override&#10;    public boolean verificarSeguimiento(String seguidorId, String seguidoId) {&#10;        try {&#10;            // Verificar que no sean el mismo usuario&#10;            if (seguidorId.equals(seguidoId)) {&#10;                return false;&#10;            }&#10;&#10;            // Consultar directamente desde memoria del ManejadorFollow (ya sincronizado con BD)&#10;            return manejadorFollow.estaSiguiendo(seguidorId, seguidoId);&#10;&#10;        } catch (Exception e) {&#10;            LOGGER.log(Level.SEVERE, &quot;Error verificando seguimiento&quot;, e);&#10;            return false;&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Obtiene la hora de la ruta a la que pertenece una reserva específica&#10;     * @param idReserva ID de la reserva&#10;     * @return Hora de la ruta en formato String, o null si no se encuentra&#10;     */&#10;    @Override&#10;    public String obtenerHoraRutaPorReserva(Long idReserva) {&#10;        try {&#10;            // Buscar la reserva por ID&#10;            Reserva reserva = entManager.find(Reserva.class, idReserva);&#10;            if (reserva == null) {&#10;                throw new IllegalArgumentException(&quot;Reserva no encontrada con ID: &quot; + idReserva);&#10;            }&#10;&#10;            // Navegar a través de las relaciones: Reserva -&gt; Vuelo -&gt; RutaVuelo -&gt; Hora&#10;            return reserva.getVuelo().getRutaVuelo().getHora();&#10;&#10;        } catch (Exception e) {&#10;            LOGGER.log(Level.SEVERE, &quot;Error obteniendo hora de la ruta para reserva: &quot; + idReserva, e);&#10;            throw new IllegalArgumentException(&quot;Error al obtener la hora de la ruta: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Obtiene los asientos disponibles (no ocupados) en el vuelo de una reserva específica&#10;     * @param idReserva ID de la reserva&#10;     * @return Lista de strings con los IDs de los asientos disponibles en el vuelo&#10;     */&#10;    @Override&#10;    public List&lt;String&gt; obtenerAsientosDisponiblesVuelo(Long idReserva) {&#10;        EntityTransaction tx = null;&#10;        try {&#10;            tx = entManager.getTransaction();&#10;            tx.begin();&#10;&#10;            // Buscar la reserva por ID&#10;            Reserva reserva = entManager.find(Reserva.class, idReserva);&#10;            if (reserva == null) {&#10;                throw new IllegalArgumentException(&quot;Reserva no encontrada con ID: &quot; + idReserva);&#10;            }&#10;&#10;            // Obtener el vuelo de la reserva&#10;            Vuelo vuelo = reserva.getVuelo();&#10;            if (vuelo == null) {&#10;                throw new IllegalArgumentException(&quot;No se encontró el vuelo asociado a la reserva&quot;);&#10;            }&#10;&#10;            // Obtener todos los asientos del vuelo&#10;            List&lt;String&gt; todosLosAsientos = generarAsientosDisponibles(vuelo);&#10;&#10;            // Obtener asientos ya ocupados en el vuelo&#10;            List&lt;String&gt; asientosOcupados = obtenerAsientosOcupadosVuelo(vuelo);&#10;&#10;            // Filtrar asientos disponibles (todos - ocupados)&#10;            List&lt;String&gt; asientosDisponibles = new ArrayList&lt;&gt;(todosLosAsientos);&#10;            asientosDisponibles.removeAll(asientosOcupados);&#10;&#10;            tx.commit();&#10;            return asientosDisponibles;&#10;&#10;        } catch (Exception e) {&#10;            if (tx != null &amp;&amp; tx.isActive()) {&#10;                tx.rollback();&#10;            }&#10;            LOGGER.log(Level.SEVERE, &quot;Error obteniendo asientos disponibles para reserva: &quot; + idReserva, e);&#10;            throw new IllegalStateException(&quot;Error al obtener asientos disponibles: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Genera la lista de todos los asientos posibles del vuelo&#10;     */&#10;    private List&lt;String&gt; generarAsientosDisponibles(Vuelo vuelo) {&#10;        List&lt;String&gt; asientos = new ArrayList&lt;&gt;();&#10;&#10;        // Generar asientos turista (ejemplo: A1, A2, ..., B1, B2, ...)&#10;        int filasTurista = vuelo.getAsientosTurista() / 6; // Asumiendo 6 asientos por fila&#10;        for (int fila = 1; fila &lt;= filasTurista; fila++) {&#10;            for (char columna = 'A'; columna &lt;= 'F'; columna++) {&#10;                asientos.add(columna + String.valueOf(fila));&#10;            }&#10;        }&#10;&#10;        // Generar asientos ejecutivos (ejemplo: J1, J2, ..., K1, K2, ...)&#10;        int filasEjecutivo = vuelo.getAsientosEjecutivo() / 4; // Asumiendo 4 asientos por fila en ejecutivo&#10;        for (int fila = 1; fila &lt;= filasEjecutivo; fila++) {&#10;            for (char columna = 'J'; columna &lt;= 'M'; columna++) {&#10;                asientos.add(columna + String.valueOf(fila));&#10;            }&#10;        }&#10;&#10;        return asientos;&#10;    }&#10;&#10;    /**&#10;     * Obtiene todos los asientos ya ocupados en el vuelo&#10;     */&#10;    private List&lt;String&gt; obtenerAsientosOcupadosVuelo(Vuelo vuelo) {&#10;        List&lt;String&gt; asientosOcupados = new ArrayList&lt;&gt;();&#10;&#10;        // Recorrer todas las reservas del vuelo que tengan check-in&#10;        for (DtReserva dtReserva : vuelo.getDtReservas()) {&#10;            // Obtener la reserva completa&#10;            Reserva reservaCompleta = entManager.find(Reserva.class, dtReserva.getId());&#10;            if (reservaCompleta != null &amp;&amp; reservaCompleta.getEstado() == EstadoReserva.CHECKIN_REALIZADO) {&#10;                List&lt;String&gt; asientosReserva = reservaCompleta.getAsientosAsignados();&#10;                if (asientosReserva != null) {&#10;                    asientosOcupados.addAll(asientosReserva);&#10;                }&#10;            }&#10;        }&#10;&#10;        return asientosOcupados;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; listarRutasFinalizables(String nombreAerolinea) {&#10;        List&lt;DtRutaVuelo&gt; rutasFinalizables = new ArrayList&lt;&gt;();&#10;        List&lt;DtRutaVuelo&gt; rutasAerolinea = listarRutasPorAerolinea(nombreAerolinea);&#10;&#10;        for (DtRutaVuelo ruta : rutasAerolinea) {&#10;            if (puedeFinalizarRuta(ruta.getNombre()) == 4) {&#10;                rutasFinalizables.add(ruta);&#10;            }&#10;        }&#10;        return rutasFinalizables;&#10;    }&#10;&#10;    @Override&#10;    public boolean tieneCheckinRealizado(Long reservaId) {&#10;        try {&#10;            Reserva reserva = obtenerReservaCompleta(reservaId);&#10;            if (reserva != null) {&#10;                // Verificar por el flag explícito de check-in (boolean primitivo)&#10;                if (reserva.getCheckinRealizado()) {&#10;                    return true;&#10;                }&#10;&#10;                // Verificar por fecha de check-in&#10;                if (reserva.getFechaCheckin() != null) {&#10;                    return true;&#10;                }&#10;&#10;                // Verificar si el estado cambió de PENDIENTE&#10;                if (reserva.getEstado() != null &amp;&amp;&#10;                        !&quot;PENDIENTE&quot;.equalsIgnoreCase(reserva.getEstado().toString())) {&#10;                    return true;&#10;                }&#10;            }&#10;            return false;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;Error en tieneCheckinRealizado: &quot; + e.getMessage());&#10;            return false;&#10;        }&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package logica;&#10;&#10;import jakarta.persistence.EntityManager;&#10;import jakarta.persistence.EntityManagerFactory;&#10;import jakarta.persistence.EntityTransaction;&#10;import jakarta.persistence.Persistence;&#10;import jakarta.persistence.PersistenceException;&#10;&#10;import DataTypes.DtCliente;&#10;import DataTypes.DtAerolinea;&#10;import DataTypes.DtCiudad;&#10;import DataTypes.DtCategoria;&#10;import DataTypes.DtVuelo;&#10;import DataTypes.DtReserva;&#10;import DataTypes.DtPaquete;&#10;import DataTypes.DtRutaVuelo;&#10;import DataTypes.DtItemPaquete;&#10;&#10;&#10;import java.time.LocalDate;&#10;import java.time.LocalTime;&#10;import java.util.List;&#10;import java.util.ArrayList;&#10;&#10;import java.util.logging.Level;&#10;import java.util.logging.Logger;&#10;&#10;import static logica.EstadoRuta.*;&#10;&#10;/**&#10; * Implementación de la interfaz ISistema que actúa como fachada para la&#10; * lógica de negocio. Maneja inicialización, operaciones CRUD y coordinación&#10; * entre los manejadores (clientes, aerolíneas, rutas, vuelos, paquetes, etc.).&#10; */&#10;public class Sistema implements ISistema {&#10;&#10;    private static final Logger LOGGER = Logger.getLogger(Sistema.class.getName());&#10;&#10;    private EntityManagerFactory emf;&#10;    private EntityManager entManager;&#10;&#10;    private ManejadorCliente manejadorCliente;&#10;    private ManejadorAerolinea manejadorAerolinea;&#10;    private ManejadorCiudad manejadorCiudad;&#10;    private ManejadorRutaVuelo manejadorRutaVuelo;&#10;    private ManejadorVuelo manejadorVuelo;&#10;    private ManejadorPaquete manejadorPaquete;&#10;    private ManejadorCategoria manejadorCategoria;&#10;    private ManejadorFollow manejadorFollow;&#10;&#10;    public Sistema() {&#10;        this.emf = Persistence.createEntityManagerFactory(&quot;LAB_PA&quot;);&#10;        this.entManager = emf.createEntityManager();&#10;        this.manejadorCliente = ManejadorCliente.getInstance();&#10;        this.manejadorPaquete = ManejadorPaquete.getInstance();&#10;        this.manejadorAerolinea = ManejadorAerolinea.getInstance();&#10;        this.manejadorRutaVuelo = ManejadorRutaVuelo.getInstance();&#10;        this.manejadorVuelo = ManejadorVuelo.getInstance();&#10;        this.manejadorCiudad = ManejadorCiudad.getInstance();&#10;        this.manejadorCategoria = ManejadorCategoria.getInstance();&#10;        this.manejadorFollow = ManejadorFollow.getInstance();&#10;        // Precargar datos si la base está vacía&#10;&#10;    }&#10;&#10;    /** Carga todos los datos desde la base de datos a los manejadores en memoria. */&#10;    @Override&#10;    public void cargarDesdeBd() {&#10;        // Usar un EntityManager local para la recarga, evitando cerrar el EntityManager&#10;        // compartido del Sistema que puede estar en uso por otras operaciones.&#10;        EntityManager emLocal = null;&#10;        try {&#10;            emLocal = emf.createEntityManager();&#10;&#10;            manejadorCliente.cargarClientesDesdeBD(emLocal);&#10;            manejadorAerolinea.cargarAerolineasDesdeBD(emLocal);&#10;            manejadorCiudad.cargarCiudadesDesdeBD(emLocal);&#10;            manejadorRutaVuelo.cargarRutasDesdeBD(emLocal);&#10;            manejadorVuelo.cargarVuelosDesdeBD(emLocal);&#10;            manejadorPaquete.cargarPaquetesDesdeBD(emLocal);&#10;            manejadorCategoria.cargarCategoriasDesdeBD(emLocal);&#10;            manejadorFollow.cargarFollowsDesdeBD(emLocal);&#10;        } finally {&#10;            if (emLocal != null &amp;&amp; emLocal.isOpen()) emLocal.close();&#10;        }&#10;    }&#10;&#10;    // =================== USUARIOS CON CONTRASEÑA ===================&#10;&#10;    /**&#10;     * Alta de cliente con contraseña. Valida unicidad y persiste el cliente.&#10;     */&#10;    @Override&#10;    public void altaCliente(String nickname, String nombre, String apellido, String correo,&#10;                            LocalDate fechaNac, String nacionalidad, TipoDoc tipoDoc,&#10;                            String numDoc, String password, String imagenUrl) {&#10;        if (manejadorAerolinea.obtenerAerolinea(nickname) == null&#10;                &amp;&amp; manejadorCliente.obtenerCliente(nickname) == null) {&#10;            Cliente cliente = new Cliente(nickname, nombre, apellido, correo, fechaNac, nacionalidad, tipoDoc, numDoc, password, imagenUrl);&#10;            manejadorCliente.agregarCliente(cliente, entManager);&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Ya existe un usuario con ese nickname&quot;);&#10;        }&#10;    }&#10;&#10;    /** Método de compatibilidad: indica que se debe usar la versión con contraseña. */&#10;    public void altaCliente(String nickname, String nombre, String apellido, String correo,&#10;                            LocalDate fechaNac, String nacionalidad, TipoDoc tipoDoc, String numDoc) {&#10;        throw new UnsupportedOperationException(&quot;Use el método con contraseña: altaCliente(..., password)&quot;);&#10;    }&#10;&#10;    /** Alta de aerolínea con contraseña y persistencia. */&#10;    @Override&#10;    public void altaAerolinea(String nickname, String nombre, String descripcion,&#10;                              String email, String sitioWeb, String password, String imagenUrl) {&#10;        if (manejadorAerolinea.obtenerAerolinea(nickname) == null&#10;                &amp;&amp; manejadorCliente.obtenerCliente(nickname) == null) {&#10;            Aerolinea aerolinea = new Aerolinea(nickname, nombre, email, password, descripcion, sitioWeb, imagenUrl);&#10;            manejadorAerolinea.agregarAerolinea(aerolinea, entManager);&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Ya existe un usuario con ese nickname&quot;);&#10;        }&#10;    }&#10;&#10;    /** Método de compatibilidad para alta de aerolínea sin contraseña (no soportado). */&#10;    public void altaAerolinea(String nickname, String nombre, String descripcion,&#10;                              String email, String sitioWeb) {&#10;        throw new UnsupportedOperationException(&quot;Use el método con contraseña: altaAerolinea(..., password)&quot;);&#10;    }&#10;&#10;    /**&#10;     * Actualiza la contraseña de un usuario (cliente o aerolínea) identificado por email.&#10;     */&#10;    @Override&#10;    public void actualizarPassword(String email, String nuevaPassword) {&#10;        try {&#10;            manejadorCliente.actualizarPassword(email, nuevaPassword, entManager);&#10;            LOGGER.info(() -&gt; &quot;Contraseña actualizada para cliente: &quot; + email);&#10;            return;&#10;        } catch (IllegalArgumentException e) {&#10;            // Si no es cliente, continuar&#10;            LOGGER.log(Level.FINE, () -&gt; &quot;El usuario con email &quot; + email + &quot; no es un cliente. Intentando con aerolínea...&quot;);&#10;        }&#10;&#10;        try {&#10;            manejadorAerolinea.actualizarPassword(email, nuevaPassword, entManager);&#10;            LOGGER.info(() -&gt; &quot;Contraseña actualizada para aerolínea: &quot; + email);&#10;            return;&#10;        } catch (IllegalArgumentException e) {&#10;            // Si no es aerolínea, lanzar error&#10;            LOGGER.log(Level.FINE, () -&gt; &quot;El usuario con email &quot; + email + &quot; no es una aerolínea.&quot;);&#10;        }&#10;        throw new IllegalArgumentException(&quot;Usuario no encontrado: &quot; + email);&#10;    }&#10;&#10;    /** Modifica los datos completos de un cliente y persiste los cambios. */&#10;    @Override&#10;    public void modificarDatosClienteCompleto(String nickname, String nombre, String apellido,&#10;                                              String nacionalidad, LocalDate fechaNacimiento, TipoDoc tipoDocumento,&#10;                                              String numeroDocumento, String password, String imagenUrl) {&#10;        manejadorCliente.modificarDatosClienteCompleto(nickname, nombre, apellido, nacionalidad, fechaNacimiento,&#10;                tipoDocumento, numeroDocumento, password, imagenUrl, entManager);&#10;    }&#10;&#10;    /** Modifica los datos completos de una aerolínea y persiste los cambios. */&#10;    @Override&#10;    public void modificarDatosAerolineaCompleto(String nickname, String nombre, String descripcion,&#10;                                                String sitioWeb, String password, String imagenUrl) {&#10;        manejadorAerolinea.modificarDatosAerolineaCompleto(nickname, nombre, descripcion, sitioWeb, password, imagenUrl, entManager);&#10;    }&#10;&#10;    // =================== LOGIN ===================&#10;&#10;    /** Verifica credenciales buscando primero en clientes y luego en aerolíneas. */&#10;    @Override&#10;    public boolean verificarLogin(String email, String password) {&#10;        // Primero buscar como cliente&#10;        if (manejadorCliente.verificarLogin(email, password)) {&#10;            return true;&#10;        }&#10;        // Si no es cliente, buscar como aerolínea&#10;        return manejadorAerolinea.verificarLogin(email, password);&#10;    }&#10;&#10;    /** Devuelve el tipo de usuario ('CLIENTE' o 'AEROLINEA') según el email. */&#10;    @Override&#10;    public String obtenerTipoUsuario(String email) {&#10;        if (manejadorCliente.obtenerClientePorEmail(email) != null) {&#10;            return &quot;CLIENTE&quot;;&#10;        } else if (manejadorAerolinea.obtenerAerolineaPorEmail(email) != null) {&#10;            return &quot;AEROLINEA&quot;;&#10;        }&#10;        return null;&#10;    }&#10;// =================== MÉTODOS PARA IMÁGENES ===================&#10;&#10;    /** Actualiza la URL de la imagen de un cliente. */&#10;    @Override&#10;    public void actualizarImagenCliente(String nickname, String imagenUrl) {&#10;        manejadorCliente.actualizarImagenCliente(nickname, imagenUrl, entManager);&#10;    }&#10;&#10;    /** Actualiza la URL de la imagen de una aerolínea. */&#10;    @Override&#10;    public void actualizarImagenAerolinea(String nickname, String imagenUrl) {&#10;        manejadorAerolinea.actualizarImagenAerolinea(nickname, imagenUrl, entManager);&#10;    }&#10;&#10;    /** Actualiza la imagen de una ruta y persiste el cambio. */&#10;    @Override&#10;    public void actualizarImagenRuta(String nombreRuta, String imagenUrl) {&#10;        manejadorRutaVuelo.actualizarImagenRuta(nombreRuta, imagenUrl, entManager);&#10;    }&#10;&#10;    // Métodos para obtener URLs de imagen (si los necesitan)&#10;    public String obtenerImagenCliente(String nickname) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        return cliente != null ? cliente.getImagenUrl() : null;&#10;    }&#10;&#10;    public String obtenerImagenAerolinea(String nickname) {&#10;        DtAerolinea aerolinea = manejadorAerolinea.getDtAerolineas().stream()&#10;                .filter(a -&gt; a.getNickname().equals(nickname))&#10;                .findFirst()&#10;                .orElse(null);&#10;        return aerolinea != null ? aerolinea.getImagenUrl() : null;&#10;    }&#10;&#10;    public String obtenerImagenRuta(String nombreRuta) {&#10;        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);&#10;        return ruta != null ? ruta.getImagenUrl() : null;&#10;    }&#10;&#10;    // ======================================&#10;&#10;&#10;    @Override&#10;    public List&lt;DtCliente&gt; listarClientes() {&#10;        return manejadorCliente.getClientes();&#10;    }&#10;&#10;    @Override&#10;    public Cliente verInfoCliente(String nickname) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        Cliente cliente1 = manejadorCliente.obtenerClientePorEmail(cliente.getEmail());&#10;        if (cliente1 != null) {&#10;            return cliente1;&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public DtCliente obtenerCliente(String nickname) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        return cliente;&#10;    }&#10;&#10;    @Override&#10;    public Aerolinea verInfoAerolinea(String nickname) {&#10;        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        if (aerolinea != null) {&#10;            return aerolinea;&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public DtAerolinea obtenerAerolinea(String nickname) {&#10;        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        if (aerolinea == null) {&#10;            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);&#10;        }&#10;        return new DtAerolinea(&#10;                aerolinea.getNickname(),&#10;                aerolinea.getNombre(),&#10;                aerolinea.getEmail(),&#10;                aerolinea.getDescripcion(),&#10;                aerolinea.getSitioWeb(),&#10;                aerolinea.getImagenUrl(),&#10;                aerolinea.getRutasVuelo()&#10;        );&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtAerolinea&gt; listarAerolineas() {&#10;        return manejadorAerolinea.getDtAerolineas();&#10;    }&#10;&#10;    // --- CIUDADES ---&#10;    @Override&#10;    public void altaCiudad(String nombre, String pais) {&#10;        String clave = nombre.trim().toLowerCase();&#10;&#10;        if (manejadorCiudad.obtenerCiudad(clave) != null) {&#10;            throw new IllegalArgumentException(&quot;Ya existe una ciudad con el nombre: &quot; + nombre);&#10;        }&#10;&#10;        Ciudad ciudad = new Ciudad(nombre, pais);&#10;        manejadorCiudad.agregarCiudad(ciudad, entManager);&#10;    }&#10;&#10;    @Override&#10;    public void altaRutaVuelo(String nombre, String descripcion, String descripcionCorta, DtAerolinea aerolinea,&#10;                              String ciudadOrigen, String ciudadDestino, String hora,&#10;                              LocalDate fechaAlta, double costoTurista, double costoEjecutivo,&#10;                              double costoEquipajeExtra, String[] categorias, String imagenUrl, String videoUrl) {&#10;&#10;        Aerolinea aero = manejadorAerolinea.obtenerAerolinea(aerolinea.getNickname());&#10;        if (aero == null) {&#10;            throw new IllegalArgumentException(&quot;No existe Aerolínea con nickname: &quot; + aerolinea.getNickname());&#10;        }&#10;&#10;        if (manejadorRutaVuelo.getRuta(nombre) != null) {&#10;            throw new IllegalArgumentException(&quot;Ya existe una ruta de vuelo con el nombre: &quot; + nombre);&#10;        }&#10;&#10;        if (ciudadOrigen.equalsIgnoreCase(ciudadDestino)) {&#10;            throw new IllegalArgumentException(&quot;La ciudad de origen y destino no pueden ser iguales.&quot;);&#10;        }&#10;&#10;        List&lt;String&gt; categoriaValida = new ArrayList&lt;&gt;();&#10;        for (String cat : categorias) {&#10;            Categoria categoria = manejadorCategoria.buscarCategorias(cat);&#10;            if (categoria != null) {&#10;                categoriaValida.add(cat);&#10;            }&#10;        }&#10;        if (categoriaValida.isEmpty()) {&#10;            throw new IllegalArgumentException(&quot;La ruta debe pertenecer a al menos una categoría válida.&quot;);&#10;        }&#10;&#10;        RutaVuelo rutaVuelo = new RutaVuelo(nombre, descripcion, descripcionCorta, aero, ciudadOrigen, ciudadDestino,&#10;                hora, fechaAlta, costoTurista, costoEjecutivo,&#10;                costoEquipajeExtra, categoriaValida, imagenUrl, videoUrl);&#10;&#10;        manejadorRutaVuelo.agregarRutaVuelo(rutaVuelo, entManager);&#10;        manejadorAerolinea.agregarRutaVueloAAerolinea(aero.getNickname(), rutaVuelo, entManager);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtAerolinea&gt; obtenerAerolineasConRutasPendientes() {&#10;        List&lt;DtAerolinea&gt; aerolineasConPendientes = new ArrayList&lt;&gt;();&#10;        for (DtAerolinea aero : manejadorAerolinea.getDtAerolineas()) {&#10;            List&lt;RutaVuelo&gt; rutasPendientes = manejadorRutaVuelo.getRutasPorEstadoYAerolinea(&#10;                    aero.getNombre(), INGRESADA);&#10;            if (!rutasPendientes.isEmpty()) {&#10;                aerolineasConPendientes.add(aero);&#10;            }&#10;        }&#10;&#10;        return aerolineasConPendientes;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; obtenerRutasPendientesPorAerolinea(String nombreAerolinea) {&#10;&#10;        cargarDesdeBd();&#10;        List&lt;RutaVuelo&gt; rutasPendientes = manejadorRutaVuelo.getRutasPorEstadoYAerolinea(&#10;                nombreAerolinea, INGRESADA);&#10;&#10;        List&lt;DtRutaVuelo&gt; dtRutasPendientes = new ArrayList&lt;&gt;();&#10;        for (RutaVuelo ruta : rutasPendientes) {&#10;            dtRutasPendientes.add(ruta.getDtRutaVuelo());&#10;        }&#10;        return dtRutasPendientes;&#10;    }&#10;&#10;    @Override&#10;    public void aceptarRutaVuelo(String nombreRuta) {&#10;        EntityManager emLocal = null;&#10;        try {&#10;            emLocal = emf.createEntityManager();&#10;            manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, EstadoRuta.CONFIRMADA, emLocal);&#10;            cargarDesdeBd();&#10;        } finally {&#10;            if (emLocal != null &amp;&amp; emLocal.isOpen()) emLocal.close();&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void rechazarRutaVuelo(String nombreRuta) {&#10;        EntityManager emLocal = null;&#10;        try {&#10;            emLocal = emf.createEntityManager();&#10;            manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, EstadoRuta.RECHAZADA, emLocal);&#10;            // Recargar datos en memoria para reflejar cambios en la UI&#10;            cargarDesdeBd();&#10;        } finally {&#10;            if (emLocal != null &amp;&amp; emLocal.isOpen()) emLocal.close();&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public RutaVuelo obtenerRuta(String nombreRuta) {&#10;        return manejadorRutaVuelo.getRuta(nombreRuta);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; listarRutasPorAerolinea(String nombreAerolinea) {&#10;        cargarDesdeBd();&#10;        return manejadorAerolinea.obtenerRutaVueloDeAerolinea(nombreAerolinea);&#10;    }&#10;&#10;    @Override&#10;    public void altaVuelo(String nombreVuelo, String nombreAereolinea, String nombreRuta,&#10;                          LocalDate fecha, int duracion, int asientosTurista,&#10;                          int asientosEjecutivo, LocalDate fechaAlta, String imagenUrl) {&#10;&#10;        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);&#10;        if (ruta == null) {&#10;            throw new IllegalArgumentException(&quot;La ruta &quot; + nombreRuta + &quot; no existe.&quot;);&#10;        }&#10;&#10;        // **Validar estado de la ruta**&#10;        EstadoRuta estado = ruta.getEstado();&#10;        if (estado != EstadoRuta.CONFIRMADA) {&#10;            if (estado == EstadoRuta.INGRESADA) {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No se puede dar de alta un vuelo para la ruta &quot; + nombreRuta +&#10;                                &quot; porque su estado es INGRESADA. Primero debe ser confirmada.&quot;&#10;                );&#10;            } else if (estado == EstadoRuta.FINALIZADA) {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No se puede dar de alta un vuelo para la ruta &quot; + nombreRuta +&#10;                                &quot; porque está FINALIZADA.&quot;&#10;                );&#10;            } else {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No se puede dar de alta un vuelo para la ruta &quot; + nombreRuta +&#10;                                &quot; porque no está CONFIRMADA. Estado actual: &quot; + estado&#10;                );&#10;            }&#10;        }&#10;&#10;        // Evitar acceder a colecciones lazy de RutaVuelo (puede causar LazyInitializationException)&#10;        if (manejadorVuelo.existeVuelo(nombreVuelo)) {&#10;            throw new IllegalArgumentException(&quot;Ya existe un vuelo con el nombre &quot; + nombreVuelo + &quot; en el sistema&quot;);&#10;        }&#10;&#10;        Vuelo vuelo = new Vuelo(nombreVuelo, nombreAereolinea, ruta, fecha, duracion,&#10;                asientosTurista, asientosEjecutivo, fechaAlta, imagenUrl);&#10;&#10;        manejadorVuelo.agregarVuelo(vuelo, entManager);&#10;        manejadorRutaVuelo.agregarVueloARuta(nombreRuta, vuelo, entManager);&#10;    }&#10;&#10;&#10;    public Vuelo obtenerVuelo(String nombreVuelo) {&#10;        return manejadorVuelo.getVuelo(nombreVuelo);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtVuelo&gt; listarVuelosPorRuta(String nombreRuta) {&#10;        return manejadorRutaVuelo.obtenerVuelosPorRuta(nombreRuta);&#10;    }&#10;&#10;    @Override&#10;    public DtVuelo verInfoVueloDt(String nombreVuelo) {&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);&#10;        }&#10;        return vuelo.getDtVuelo();&#10;    }&#10;&#10;    @Override&#10;    public Vuelo verInfoVuelo(String nombreVuelo) {&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);&#10;        }&#10;        return vuelo;&#10;    }&#10;&#10;    // --- RESERVA ---&#10;    /*@Override&#10;    public void crearYRegistrarReserva(String nicknameCliente, String nombreVuelo, LocalDate fechaReserva, double costo,&#10;                                       TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra,&#10;                                       List&lt;Pasajero&gt; pasajeros) {&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;El vuelo no existe: &quot; + nombreVuelo);&#10;        }&#10;&#10;        if (ManejadorVuelo.getInstance().tieneReservaDeCliente(nicknameCliente, vuelo)) {&#10;            throw new IllegalArgumentException(&#10;                    &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo +&#10;                            &quot;. Debe elegir otro vuelo o ruta.&quot;&#10;            );&#10;        }&#10;&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        if (cliente != null) {&#10;            for (DtReserva r : cliente.getReservas()) {&#10;                if (r.getVuelo().equals(nombreVuelo)) {&#10;                    throw new IllegalArgumentException(&#10;                            &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo + &quot;.&quot;&#10;                    );&#10;                }&#10;            }&#10;        }&#10;&#10;        // CREAR RESERVA SIN ID - se generará automáticamente&#10;        Reserva reserva = new Reserva(&#10;                costo, tipoAsiento, cantidadPasajes, unidadesEquipajeExtra, pasajeros, vuelo&#10;        );&#10;&#10;        registrarReservaVuelo(nicknameCliente, nombreVuelo, reserva);&#10;    }*/&#10;&#10;    @Override&#10;    public void crearYRegistrarReserva(String nicknameCliente, String nombreVuelo, LocalDate fechaReserva, double costo,&#10;                                       TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra,&#10;                                       List&lt;Pasajero&gt; pasajeros) {&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;El vuelo no existe: &quot; + nombreVuelo);&#10;        }&#10;        List&lt;DtReserva&gt; reservas= vuelo.getDtReservas();&#10;        int asientosOcupadosTurista = 0;&#10;        int asientosOcupadosEjecutivo = 0;&#10;        // Comprobar disponibilidad de asientos&#10;        for (DtReserva reserva : reservas) {&#10;            if (reserva.getTipoAsiento() == tipoAsiento) {&#10;                if (tipoAsiento == TipoAsiento.TURISTA) {&#10;                    asientosOcupadosTurista +=reserva.getCantidadPasajes();&#10;&#10;                } else if (tipoAsiento == TipoAsiento.EJECUTIVO) {&#10;                    asientosOcupadosEjecutivo += reserva.getCantidadPasajes();&#10;&#10;                }&#10;            }&#10;        }&#10;        if (tipoAsiento == TipoAsiento.TURISTA) {&#10;            if (asientosOcupadosTurista + cantidadPasajes &gt; vuelo.getAsientosTurista()) {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No hay suficientes asientos disponibles en clase TURISTA para el vuelo &quot; + nombreVuelo&#10;                );&#10;            }&#10;        }else {&#10;            if (asientosOcupadosEjecutivo + cantidadPasajes &gt; vuelo.getAsientosEjecutivo()) {&#10;                throw new IllegalArgumentException(&#10;                        &quot;No hay suficientes asientos disponibles en clase EJECUTIVO para el vuelo &quot; + nombreVuelo&#10;                );&#10;            }&#10;        }&#10;&#10;        // Comprobar si el cliente ya tiene una reserva en ese vuelo (buscar por nickname en las reservas del vuelo)&#10;        if (manejadorVuelo.tieneReservaDeCliente(nicknameCliente, vuelo)) {&#10;            throw new IllegalArgumentException(&#10;                    &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo +&#10;                            &quot;. Debe elegir otro vuelo o ruta.&quot;&#10;            );&#10;        }&#10;&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        if (cliente != null) {&#10;            for (DtReserva r : cliente.getReservas()) {&#10;                if (r.getVuelo().equals(nombreVuelo)) {&#10;                    throw new IllegalArgumentException(&#10;                            &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo + &quot;.&quot;&#10;                    );&#10;                }&#10;            }&#10;        }&#10;&#10;        // CREAR RESERVA SIN ID - se generará automáticamente&#10;        Reserva reserva = new Reserva(&#10;                costo, tipoAsiento, cantidadPasajes, unidadesEquipajeExtra, pasajeros, vuelo&#10;        );&#10;&#10;        registrarReservaVuelo(nicknameCliente, nombreVuelo, reserva);&#10;    }&#10;&#10;&#10;    @Override&#10;    public void registrarReservaVuelo(String nicknameCliente, String nombreVuelo, Reserva reserva) {&#10;        EntityTransaction entTransaction = entManager.getTransaction();&#10;        try {&#10;            entTransaction.begin();&#10;&#10;            DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;            Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;&#10;            if (cliente == null) {&#10;                throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;            }&#10;            if (vuelo == null) {&#10;                throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);&#10;            }&#10;&#10;            if (manejadorVuelo.tieneReservaDeCliente(nicknameCliente, vuelo)) {&#10;                throw new IllegalArgumentException(&quot;El cliente ya tiene una reserva para este vuelo&quot;);&#10;            }&#10;&#10;            // Persistir reserva para generar ID automático&#10;            entManager.persist(reserva);&#10;            entManager.flush(); // Forzar generación del ID&#10;&#10;            // Agregar reserva al vuelo y al cliente&#10;            vuelo.agregarReserva(reserva);&#10;            manejadorCliente.agregarReserva(reserva, nicknameCliente, reserva.getId(), entManager);&#10;            manejadorVuelo.actualizarVuelo(vuelo, entManager); // Ahora sin transacción interna&#10;&#10;            entTransaction.commit();&#10;&#10;        } catch (PersistenceException e) {&#10;            if (entTransaction.isActive()) {&#10;                entTransaction.rollback();&#10;            }&#10;            throw new IllegalStateException(&quot;Error al registrar reserva: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public DtReserva obtenerReserva(Long idReserva, String nicknameCliente) { // Cambiado a Long&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        try {&#10;            if (cliente == null) {&#10;                throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;            }&#10;            for (DtReserva r : cliente.getReservas()) {&#10;                if (r.getId().equals(idReserva)) {&#10;                    return r;&#10;                }&#10;            }&#10;            throw new IllegalArgumentException(&quot;Reserva no encontrada&quot;);&#10;        } catch (PersistenceException e) {&#10;            throw new IllegalArgumentException(&quot;Error al obtener la reserva: &quot; + e.getMessage());&#10;        }&#10;    }&#10;&#10;    // --- PAQUETES ---&#10;    @Override&#10;    public void altaPaquete(String nombre, String descripcion, int descuentoPorc, int periodoValidezDias) {&#10;        if (manejadorPaquete.obtenerPaquete(nombre) != null) {&#10;            throw new IllegalArgumentException(&quot;Ya existe un paquete con el nombre: &quot; + nombre);&#10;        }&#10;&#10;        if (nombre == null || nombre.trim().isEmpty()) {&#10;            throw new IllegalArgumentException(&quot;El nombre del paquete no puede estar vacío.&quot;);&#10;        }&#10;        if (descuentoPorc &lt; 0 || descuentoPorc &gt; 100) {&#10;            throw new IllegalArgumentException(&quot;El descuento debe estar entre 0 y 100 por ciento.&quot;);&#10;        }&#10;        if (periodoValidezDias &lt; 0) {&#10;            throw new IllegalArgumentException(&quot;El período de validez no puede ser negativo.&quot;);&#10;        }&#10;&#10;        Paquete paquete = new Paquete(nombre.trim(), descripcion, descuentoPorc, periodoValidezDias);&#10;        manejadorPaquete.agregarPaquete(paquete, entManager);&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtPaquete&gt; listarPaquetes() {&#10;        return manejadorPaquete.getPaquetes();&#10;    }&#10;&#10;    @Override&#10;    public void modificarDatosDeCliente(String nickname, String nombre, String apellido, String nacionalidad, LocalDate fechaNacimiento, TipoDoc tipoDoc, String numeroDocumento) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        if (cliente != null) {&#10;            cliente.setApellido(apellido);&#10;            cliente.setNombre(nombre);&#10;            cliente.setNacionalidad(nacionalidad);&#10;            cliente.setFechaNacimiento(fechaNacimiento);&#10;            cliente.setTipoDocumento(tipoDoc);&#10;            cliente.setNumeroDocumento(numeroDocumento);&#10;            manejadorCliente.modificarDatosCliente(cliente, entManager);&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void modificarDatosAerolinea(String nickname, String descripcion, String url) {&#10;        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        if (aerolinea != null) {&#10;            aerolinea.setDescripcion(descripcion);&#10;            aerolinea.setSitioWeb(url);&#10;            manejadorAerolinea.modificarDatosAerolinea(aerolinea, entManager);&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtPaquete&gt; listarPaquetesDisp() {&#10;        return manejadorPaquete.getPaquetesDisp();&#10;    }&#10;&#10;    @Override&#10;    public double calcularCostoReserva(String nombreVuelo, TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra) {&#10;        ManejadorVuelo manejadorVuelo = ManejadorVuelo.getInstance();&#10;        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);&#10;&#10;        if (vuelo == null) {&#10;            throw new IllegalArgumentException(&quot;Vuelo no encontrado: &quot; + nombreVuelo);&#10;        }&#10;&#10;        double costoBase;&#10;        if (tipoAsiento == TipoAsiento.TURISTA) {&#10;            costoBase = 100.0;&#10;        } else {&#10;            costoBase = 200.0;&#10;        }&#10;&#10;        double costoPasajes = costoBase * cantidadPasajes;&#10;        double costoEquipaje = 30.0 * unidadesEquipajeExtra;&#10;&#10;        return costoPasajes + costoEquipaje;&#10;    }&#10;&#10;    @Override&#10;    public Pasajero crearPasajero(String nombre, String apellido) {&#10;        if (nombre == null || nombre.trim().isEmpty()) {&#10;            throw new IllegalArgumentException(&quot;El nombre del pasajero no puede estar vacío.&quot;);&#10;        }&#10;        if (apellido == null || apellido.trim().isEmpty()) {&#10;            throw new IllegalArgumentException(&quot;El apellido del pasajero no puede estar vacío.&quot;);&#10;        }&#10;        return new Pasajero(nombre.trim(), apellido.trim());&#10;    }&#10;&#10;    @Override&#10;    public void compraPaquete(String nomPaquete, String nomCliente, int validezDias, LocalDate fechaC, double costo) {&#10;        Paquete paquete = manejadorPaquete.obtenerPaquete(nomPaquete);&#10;        if (paquete == null) {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);&#10;        }&#10;&#10;        DtCliente dtCliente = manejadorCliente.obtenerCliente(nomCliente);&#10;        if (dtCliente == null) {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;&#10;        for (CompraPaqLogica cp : paquete.getCompras()) {&#10;            if (cp.getCliente().getNickname().equals(dtCliente.getNickname())) {&#10;                throw new IllegalArgumentException(&quot;Error, el cliente &quot; + dtCliente.getNombre() + &quot; ya compró el paquete &quot; + paquete.getNombre() + &quot;. Elija otro o cancele.&quot;);&#10;            }&#10;        }&#10;&#10;        try {&#10;            manejadorPaquete.compraPaquete(paquete, dtCliente, validezDias, fechaC, costo, entManager);&#10;            LOGGER.info(() -&gt; &quot;Paquete comprado correctamente para cliente: &quot; + dtCliente.getNickname() + &quot;, paquete: &quot; + paquete.getNombre());&#10;        } catch (IllegalStateException e) {&#10;            LOGGER.log(Level.SEVERE, () -&gt; &quot;Error comprando paquete: &quot; + e.getMessage());&#10;            throw e;&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void altaCategoria(String nomCat) {&#10;        Categoria cat = manejadorCategoria.buscarCategorias(nomCat);&#10;        if (cat != null) {&#10;            throw new IllegalArgumentException(&quot;Error, la categoria ya existe.&quot;);&#10;        }&#10;&#10;        try {&#10;            Categoria categoria = new Categoria(nomCat);&#10;            manejadorCategoria.agregarCategoria(categoria, entManager);&#10;            LOGGER.info(() -&gt; &quot;Categoría creada correctamente: &quot; + nomCat);&#10;        } catch (IllegalStateException e) {&#10;            LOGGER.log(Level.SEVERE, () -&gt; &quot;Error creando categoría: &quot; + e.getMessage());&#10;            throw e;&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;Object&gt; obtenerDatosAdicionalesUsuario(String nickname) {&#10;        List&lt;Object&gt; adicionales = new ArrayList&lt;&gt;();&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        if (cliente != null) {&#10;            adicionales.addAll(cliente.getReservas());&#10;            adicionales.addAll(cliente.getPaquetesComprados());&#10;            return adicionales;&#10;        }&#10;        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        if (aerolinea != null) {&#10;            adicionales.addAll(aerolinea.getRutasVuelo());&#10;            return adicionales;&#10;        }&#10;        return adicionales;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtCiudad&gt; listarCiudades() {&#10;        List&lt;DtCiudad&gt; dtCiudades = new ArrayList&lt;&gt;();&#10;        for (Ciudad ciudad : manejadorCiudad.getCiudades()) {&#10;            dtCiudades.add(new DtCiudad(ciudad.getNombre(), ciudad.getPais()));&#10;        }&#10;        return dtCiudades;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtCategoria&gt; listarCategorias() {&#10;        List&lt;DtCategoria&gt; lista = new ArrayList&lt;&gt;();&#10;        for (Categoria c : manejadorCategoria.getCategorias().values()) {&#10;            lista.add(new DtCategoria(c.getNombre()));&#10;        }&#10;        return lista;&#10;    }&#10;&#10;    @Override&#10;    public void altaRutaPaquete(String nombrePaquete, String nomRuta, int cantidadAsientos, TipoAsiento tipoAsiento) {&#10;        Paquete paquete = manejadorPaquete.obtenerPaquete(nombrePaquete);&#10;        if (paquete == null) {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);&#10;        }&#10;&#10;        if (paquete.estaComprado()) {&#10;            throw new IllegalArgumentException(&quot;No se pueden agregar rutas a un paquete que ya ha sido comprado.&quot;);&#10;        }&#10;&#10;        // En lugar de usar la instancia en memoria, leer directamente desde la BD&#10;        RutaVuelo rutaGestionada = null;&#10;        final int MAX_INTENTOS = 20;&#10;        final long RETRY_DELAY_MS = 100;&#10;        int intento = 0;&#10;        while (intento &lt; MAX_INTENTOS) {&#10;            EntityManager emLocal = null;&#10;            try {&#10;                emLocal = emf.createEntityManager();&#10;                jakarta.persistence.TypedQuery&lt;RutaVuelo&gt; q = emLocal.createQuery(&quot;SELECT r FROM RutaVuelo r WHERE r.nombre = :n&quot;, RutaVuelo.class);&#10;                q.setParameter(&quot;n&quot;, nomRuta);&#10;                java.util.List&lt;RutaVuelo&gt; res = q.getResultList();&#10;                if (!res.isEmpty()) {&#10;                    rutaGestionada = res.get(0);&#10;                    // Forzar inicialización de la colección de vuelos mientras el EntityManager está abierto&#10;                    try {&#10;                        if (rutaGestionada.getVuelos() != null) {&#10;                            rutaGestionada.getVuelos().size();&#10;                        }&#10;                    } catch (Exception ignore) {&#10;                        // ignorar problemas de inicialización y reintentar en el loop&#10;                    }&#10;                    if (rutaGestionada.getEstado() == CONFIRMADA) {&#10;                        break; // confirmada en BD, ya podemos continuar&#10;                    }&#10;                }&#10;            } catch (Exception e) {&#10;                // ignoro y reintento&#10;            } finally {&#10;                if (emLocal != null &amp;&amp; emLocal.isOpen()) emLocal.close();&#10;            }&#10;&#10;            intento++;&#10;            try {&#10;                Thread.sleep(RETRY_DELAY_MS);&#10;            } catch (InterruptedException ie) {&#10;                Thread.currentThread().interrupt();&#10;                break;&#10;            }&#10;        }&#10;&#10;        if (rutaGestionada == null) {&#10;            throw new IllegalArgumentException(&quot;No se encontró la ruta con ese nombre en la BD: &quot; + nomRuta);&#10;        }&#10;&#10;        if (rutaGestionada.getEstado() != CONFIRMADA) {&#10;            throw new IllegalArgumentException(&quot;No se puede agregar una ruta que no esté CONFIRMADA al paquete. Ruta actual: &quot; + rutaGestionada.getEstado());&#10;        }&#10;&#10;        // Pasar la instancia gestionada (detached) al manejador del paquete; el manejador reatachará/mergeará&#10;        manejadorPaquete.agregarRutaAPaquete(paquete, rutaGestionada, cantidadAsientos, tipoAsiento, entManager);&#10;&#10;        DtPaquete dtPaquete = obtenerDtPaquete(nombrePaquete);&#10;        if (dtPaquete != null) {&#10;            DtRutaVuelo dtRuta = rutaGestionada.getDtRutaVuelo();&#10;            DtItemPaquete dtItem = new DtItemPaquete(dtRuta, cantidadAsientos, tipoAsiento.toString());&#10;            dtPaquete.getItems().add(dtItem);&#10;        }&#10;        LOGGER.info(() -&gt; &quot;Ruta agregada al paquete correctamente: &quot; + nombrePaquete + &quot;, ruta: &quot; + nomRuta);&#10;    }&#10;&#10;    @Override&#10;    public Paquete obtenerPaquete(String nombrePaquete) {&#10;        Paquete paquete = manejadorPaquete.obtenerPaquete(nombrePaquete);&#10;        if (paquete == null) {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);&#10;        }&#10;        return paquete;&#10;    }&#10;&#10;    @Override&#10;    public DtPaquete obtenerDtPaquete(String nombrePaquete) {&#10;        DtPaquete paquete = manejadorPaquete.obtenerDtPaquete(nombrePaquete);&#10;        if (paquete == null) {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);&#10;        }&#10;        return paquete;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtAerolinea&gt; getAerolineas() {&#10;        return manejadorAerolinea.getDtAerolineas();&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtPaquete&gt; getPaquetesDisp() {&#10;        return manejadorPaquete.getPaquetes();&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtCliente&gt; getClientes() {&#10;        return manejadorCliente.getClientes();&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtReserva&gt; getReservasCliente(String nickname) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);&#10;        if (cliente != null) {&#10;            return cliente.getReservas();&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtItemPaquete&gt; getDtItemRutasPaquete(String nombrePaquete) {&#10;        List&lt;DtItemPaquete&gt; items = manejadorPaquete.obtenerDtItemsPaquete(nombrePaquete);&#10;        if (items != null &amp;&amp; !items.isEmpty()) {&#10;            return items;&#10;        } else {&#10;            throw new IllegalArgumentException(&quot;Paquete no encontrado o sin rutas asociadas&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; listarRutasConfirmadas(int limite) {&#10;        List&lt;DtRutaVuelo&gt; rutasConfirmadas = new ArrayList&lt;&gt;();&#10;        List&lt;DtAerolinea&gt; aerolineas = listarAerolineas();&#10;&#10;        for (DtAerolinea aerolinea : aerolineas) {&#10;            try {&#10;                List&lt;DtRutaVuelo&gt; rutasAerolinea = listarRutasPorAerolinea(aerolinea.getNickname());&#10;                for (DtRutaVuelo ruta : rutasAerolinea) {&#10;                    if (&quot;CONFIRMADA&quot;.equals(ruta.getEstado())) {&#10;                        rutasConfirmadas.add(ruta);&#10;                        if (rutasConfirmadas.size() &gt;= limite) {&#10;                            return rutasConfirmadas;&#10;                        }&#10;                    }&#10;                }&#10;            } catch (PersistenceException  e) {&#10;                continue;&#10;            }&#10;        }&#10;        return rutasConfirmadas;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; obtenerTopRutasMasVisitadas(int limite) {&#10;        try {&#10;            List&lt;RutaVuelo&gt; rutasMasVisitadas = manejadorRutaVuelo.getTopRutasConfirmadasMasVisitadas(limite);&#10;            List&lt;DtRutaVuelo&gt; dtRutas = new ArrayList&lt;&gt;();&#10;&#10;            for (RutaVuelo ruta : rutasMasVisitadas) {&#10;                dtRutas.add(ruta.getDtRutaVuelo());&#10;            }&#10;&#10;            System.out.println(&quot;[SISTEMA] Top &quot; + dtRutas.size() + &quot; rutas más visitadas obtenidas&quot;);&#10;            return dtRutas;&#10;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;[SISTEMA] Error obteniendo DTOs de rutas visitadas: &quot; + e.getMessage());&#10;            return new ArrayList&lt;&gt;();&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public void finalizarRutaVuelo(String nombreRuta) {&#10;        if (puedeFinalizarRuta(nombreRuta) != 4) {&#10;            throw new IllegalArgumentException(&quot;La ruta no puede ser finalizada: &quot; + nombreRuta);&#10;        }&#10;&#10;        manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, EstadoRuta.FINALIZADA, entManager);&#10;        LOGGER.info(&quot;Ruta finalizada: &quot; + nombreRuta);&#10;    }&#10;&#10;    @Override&#10;    public int puedeFinalizarRuta(String nombreRuta) {&#10;        System.out.println(&quot;[DEBUG] Verificando si puede finalizar ruta: &quot; + nombreRuta);&#10;&#10;        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);&#10;        if (ruta == null) {&#10;            System.out.println(&quot;[DEBUG] Ruta no encontrada: &quot; + nombreRuta);&#10;            return 0;&#10;        }&#10;&#10;        System.out.println(&quot;[DEBUG] Estado de la ruta: &quot; + ruta.getEstado());&#10;&#10;        // 1. Verificar que esté en estado CONFIRMADA&#10;        if (ruta.getEstado() != EstadoRuta.CONFIRMADA) {&#10;            System.out.println(&quot;[DEBUG] No puede finalizar - Estado incorrecto: &quot; + ruta.getEstado());&#10;            return 1;&#10;        }&#10;&#10;        // 2. Verificar que no tenga vuelos pendientes (fecha futura)&#10;        if (tieneVuelosPendientes(ruta)) {&#10;            System.out.println(&quot;[DEBUG] No puede finalizar - Tiene vuelos pendientes&quot;);&#10;            return 2;&#10;        }&#10;&#10;        // 3. Verificar que no esté en ningún paquete activo&#10;        if (estaEnPaqueteActivo(ruta)) {&#10;            System.out.println(&quot;[DEBUG] No puede finalizar - Está en paquete activo&quot;);&#10;            return 3;&#10;        }&#10;&#10;        System.out.println(&quot;[DEBUG] Ruta puede finalizar - código 4&quot;);&#10;        return 4;&#10;    }&#10;&#10;    private boolean tieneVuelosPendientes(RutaVuelo ruta) {&#10;        try {&#10;            LocalDate hoy = LocalDate.now();&#10;            for (Vuelo vuelo : ruta.getVuelos()) {&#10;                if (vuelo.getFecha().isAfter(hoy)) {&#10;                    return true;&#10;                }&#10;            }&#10;            return false;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;Error en tieneVuelosPendientes: &quot; + e.getMessage());&#10;            return true; // Por seguridad, asumir que tiene vuelos pendientes si hay error&#10;        }&#10;    }&#10;&#10;    private boolean estaEnPaqueteActivo(RutaVuelo ruta) {&#10;        try {&#10;            List&lt;DtPaquete&gt; paquetes = listarPaquetes();&#10;            for (DtPaquete paquete : paquetes) {&#10;                if (paqueteContieneRuta(paquete.getNombre(), ruta.getNombre())) {&#10;                    return true;&#10;                }&#10;            }&#10;            return false;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;Error en estaEnPaqueteActivo: &quot; + e.getMessage());&#10;            return true; // Por seguridad, asumir que está en paquete activo si hay error&#10;        }&#10;    }&#10;&#10;    // Método auxiliar - implementado usando ManejadorPaquete&#10;    private boolean paqueteContieneRuta(String nombrePaquete, String nombreRuta) {&#10;        Paquete paquete = manejadorPaquete.obtenerPaquete(nombrePaquete);&#10;        if (paquete == null) {&#10;            return false;&#10;        }&#10;&#10;        // Verificar si el paquete contiene la ruta en sus items&#10;        for (ItemPaquete item : paquete.getItemPaquetes()) {&#10;            if (item.getRutaVuelo().getNombre().equals(nombreRuta)) {&#10;                return true;&#10;            }&#10;        }&#10;        return false;&#10;    }&#10;&#10;    // =================== MÉTODOS DE SEGUIMIENTO (FOLLOW) ===================&#10;&#10;    @Override&#10;    public void incrementarVisitasRuta(String nombreRuta) {&#10;        try {&#10;            manejadorRutaVuelo.incrementarVisitasRuta(nombreRuta, entManager);&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;[SISTEMA] Error incrementando visitas: &quot; + e.getMessage());&#10;            throw new RuntimeException(&quot;Error al incrementar visitas para ruta: &quot; + nombreRuta, e);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public int obtenerTotalVisitasRuta(String nombreRuta) {&#10;        try {&#10;            RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);&#10;            return ruta != null ? ruta.getContadorVisitas() : 0;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;[SISTEMA] Error obteniendo total de visitas: &quot; + e.getMessage());&#10;            return 0;&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtReserva&gt; obtenerReservasConCheckin(String nicknameCliente) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        if (cliente == null) {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;&#10;        List&lt;DtReserva&gt; reservasConCheckin = new ArrayList&lt;&gt;();&#10;        for (DtReserva reserva : cliente.getReservas()) {&#10;            // Aquí necesitarías verificar el estado de la reserva&#10;            // Esto requiere cargar la reserva completa desde la base de datos&#10;            Reserva reservaCompleta = obtenerReservaCompleta(reserva.getId());&#10;            if (reservaCompleta != null &amp;&amp; reservaCompleta.getEstado() == EstadoReserva.CHECKIN_REALIZADO) {&#10;                reservasConCheckin.add(new DtReserva(reservaCompleta));&#10;            }&#10;        }&#10;        return reservasConCheckin;&#10;    }&#10;&#10;    @Override&#10;    public DtReserva consultarCheckinReserva(Long idReserva, String nicknameCliente) {&#10;        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);&#10;        if (cliente == null) {&#10;            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);&#10;        }&#10;&#10;        // Verificar que la reserva pertenece al cliente&#10;        boolean reservaPertenece = false;&#10;        for (DtReserva r : cliente.getReservas()) {&#10;            if (r.getId().equals(idReserva)) {&#10;                reservaPertenece = true;&#10;                break;&#10;            }&#10;        }&#10;&#10;        if (!reservaPertenece) {&#10;            throw new IllegalArgumentException(&quot;La reserva no pertenece al cliente&quot;);&#10;        }&#10;&#10;        Reserva reservaCompleta = obtenerReservaCompleta(idReserva);&#10;        if (reservaCompleta == null) {&#10;            throw new IllegalArgumentException(&quot;Reserva no encontrada&quot;);&#10;        }&#10;&#10;        if (reservaCompleta.getEstado() != EstadoReserva.CHECKIN_REALIZADO) {&#10;            throw new IllegalStateException(&quot;Check-in no realizado para esta reserva&quot;);&#10;        }&#10;&#10;        return new DtReserva(reservaCompleta);&#10;    }&#10;&#10;    @Override&#10;    public void realizarCheckinReserva(Long idReserva, List&lt;String&gt; asientosAsignados, LocalTime horaEmbarque) {&#10;        EntityTransaction tx = entManager.getTransaction();&#10;        try {&#10;            tx.begin();&#10;&#10;            Reserva reserva = entManager.find(Reserva.class, idReserva);&#10;            if (reserva == null) {&#10;                throw new IllegalArgumentException(&quot;Reserva no encontrada&quot;);&#10;            }&#10;&#10;            reserva.realizarCheckin(asientosAsignados, horaEmbarque);&#10;            entManager.merge(reserva);&#10;&#10;            tx.commit();&#10;            LOGGER.info(&quot;Check-in realizado para reserva: &quot; + idReserva);&#10;&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            throw new IllegalStateException(&quot;Error al realizar check-in: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    // Método auxiliar para obtener reserva completa&#10;    private Reserva obtenerReservaCompleta(Long idReserva) {&#10;        return entManager.find(Reserva.class, idReserva);&#10;    }&#10;&#10;    @Override&#10;    public void followUsuario(String followerNickname, String targetNickname) {&#10;        if (followerNickname == null || targetNickname == null)&#10;            throw new IllegalArgumentException(&quot;Nick null&quot;);&#10;&#10;        if (followerNickname.equals(targetNickname))&#10;            throw new IllegalArgumentException(&quot;No puede seguirse a sí mismo&quot;);&#10;&#10;        // Buscar en manejadores en memoria primero (compatibilidad con tu esquema)&#10;        Usuario follower = manejadorCliente.obtenerClienteReal(followerNickname);&#10;        if (follower == null) follower = manejadorAerolinea.obtenerAerolinea(followerNickname);&#10;&#10;        Usuario target = manejadorCliente.obtenerClienteReal(targetNickname);&#10;        if (target == null) target = manejadorAerolinea.obtenerAerolinea(targetNickname);&#10;&#10;        if (follower == null || target == null)&#10;            throw new IllegalArgumentException(&quot;Usuario no encontrado&quot;);&#10;&#10;        // Delegar la persistencia al manejador, pasándole el EntityManager del Sistema&#10;        manejadorFollow.followUsuario(followerNickname, targetNickname, entManager);&#10;&#10;        // Actualizar sets locales&#10;        follower.agregarSeguido(target);&#10;        target.agregarSeguidor(follower);&#10;    }&#10;&#10;    @Override&#10;    public void unfollowUsuario(String followerNickname, String targetNickname) {&#10;        if (followerNickname == null || targetNickname == null)&#10;            throw new IllegalArgumentException(&quot;Nick null&quot;);&#10;&#10;        if (followerNickname.equals(targetNickname))&#10;            throw new IllegalArgumentException(&quot;No puede dejar de seguirse a sí mismo&quot;);&#10;&#10;        // Buscar en manejadores en memoria primero&#10;        Usuario follower = manejadorCliente.obtenerClienteReal(followerNickname);&#10;        if (follower == null) follower = manejadorAerolinea.obtenerAerolinea(followerNickname);&#10;&#10;        Usuario target = manejadorCliente.obtenerClienteReal(targetNickname);&#10;        if (target == null) target = manejadorAerolinea.obtenerAerolinea(targetNickname);&#10;&#10;        if (follower == null || target == null)&#10;            throw new IllegalArgumentException(&quot;Usuario no encontrado&quot;);&#10;&#10;        // Delegar la eliminación al manejador, pasando el EntityManager&#10;        manejadorFollow.unfollowUsuario(followerNickname, targetNickname, entManager);&#10;&#10;        follower.quitarSeguido(target);&#10;        target.quitarSeguidor(follower);&#10;    }&#10;&#10;    // Devuelve la cantidad de seguidores de un usuario&#10;    @Override&#10;    public int obtenerCantidadSeguidores(String nickname) {&#10;        try {&#10;            // Consultar directamente desde memoria del ManejadorFollow (ya sincronizado con BD)&#10;            return manejadorFollow.countSeguidores(nickname);&#10;        } catch (Exception e) {&#10;            LOGGER.log(Level.SEVERE, &quot;Error obteniendo cantidad de seguidores&quot;, e);&#10;            return 0;&#10;        }&#10;    }&#10;&#10;    // Devuelve la cantidad de seguidos de un usuario&#10;    @Override&#10;    public int obtenerCantidadSeguidos(String nickname) {&#10;        try {&#10;            // Consultar directamente desde memoria del ManejadorFollow (ya sincronizado con BD)&#10;            return manejadorFollow.countSeguidos(nickname);&#10;        } catch (Exception e) {&#10;            LOGGER.log(Level.SEVERE, &quot;Error obteniendo cantidad de seguidos&quot;, e);&#10;            return 0;&#10;        }&#10;    }&#10;&#10;    private Usuario obtenerUsuarioPorNickname(String nickname) {&#10;        // Primero buscar como cliente&#10;        Usuario usuario = manejadorCliente.obtenerClienteReal(nickname);&#10;        if (usuario == null) {&#10;            // Si no es cliente, buscar como aerolínea&#10;            usuario = manejadorAerolinea.obtenerAerolinea(nickname);&#10;        }&#10;        return usuario;&#10;    }&#10;&#10;    @Override&#10;    public boolean verificarSeguimiento(String seguidorId, String seguidoId) {&#10;        try {&#10;            // Verificar que no sean el mismo usuario&#10;            if (seguidorId.equals(seguidoId)) {&#10;                return false;&#10;            }&#10;&#10;            // Consultar directamente desde memoria del ManejadorFollow (ya sincronizado con BD)&#10;            return manejadorFollow.estaSiguiendo(seguidorId, seguidoId);&#10;&#10;        } catch (Exception e) {&#10;            LOGGER.log(Level.SEVERE, &quot;Error verificando seguimiento&quot;, e);&#10;            return false;&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Obtiene la hora de la ruta a la que pertenece una reserva específica&#10;     * @param idReserva ID de la reserva&#10;     * @return Hora de la ruta en formato String, o null si no se encuentra&#10;     */&#10;    @Override&#10;    public String obtenerHoraRutaPorReserva(Long idReserva) {&#10;        try {&#10;            // Buscar la reserva por ID&#10;            Reserva reserva = entManager.find(Reserva.class, idReserva);&#10;            if (reserva == null) {&#10;                throw new IllegalArgumentException(&quot;Reserva no encontrada con ID: &quot; + idReserva);&#10;            }&#10;&#10;            // Navegar a través de las relaciones: Reserva -&gt; Vuelo -&gt; RutaVuelo -&gt; Hora&#10;            return reserva.getVuelo().getRutaVuelo().getHora();&#10;&#10;        } catch (Exception e) {&#10;            LOGGER.log(Level.SEVERE, &quot;Error obteniendo hora de la ruta para reserva: &quot; + idReserva, e);&#10;            throw new IllegalArgumentException(&quot;Error al obtener la hora de la ruta: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Obtiene los asientos disponibles (no ocupados) en el vuelo de una reserva específica&#10;     * @param idReserva ID de la reserva&#10;     * @return Lista de strings con los IDs de los asientos disponibles en el vuelo&#10;     */&#10;    @Override&#10;    public List&lt;String&gt; obtenerAsientosDisponiblesVuelo(Long idReserva) {&#10;        EntityTransaction tx = null;&#10;        try {&#10;            tx = entManager.getTransaction();&#10;            tx.begin();&#10;&#10;            // Buscar la reserva por ID&#10;            Reserva reserva = entManager.find(Reserva.class, idReserva);&#10;            if (reserva == null) {&#10;                throw new IllegalArgumentException(&quot;Reserva no encontrada con ID: &quot; + idReserva);&#10;            }&#10;&#10;            // Obtener el vuelo de la reserva&#10;            Vuelo vuelo = reserva.getVuelo();&#10;            if (vuelo == null) {&#10;                throw new IllegalArgumentException(&quot;No se encontró el vuelo asociado a la reserva&quot;);&#10;            }&#10;&#10;            // Obtener todos los asientos del vuelo&#10;            List&lt;String&gt; todosLosAsientos = generarAsientosDisponibles(vuelo);&#10;&#10;            // Obtener asientos ya ocupados en el vuelo&#10;            List&lt;String&gt; asientosOcupados = obtenerAsientosOcupadosVuelo(vuelo);&#10;&#10;            // Filtrar asientos disponibles (todos - ocupados)&#10;            List&lt;String&gt; asientosDisponibles = new ArrayList&lt;&gt;(todosLosAsientos);&#10;            asientosDisponibles.removeAll(asientosOcupados);&#10;&#10;            tx.commit();&#10;            return asientosDisponibles;&#10;&#10;        } catch (Exception e) {&#10;            if (tx != null &amp;&amp; tx.isActive()) {&#10;                tx.rollback();&#10;            }&#10;            LOGGER.log(Level.SEVERE, &quot;Error obteniendo asientos disponibles para reserva: &quot; + idReserva, e);&#10;            throw new IllegalStateException(&quot;Error al obtener asientos disponibles: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    /**&#10;     * Genera la lista de todos los asientos posibles del vuelo&#10;     */&#10;    private List&lt;String&gt; generarAsientosDisponibles(Vuelo vuelo) {&#10;        List&lt;String&gt; asientos = new ArrayList&lt;&gt;();&#10;&#10;        // Generar asientos turista (ejemplo: A1, A2, ..., B1, B2, ...)&#10;        int filasTurista = vuelo.getAsientosTurista() / 6; // Asumiendo 6 asientos por fila&#10;        for (int fila = 1; fila &lt;= filasTurista; fila++) {&#10;            for (char columna = 'A'; columna &lt;= 'F'; columna++) {&#10;                asientos.add(columna + String.valueOf(fila));&#10;            }&#10;        }&#10;&#10;        // Generar asientos ejecutivos (ejemplo: J1, J2, ..., K1, K2, ...)&#10;        int filasEjecutivo = vuelo.getAsientosEjecutivo() / 4; // Asumiendo 4 asientos por fila en ejecutivo&#10;        for (int fila = 1; fila &lt;= filasEjecutivo; fila++) {&#10;            for (char columna = 'J'; columna &lt;= 'M'; columna++) {&#10;                asientos.add(columna + String.valueOf(fila));&#10;            }&#10;        }&#10;&#10;        return asientos;&#10;    }&#10;&#10;    /**&#10;     * Obtiene todos los asientos ya ocupados en el vuelo&#10;     */&#10;    private List&lt;String&gt; obtenerAsientosOcupadosVuelo(Vuelo vuelo) {&#10;        List&lt;String&gt; asientosOcupados = new ArrayList&lt;&gt;();&#10;&#10;        // Recorrer todas las reservas del vuelo que tengan check-in&#10;        for (DtReserva dtReserva : vuelo.getDtReservas()) {&#10;            // Obtener la reserva completa&#10;            Reserva reservaCompleta = entManager.find(Reserva.class, dtReserva.getId());&#10;            if (reservaCompleta != null &amp;&amp; reservaCompleta.getEstado() == EstadoReserva.CHECKIN_REALIZADO) {&#10;                List&lt;String&gt; asientosReserva = reservaCompleta.getAsientosAsignados();&#10;                if (asientosReserva != null) {&#10;                    asientosOcupados.addAll(asientosReserva);&#10;                }&#10;            }&#10;        }&#10;&#10;        return asientosOcupados;&#10;    }&#10;&#10;    @Override&#10;    public List&lt;DtRutaVuelo&gt; listarRutasFinalizables(String nombreAerolinea) {&#10;        List&lt;DtRutaVuelo&gt; rutasFinalizables = new ArrayList&lt;&gt;();&#10;        List&lt;DtRutaVuelo&gt; rutasAerolinea = listarRutasPorAerolinea(nombreAerolinea);&#10;&#10;        for (DtRutaVuelo ruta : rutasAerolinea) {&#10;            if (puedeFinalizarRuta(ruta.getNombre()) == 4) {&#10;                rutasFinalizables.add(ruta);&#10;            }&#10;        }&#10;        return rutasFinalizables;&#10;    }&#10;&#10;    @Override&#10;    public boolean tieneCheckinRealizado(Long reservaId) {&#10;        try {&#10;            Reserva reserva = obtenerReservaCompleta(reservaId);&#10;            if (reserva != null) {&#10;                // Verificar por el flag explícito de check-in (boolean primitivo)&#10;                if (reserva.getCheckinRealizado()) {&#10;                    return true;&#10;                }&#10;&#10;                // Verificar por fecha de check-in&#10;                if (reserva.getFechaCheckin() != null) {&#10;                    return true;&#10;                }&#10;&#10;                // Verificar si el estado cambió de PENDIENTE&#10;                if (reserva.getEstado() != null &amp;&amp;&#10;                        !&quot;PENDIENTE&quot;.equalsIgnoreCase(reserva.getEstado().toString())) {&#10;                    return true;&#10;                }&#10;            }&#10;            return false;&#10;        } catch (Exception e) {&#10;            System.err.println(&quot;Error en tieneCheckinRealizado: &quot; + e.getMessage());&#10;            return false;&#10;        }&#10;    }&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/logica/TipoAsiento.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/logica/TipoAsiento.java" />
              <option name="originalContent" value="package logica;&#10;&#10;/**&#10; * Enum con los tipos de asiento disponibles en los vuelos.&#10; */&#10;public enum TipoAsiento {&#10;    TURISTA,&#10;    EJECUTIVO&#10;}&#10;" />
              <option name="updatedContent" value="package logica;&#13;&#10;&#13;&#10;/**&#13;&#10; * Enum con los tipos de asiento disponibles en los vuelos.&#13;&#10; */&#13;&#10;public enum TipoAsiento {&#13;&#10;    TURISTA,&#13;&#10;    EJECUTIVO&#13;&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>