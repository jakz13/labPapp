<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/Logica/ManejadorVuelo.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/Logica/ManejadorVuelo.java" />
              <option name="originalContent" value="package Logica;&#10;&#10;import DataTypes.DtVuelo;&#10;import jakarta.persistence.EntityManager;&#10;import jakarta.persistence.EntityTransaction;&#10;import jakarta.persistence.TypedQuery;&#10;import java.util.*;&#10;&#10;public class ManejadorVuelo {&#10;&#10;    private Map&lt;String, Vuelo&gt; vuelos;&#10;    public static ManejadorVuelo instancia = null;&#10;&#10;    private ManejadorVuelo() {&#10;        vuelos = new HashMap&lt;&gt;();&#10;    }&#10;&#10;    public static ManejadorVuelo getInstance() {&#10;        if (instancia == null) {&#10;            instancia = new ManejadorVuelo();&#10;        }&#10;        return instancia;&#10;    }&#10;&#10;    // =================== CRUD BD ===================&#10;    public void cargarVuelosDesdeBD(EntityManager em) {&#10;        TypedQuery&lt;Vuelo&gt; query = em.createQuery(&quot;SELECT v FROM Vuelo v LEFT JOIN FETCH v.reservasList&quot;, Vuelo.class);&#10;        List&lt;Vuelo&gt; vuelosPersistidos = query.getResultList();&#10;        for (Vuelo v : vuelosPersistidos) {&#10;            // Sincronizar el Map con las reservas cargadas&#10;            v.getReservas(); // Esto sincroniza el Map&#10;            vuelos.put(v.getNombre(), v);&#10;        }&#10;    }&#10;&#10;    // Método para uso interno (sin transacción)&#10;    public void agregarVuelo(Vuelo vuelo, EntityManager em) {&#10;        em.persist(vuelo);&#10;        vuelos.put(vuelo.getNombre(), vuelo);&#10;    }&#10;&#10;    // Método para uso externo (con transacción)&#10;    public void agregarVueloConTransaccion(Vuelo vuelo, EntityManager em) {&#10;        EntityTransaction tx = em.getTransaction();&#10;        try {&#10;            tx.begin();&#10;            em.persist(vuelo);&#10;            vuelos.put(vuelo.getNombre(), vuelo);&#10;            tx.commit();&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            throw new RuntimeException(&quot;Error al agregar el vuelo: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    // Método para uso interno (sin transacción) - usado por registrarReservaVuelo&#10;    public void actualizarVuelo(Vuelo vuelo, EntityManager em) {&#10;        em.merge(vuelo);&#10;    }&#10;&#10;    // Método para uso externo (con transacción)&#10;    public void actualizarVueloConTransaccion(Vuelo vuelo, EntityManager em) {&#10;        EntityTransaction tx = em.getTransaction();&#10;        try {&#10;            tx.begin();&#10;            em.merge(vuelo);&#10;            tx.commit();&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            throw new RuntimeException(&quot;Error al actualizar el vuelo: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    public boolean tieneReservaDeCliente(String nicknameCliente, Vuelo vuelo) {&#10;        if (vuelo == null) return false;&#10;        // Revisar lista de reservas y comparar por cliente.nickname&#10;        for (Reserva r : vuelo.getReservasList()) {&#10;            if (r.getCliente() != null &amp;&amp; r.getCliente().getNickname().equals(nicknameCliente)) {&#10;                return true;&#10;            }&#10;        }&#10;        return false;&#10;    }&#10;&#10;    public Vuelo getVuelo(String nombre) {&#10;        return vuelos.get(nombre);&#10;    }&#10;&#10;    public List&lt;Vuelo&gt; getVuelos() {&#10;        return new ArrayList&lt;&gt;(vuelos.values());&#10;    }&#10;&#10;    public List&lt;DtVuelo&gt; getDtVuelos() {&#10;        List&lt;DtVuelo&gt; dtVuelos = new ArrayList&lt;&gt;();&#10;        for (Vuelo vuelo : vuelos.values()) {&#10;            dtVuelos.add(vuelo.getDtVuelo());&#10;        }&#10;        return dtVuelos;&#10;    }&#10;&#10;    // Método para obtener vuelos por aerolínea&#10;    public List&lt;Vuelo&gt; getVuelosPorAerolinea(String nombreAerolinea) {&#10;        List&lt;Vuelo&gt; vuelosAerolinea = new ArrayList&lt;&gt;();&#10;        for (Vuelo vuelo : vuelos.values()) {&#10;            if (vuelo.getNombreAerolinea().equals(nombreAerolinea)) {&#10;                vuelosAerolinea.add(vuelo);&#10;            }&#10;        }&#10;        return vuelosAerolinea;&#10;    }&#10;&#10;    // Método para obtener vuelos por ruta&#10;    public List&lt;Vuelo&gt; getVuelosPorRuta(String nombreRuta) {&#10;        List&lt;Vuelo&gt; vuelosRuta = new ArrayList&lt;&gt;();&#10;        for (Vuelo vuelo : vuelos.values()) {&#10;            if (vuelo.getRutaVuelo() != null &amp;&amp;&#10;                    vuelo.getRutaVuelo().getNombre().equals(nombreRuta)) {&#10;                vuelosRuta.add(vuelo);&#10;            }&#10;        }&#10;        return vuelosRuta;&#10;    }&#10;&#10;    // Método para verificar si existe un vuelo&#10;    public boolean existeVuelo(String nombreVuelo) {&#10;        return vuelos.containsKey(nombreVuelo);&#10;    }&#10;&#10;    // Método para eliminar vuelo (con transacción)&#10;    public void eliminarVuelo(String nombreVuelo, EntityManager em) {&#10;        EntityTransaction tx = em.getTransaction();&#10;        try {&#10;            tx.begin();&#10;            Vuelo vuelo = vuelos.get(nombreVuelo);&#10;            if (vuelo != null) {&#10;                em.remove(vuelo);&#10;                vuelos.remove(nombreVuelo);&#10;            }&#10;            tx.commit();&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            throw new RuntimeException(&quot;Error al eliminar el vuelo: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    // Método para limpiar cache en memoria (útil para testing)&#10;    public void limpiarCache() {&#10;        vuelos.clear();&#10;    }&#10;}" />
              <option name="updatedContent" value="package Logica;&#10;&#10;import DataTypes.DtVuelo;&#10;import jakarta.persistence.EntityManager;&#10;import jakarta.persistence.EntityTransaction;&#10;import jakarta.persistence.TypedQuery;&#10;import java.util.*;&#10;&#10;public class ManejadorVuelo {&#10;&#10;    private Map&lt;String, Vuelo&gt; vuelos;&#10;    public static ManejadorVuelo instancia = null;&#10;&#10;    private ManejadorVuelo() {&#10;        vuelos = new HashMap&lt;&gt;();&#10;    }&#10;&#10;    public static ManejadorVuelo getInstance() {&#10;        if (instancia == null) {&#10;            instancia = new ManejadorVuelo();&#10;        }&#10;        return instancia;&#10;    }&#10;&#10;    // =================== CRUD BD ===================&#10;    public void cargarVuelosDesdeBD(EntityManager em) {&#10;        TypedQuery&lt;Vuelo&gt; query = em.createQuery(&quot;SELECT v FROM Vuelo v LEFT JOIN FETCH v.reservasList&quot;, Vuelo.class);&#10;        List&lt;Vuelo&gt; vuelosPersistidos = query.getResultList();&#10;        for (Vuelo v : vuelosPersistidos) {&#10;            // Sincronizar el Map con las reservas cargadas&#10;            v.getReservas(); // Esto sincroniza el Map&#10;            vuelos.put(v.getNombre(), v);&#10;        }&#10;    }&#10;&#10;    // Método para uso interno (sin transacción)&#10;    public void agregarVuelo(Vuelo vuelo, EntityManager em) {&#10;        em.persist(vuelo);&#10;        vuelos.put(vuelo.getNombre(), vuelo);&#10;    }&#10;&#10;    // Método para uso externo (con transacción)&#10;    public void agregarVueloConTransaccion(Vuelo vuelo, EntityManager em) {&#10;        EntityTransaction tx = em.getTransaction();&#10;        try {&#10;            tx.begin();&#10;            em.persist(vuelo);&#10;            vuelos.put(vuelo.getNombre(), vuelo);&#10;            tx.commit();&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            throw new RuntimeException(&quot;Error al agregar el vuelo: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    // Método para uso interno (sin transacción) - usado por registrarReservaVuelo&#10;    public void actualizarVuelo(Vuelo vuelo, EntityManager em) {&#10;        em.merge(vuelo);&#10;    }&#10;&#10;    // Método para uso externo (con transacción)&#10;    public void actualizarVueloConTransaccion(Vuelo vuelo, EntityManager em) {&#10;        EntityTransaction tx = em.getTransaction();&#10;        try {&#10;            tx.begin();&#10;            em.merge(vuelo);&#10;            tx.commit();&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            throw new RuntimeException(&quot;Error al actualizar el vuelo: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    public boolean tieneReservaDeCliente(String nicknameCliente, Vuelo vuelo) {&#10;        if (vuelo == null) return false;&#10;        // Revisar lista de reservas y comparar por cliente.nickname&#10;        for (Reserva r : vuelo.getReservasList()) {&#10;            if (r.getCliente() != null &amp;&amp; r.getCliente().getNickname().equals(nicknameCliente)) {&#10;                return true;&#10;            }&#10;        }&#10;        return false;&#10;    }&#10;&#10;    public Vuelo getVuelo(String nombre) {&#10;        return vuelos.get(nombre);&#10;    }&#10;&#10;    public List&lt;Vuelo&gt; getVuelos() {&#10;        return new ArrayList&lt;&gt;(vuelos.values());&#10;    }&#10;&#10;    public List&lt;DtVuelo&gt; getDtVuelos() {&#10;        List&lt;DtVuelo&gt; dtVuelos = new ArrayList&lt;&gt;();&#10;        for (Vuelo vuelo : vuelos.values()) {&#10;            dtVuelos.add(vuelo.getDtVuelo());&#10;        }&#10;        return dtVuelos;&#10;    }&#10;&#10;    // Método para obtener vuelos por aerolínea&#10;    public List&lt;Vuelo&gt; getVuelosPorAerolinea(String nombreAerolinea) {&#10;        List&lt;Vuelo&gt; vuelosAerolinea = new ArrayList&lt;&gt;();&#10;        for (Vuelo vuelo : vuelos.values()) {&#10;            if (vuelo.getNombreAerolinea().equals(nombreAerolinea)) {&#10;                vuelosAerolinea.add(vuelo);&#10;            }&#10;        }&#10;        return vuelosAerolinea;&#10;    }&#10;&#10;    // Método para obtener vuelos por ruta&#10;    public List&lt;Vuelo&gt; getVuelosPorRuta(String nombreRuta) {&#10;        List&lt;Vuelo&gt; vuelosRuta = new ArrayList&lt;&gt;();&#10;        for (Vuelo vuelo : vuelos.values()) {&#10;            if (vuelo.getRutaVuelo() != null &amp;&amp;&#10;                    vuelo.getRutaVuelo().getNombre().equals(nombreRuta)) {&#10;                vuelosRuta.add(vuelo);&#10;            }&#10;        }&#10;        return vuelosRuta;&#10;    }&#10;&#10;    // Método para verificar si existe un vuelo&#10;    public boolean existeVuelo(String nombreVuelo) {&#10;        return vuelos.containsKey(nombreVuelo);&#10;    }&#10;&#10;    // Método para eliminar vuelo (con transacción)&#10;    public void eliminarVuelo(String nombreVuelo, EntityManager em) {&#10;        EntityTransaction tx = em.getTransaction();&#10;        try {&#10;            tx.begin();&#10;            Vuelo vuelo = vuelos.get(nombreVuelo);&#10;            if (vuelo != null) {&#10;                em.remove(vuelo);&#10;                vuelos.remove(nombreVuelo);&#10;            }&#10;            tx.commit();&#10;        } catch (Exception e) {&#10;            if (tx.isActive()) tx.rollback();&#10;            throw new RuntimeException(&quot;Error al eliminar el vuelo: &quot; + e.getMessage(), e);&#10;        }&#10;    }&#10;&#10;    // Método para limpiar cache en memoria (útil para testing)&#10;    public void limpiarCache() {&#10;        vuelos.clear();&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/Logica/Reserva.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/ProyectoAerolineas/src/main/java/Logica/Reserva.java" />
              <option name="originalContent" value="package Logica;&#10;&#10;import DataTypes.DtPasajero;&#10;import jakarta.persistence.*;&#10;import java.time.LocalDate;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;@Entity&#10;@Table(name = &quot;reservas&quot;)&#10;public class Reserva {&#10;&#10;    @Id&#10;    @GeneratedValue(strategy = GenerationType.IDENTITY)&#10;    private Long id; //Long para auto-incremento&#10;&#10;    private LocalDate fecha;&#10;    private double costo;&#10;&#10;    @Enumerated(EnumType.STRING)&#10;    private TipoAsiento tipoAsiento;&#10;&#10;    private int cantidadPasajes;&#10;    private int unidadesEquipajeExtra;&#10;&#10;    @ManyToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE})&#10;    @JoinTable(&#10;            name = &quot;reserva_pasajeros&quot;,&#10;            joinColumns = @JoinColumn(name = &quot;reserva_id&quot;),&#10;            inverseJoinColumns = @JoinColumn(name = &quot;pasajero_id&quot;)&#10;    )&#10;    private List&lt;Pasajero&gt; pasajeros = new ArrayList&lt;&gt;();&#10;&#10;    @ManyToOne&#10;    @JoinColumn(name = &quot;vuelo_id&quot;)&#10;    private Vuelo vuelo;&#10;&#10;    // Nueva relación ManyToOne hacia Cliente para poder saber el dueño de la reserva&#10;    @ManyToOne&#10;    @JoinColumn(name = &quot;cliente_nickname&quot;, referencedColumnName = &quot;nickname&quot;)&#10;    private Cliente cliente;&#10;&#10;    public Reserva() {} // Constructor vacío para JPA&#10;&#10;    // Constructor modificado - sin ID&#10;    public Reserva(double costo, TipoAsiento tipoAsiento, int cantidadPasajes,&#10;                   int unidadesEquipajeExtra, List&lt;Pasajero&gt; pasajeros, Vuelo vuelo) {&#10;        this.fecha = LocalDate.now();&#10;        this.costo = costo;&#10;        this.tipoAsiento = tipoAsiento;&#10;        this.cantidadPasajes = cantidadPasajes;&#10;        this.unidadesEquipajeExtra = unidadesEquipajeExtra;&#10;        this.pasajeros = pasajeros;&#10;        this.vuelo = vuelo;&#10;    }&#10;&#10;    // ===== Getters y Setters =====&#10;    public Long getId() { return id; }&#10;    public void setId(Long id) { this.id = id; }&#10;    public LocalDate getFecha() { return fecha; }&#10;    public double getCosto() { return costo; }&#10;    public TipoAsiento getTipoAsiento() { return tipoAsiento; }&#10;    public int getCantidadPasajes() { return cantidadPasajes; }&#10;    public int getUnidadesEquipajeExtra() { return unidadesEquipajeExtra; }&#10;    public List&lt;Pasajero&gt; getPasajeros() { return pasajeros; }&#10;    public Vuelo getVuelo() { return vuelo; }&#10;    public void setVuelo(Vuelo vuelo) { this.vuelo = vuelo; }&#10;&#10;    public Cliente getCliente() { return cliente; }&#10;    public void setCliente(Cliente cliente) { this.cliente = cliente; }&#10;&#10;    public String toString() {&#10;        return &quot;Reserva #&quot; + id +&#10;                &quot; | Vuelo: &quot; + (vuelo != null ? vuelo.getNombre() : &quot;N/A&quot;);&#10;    }&#10;&#10;    public List&lt;DtPasajero&gt; getDtPasajeros() {&#10;        List&lt;DtPasajero&gt; dtPasajeros = new ArrayList&lt;&gt;();&#10;        for (Pasajero p : pasajeros) {&#10;            dtPasajeros.add(new DtPasajero(p.getNombre(), p.getApellido()));&#10;        }&#10;        return dtPasajeros;&#10;    }&#10;}" />
              <option name="updatedContent" value="package Logica;&#10;&#10;import DataTypes.DtPasajero;&#10;import jakarta.persistence.*;&#10;import java.time.LocalDate;&#10;import java.util.ArrayList;&#10;import java.util.List;&#10;&#10;@Entity&#10;@Table(name = &quot;reservas&quot;)&#10;public class Reserva {&#10;&#10;    @Id&#10;    @GeneratedValue(strategy = GenerationType.IDENTITY)&#10;    private Long id; //Long para auto-incremento&#10;&#10;    private LocalDate fecha;&#10;    private double costo;&#10;&#10;    @Enumerated(EnumType.STRING)&#10;    private TipoAsiento tipoAsiento;&#10;&#10;    private int cantidadPasajes;&#10;    private int unidadesEquipajeExtra;&#10;&#10;    @ManyToMany(cascade = {CascadeType.PERSIST, CascadeType.MERGE})&#10;    @JoinTable(&#10;            name = &quot;reserva_pasajeros&quot;,&#10;            joinColumns = @JoinColumn(name = &quot;reserva_id&quot;),&#10;            inverseJoinColumns = @JoinColumn(name = &quot;pasajero_id&quot;)&#10;    )&#10;    private List&lt;Pasajero&gt; pasajeros = new ArrayList&lt;&gt;();&#10;&#10;    @ManyToOne&#10;    @JoinColumn(name = &quot;vuelo_id&quot;)&#10;    private Vuelo vuelo;&#10;&#10;    // Nueva relación ManyToOne hacia Cliente para poder saber el dueño de la reserva&#10;    @ManyToOne&#10;    @JoinColumn(name = &quot;cliente_nickname&quot;, referencedColumnName = &quot;nickname&quot;)&#10;    private Cliente cliente;&#10;&#10;    public Reserva() {} // Constructor vacío para JPA&#10;&#10;    // Constructor modificado - sin ID&#10;    public Reserva(double costo, TipoAsiento tipoAsiento, int cantidadPasajes,&#10;                   int unidadesEquipajeExtra, List&lt;Pasajero&gt; pasajeros, Vuelo vuelo) {&#10;        this.fecha = LocalDate.now();&#10;        this.costo = costo;&#10;        this.tipoAsiento = tipoAsiento;&#10;        this.cantidadPasajes = cantidadPasajes;&#10;        this.unidadesEquipajeExtra = unidadesEquipajeExtra;&#10;        this.pasajeros = pasajeros;&#10;        this.vuelo = vuelo;&#10;    }&#10;&#10;    // ===== Getters y Setters =====&#10;    public Long getId() { return id; }&#10;    public void setId(Long id) { this.id = id; }&#10;    public LocalDate getFecha() { return fecha; }&#10;    public double getCosto() { return costo; }&#10;    public TipoAsiento getTipoAsiento() { return tipoAsiento; }&#10;    public int getCantidadPasajes() { return cantidadPasajes; }&#10;    public int getUnidadesEquipajeExtra() { return unidadesEquipajeExtra; }&#10;    public List&lt;Pasajero&gt; getPasajeros() { return pasajeros; }&#10;    public Vuelo getVuelo() { return vuelo; }&#10;    public void setVuelo(Vuelo vuelo) { this.vuelo = vuelo; }&#10;&#10;    public Cliente getCliente() { return cliente; }&#10;    public void setCliente(Cliente cliente) { this.cliente = cliente; }&#10;&#10;    public String toString() {&#10;        return &quot;Reserva #&quot; + id +&#10;                &quot; | Vuelo: &quot; + (vuelo != null ? vuelo.getNombre() : &quot;N/A&quot;);&#10;    }&#10;&#10;    public List&lt;DtPasajero&gt; getDtPasajeros() {&#10;        List&lt;DtPasajero&gt; dtPasajeros = new ArrayList&lt;&gt;();&#10;        for (Pasajero p : pasajeros) {&#10;            dtPasajeros.add(new DtPasajero(p.getNombre(), p.getApellido()));&#10;        }&#10;        return dtPasajeros;&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>