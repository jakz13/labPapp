<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Sistema.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MiProyectoSwing</a> &gt; <a href="index.source.html" class="el_package">Logica</a> &gt; <span class="el_source">Sistema.java</span></div><h1>Sistema.java</h1><pre class="source lang-java linenums">package Logica;

import jakarta.persistence.EntityManager;
import jakarta.persistence.EntityManagerFactory;
import jakarta.persistence.EntityTransaction;
import jakarta.persistence.Persistence;
import DataTypes.*;

import java.time.LocalDate;
import java.util.Arrays;
import java.util.List;
import java.util.ArrayList;

public class Sistema implements ISistema {

    private EntityManagerFactory emf;
    private EntityManager em;

    private ManejadorCliente manejadorCliente;
    private ManejadorAerolinea manejadorAerolinea;
    private ManejadorCiudad manejadorCiudad;
    private ManejadorRutaVuelo manejadorRutaVuelo;
    private ManejadorVuelo manejadorVuelo;
    private ManejadorPaquete manejadorPaquete;
    private ManejadorCategoria manejadorCategoria;
<span class="fc" id="L26">    private static int idReservaCounter = 0;</span>

<span class="fc" id="L28">    public Sistema() {</span>
<span class="fc" id="L29">        this.emf = Persistence.createEntityManagerFactory(&quot;LAB_PA&quot;);</span>
<span class="fc" id="L30">        this.em = emf.createEntityManager();</span>
<span class="fc" id="L31">        this.manejadorCliente = ManejadorCliente.getInstance();</span>
<span class="fc" id="L32">        this.manejadorPaquete = ManejadorPaquete.getInstance();</span>
<span class="fc" id="L33">        this.manejadorAerolinea = ManejadorAerolinea.getInstance();</span>
<span class="fc" id="L34">        this.manejadorRutaVuelo = ManejadorRutaVuelo.getInstance();</span>
<span class="fc" id="L35">        this.manejadorVuelo = ManejadorVuelo.getInstance();</span>
<span class="fc" id="L36">        this.manejadorCiudad = ManejadorCiudad.getInstance();</span>
<span class="fc" id="L37">        this.manejadorCategoria = ManejadorCategoria.getInstance();</span>

        // Precargar datos si la base está vacía

<span class="fc" id="L41">    }</span>

    @Override
    public void cargarDesdeBd() {
<span class="fc" id="L45">        manejadorCliente.cargarClientesDesdeBD(em);</span>
<span class="fc" id="L46">        manejadorAerolinea.cargarAerolineasDesdeBD(em);</span>
<span class="fc" id="L47">        manejadorCiudad.cargarCiudadesDesdeBD(em);</span>
<span class="fc" id="L48">        manejadorRutaVuelo.cargarRutasDesdeBD(em);</span>
<span class="fc" id="L49">        manejadorVuelo.cargarVuelosDesdeBD(em);</span>
<span class="fc" id="L50">        manejadorPaquete.cargarPaquetesDesdeBD(em);</span>
<span class="fc" id="L51">        manejadorCategoria.cargarCategoriasDesdeBD(em);</span>
<span class="fc" id="L52">    }</span>

    // =================== USUARIOS CON CONTRASEÑA ===================

    @Override
    public void altaCliente(String nickname, String nombre, String apellido, String correo,
                            LocalDate fechaNac, String nacionalidad, TipoDoc tipoDoc,
                            String numDoc, String password, String imagenUrl) {
<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (manejadorAerolinea.obtenerAerolinea(nickname) == null</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">                &amp;&amp; manejadorCliente.obtenerCliente(nickname) == null) {</span>
<span class="fc" id="L62">            Cliente c = new Cliente(nickname, nombre, apellido, correo, fechaNac, nacionalidad, tipoDoc, numDoc, password, imagenUrl);</span>
<span class="fc" id="L63">            manejadorCliente.agregarCliente(c, em);</span>
<span class="fc" id="L64">        } else {</span>
<span class="fc" id="L65">            throw new IllegalArgumentException(&quot;Ya existe un usuario con ese nickname&quot;);</span>
        }
<span class="fc" id="L67">    }</span>

    // Método antiguo sin contraseña (para backward compatibility si es necesario)
    public void altaCliente(String nickname, String nombre, String apellido, String correo,
                            LocalDate fechaNac, String nacionalidad, TipoDoc tipoDoc, String numDoc) {
<span class="fc" id="L72">        throw new UnsupportedOperationException(&quot;Use el método con contraseña: altaCliente(..., password)&quot;);</span>
    }

    @Override
    public void altaAerolinea(String nickname, String nombre, String descripcion,
                              String email, String sitioWeb, String password, String imagenUrl) {
<span class="fc bfc" id="L78" title="All 2 branches covered.">        if (manejadorAerolinea.obtenerAerolinea(nickname) == null</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">                &amp;&amp; manejadorCliente.obtenerCliente(nickname) == null) {</span>
<span class="fc" id="L80">            Aerolinea a = new Aerolinea(nickname, nombre, email, password, descripcion, sitioWeb, imagenUrl);</span>
<span class="fc" id="L81">            manejadorAerolinea.agregarAerolinea(a, em);</span>
<span class="fc" id="L82">        } else {</span>
<span class="fc" id="L83">            throw new IllegalArgumentException(&quot;Ya existe un usuario con ese nickname&quot;);</span>
        }
<span class="fc" id="L85">    }</span>

    // Método antiguo sin contraseña (para backward compatibility si es necesario)
    public void altaAerolinea(String nickname, String nombre, String descripcion,
                              String email, String sitioWeb) {
<span class="fc" id="L90">        throw new UnsupportedOperationException(&quot;Use el método con contraseña: altaAerolinea(..., password)&quot;);</span>
    }

    @Override
    public void actualizarPassword(String email, String nuevaPassword) {
        try {
<span class="fc" id="L96">            manejadorCliente.actualizarPassword(email, nuevaPassword, em);</span>
<span class="fc" id="L97">            return;</span>
<span class="fc" id="L98">        } catch (IllegalArgumentException e) {</span>
            // Si no es cliente, continuar
        }

        try {
<span class="fc" id="L103">            manejadorAerolinea.actualizarPassword(email, nuevaPassword, em);</span>
<span class="fc" id="L104">            return;</span>
<span class="fc" id="L105">        } catch (IllegalArgumentException e) {</span>
            // Si no es aerolínea, lanzar error
        }

<span class="fc" id="L109">        throw new IllegalArgumentException(&quot;Usuario no encontrado: &quot; + email);</span>
    }

    @Override
    public void modificarDatosClienteCompleto(String nickname, String nombre, String apellido,
                                              String nacionalidad, LocalDate fechaNacimiento, TipoDoc tipoDocumento,
                                              String numeroDocumento, String password, String imagenUrl) {
<span class="fc" id="L116">        manejadorCliente.modificarDatosClienteCompleto(nickname, nombre, apellido, nacionalidad, fechaNacimiento,</span>
                tipoDocumento, numeroDocumento, password, imagenUrl, em);
<span class="fc" id="L118">    }</span>

    @Override
    public void modificarDatosAerolineaCompleto(String nickname, String nombre, String descripcion,
                                                String sitioWeb, String password, String imagenUrl) {
<span class="fc" id="L123">        manejadorAerolinea.modificarDatosAerolineaCompleto(nickname, nombre, descripcion, sitioWeb, password, imagenUrl, em);</span>
<span class="fc" id="L124">    }</span>

    // =================== LOGIN ===================

    @Override
    public boolean verificarLogin(String email, String password) {
        // Primero buscar como cliente
<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (manejadorCliente.verificarLogin(email, password)) {</span>
<span class="fc" id="L132">            return true;</span>
        }
        // Si no es cliente, buscar como aerolínea
<span class="fc" id="L135">        return manejadorAerolinea.verificarLogin(email, password);</span>
    }

    @Override
    public String obtenerTipoUsuario(String email) {
<span class="fc bfc" id="L140" title="All 2 branches covered.">        if (manejadorCliente.obtenerClientePorEmail(email) != null) {</span>
<span class="fc" id="L141">            return &quot;CLIENTE&quot;;</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">        } else if (manejadorAerolinea.obtenerAerolineaPorEmail(email) != null) {</span>
<span class="fc" id="L143">            return &quot;AEROLINEA&quot;;</span>
        }
<span class="fc" id="L145">        return null;</span>
    }
// =================== MÉTODOS PARA IMÁGENES ===================

    @Override
    public void actualizarImagenCliente(String nickname, String imagenUrl) {
<span class="fc" id="L151">        manejadorCliente.actualizarImagenCliente(nickname, imagenUrl, em);</span>
<span class="fc" id="L152">    }</span>

    @Override
    public void actualizarImagenAerolinea(String nickname, String imagenUrl) {
<span class="fc" id="L156">        manejadorAerolinea.actualizarImagenAerolinea(nickname, imagenUrl, em);</span>
<span class="fc" id="L157">    }</span>

    @Override
    public void actualizarImagenRuta(String nombreRuta, String imagenUrl) {
<span class="fc" id="L161">        manejadorRutaVuelo.actualizarImagenRuta(nombreRuta, imagenUrl, em);</span>
<span class="fc" id="L162">    }</span>

    // Métodos para obtener URLs de imagen (si los necesitan)
    public String obtenerImagenCliente(String nickname) {
<span class="fc" id="L166">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        return cliente != null ? cliente.getImagenUrl() : null;</span>
    }

    public String obtenerImagenAerolinea(String nickname) {
<span class="fc" id="L171">        DtAerolinea aerolinea = manejadorAerolinea.getDtAerolineas().stream()</span>
<span class="fc" id="L172">                .filter(a -&gt; a.getNickname().equals(nickname))</span>
<span class="fc" id="L173">                .findFirst()</span>
<span class="fc" id="L174">                .orElse(null);</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        return aerolinea != null ? aerolinea.getImagenUrl() : null;</span>
    }

    public String obtenerImagenRuta(String nombreRuta) {
<span class="fc" id="L179">        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        return ruta != null ? ruta.getImagenUrl() : null;</span>
    }

    // ======================================


    @Override
    public List&lt;DtCliente&gt; listarClientes() {
<span class="fc" id="L188">        return manejadorCliente.getClientes();</span>
    }

    @Override
    public Cliente verInfoCliente(String nickname) {
<span class="fc" id="L193">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="fc" id="L194">        Cliente c = manejadorCliente.obtenerClientePorEmail(cliente.getEmail());</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">        if (c != null) {</span>
<span class="fc" id="L196">            return c;</span>
        } else {
<span class="fc" id="L198">            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
        }
    }

    @Override
    public DtCliente obtenerCliente(String nickname) {
<span class="fc" id="L204">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="fc" id="L205">        return cliente;</span>
    }

    @Override
    public Aerolinea verInfoAerolinea(String nickname) {
<span class="fc" id="L210">        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">        if (aerolinea != null) {</span>
<span class="fc" id="L212">            return aerolinea;</span>
        } else {
<span class="fc" id="L214">            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);</span>
        }
    }

    @Override
    public DtAerolinea obtenerAerolinea(String nickname) {
<span class="fc" id="L220">        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">        if (aerolinea == null) {</span>
<span class="fc" id="L222">            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);</span>
        }
<span class="fc" id="L224">        return new DtAerolinea(</span>
<span class="fc" id="L225">                aerolinea.getNickname(),</span>
<span class="fc" id="L226">                aerolinea.getNombre(),</span>
<span class="fc" id="L227">                aerolinea.getEmail(),</span>
<span class="fc" id="L228">                aerolinea.getDescripcion(),</span>
<span class="fc" id="L229">                aerolinea.getSitioWeb(),</span>
<span class="fc" id="L230">                aerolinea.getImagenUrl(),</span>
<span class="fc" id="L231">                aerolinea.getRutasVuelo()</span>
        );
    }

    @Override
    public List&lt;DtAerolinea&gt; listarAerolineas() {
<span class="fc" id="L237">        return manejadorAerolinea.getDtAerolineas();</span>
    }

    // --- CIUDADES ---
    @Override
    public void altaCiudad(String nombre, String pais) {
<span class="fc" id="L243">        String clave = nombre.trim().toLowerCase();</span>

<span class="fc bfc" id="L245" title="All 2 branches covered.">        if (manejadorCiudad.obtenerCiudad(clave) != null) {</span>
<span class="fc" id="L246">            throw new IllegalArgumentException(&quot;Ya existe una ciudad con el nombre: &quot; + nombre);</span>
        }

<span class="fc" id="L249">        Ciudad c = new Ciudad(nombre, pais);</span>
<span class="fc" id="L250">        manejadorCiudad.agregarCiudad(c, em);</span>
<span class="fc" id="L251">    }</span>

    @Override
    public void altaRutaVuelo(String nombre, String descripcion, String descripcionCorta, DtAerolinea aerolinea,
                              String ciudadOrigen, String ciudadDestino, String hora,
                              LocalDate fechaAlta, double costoTurista, double costoEjecutivo,
                              double costoEquipajeExtra, String[] categorias,String imagenUrl ) {

<span class="fc" id="L259">        Aerolinea aero = manejadorAerolinea.obtenerAerolinea(aerolinea.getNickname());</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">        if (aero == null) {</span>
<span class="fc" id="L261">            throw new IllegalArgumentException(&quot;No existe Aerolínea con nickname: &quot; + aerolinea.getNickname());</span>
        }

<span class="pc bpc" id="L264" title="1 of 2 branches missed.">        if (manejadorRutaVuelo.getRuta(nombre) != null) {</span>
<span class="nc" id="L265">            throw new IllegalArgumentException(&quot;Ya existe una ruta de vuelo con el nombre: &quot; + nombre);</span>
        }

<span class="fc bfc" id="L268" title="All 2 branches covered.">        if (ciudadOrigen.equalsIgnoreCase(ciudadDestino)) {</span>
<span class="fc" id="L269">            throw new IllegalArgumentException(&quot;La ciudad de origen y destino no pueden ser iguales.&quot;);</span>
        }

<span class="fc" id="L272">        List&lt;String&gt; categoriaValida = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">        for (String cat : categorias) {</span>
<span class="fc" id="L274">            Categoria c = manejadorCategoria.buscarCategorias(cat);</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">            if (c != null) {</span>
<span class="fc" id="L276">                categoriaValida.add(cat);</span>
            }
        }
<span class="fc bfc" id="L279" title="All 2 branches covered.">        if (categoriaValida.isEmpty()) {</span>
<span class="fc" id="L280">            throw new IllegalArgumentException(&quot;La ruta debe pertenecer a al menos una categoría válida.&quot;);</span>
        }

<span class="fc" id="L283">        RutaVuelo r = new RutaVuelo(nombre, descripcion, descripcionCorta, aero, ciudadOrigen, ciudadDestino,</span>
                hora, fechaAlta, costoTurista, costoEjecutivo,
                costoEquipajeExtra, categoriaValida,imagenUrl);

<span class="fc" id="L287">        manejadorRutaVuelo.agregarRutaVuelo(r, em);</span>
<span class="fc" id="L288">        manejadorAerolinea.agregarRutaVueloAAerolinea(aero.getNickname(), r, em);</span>
<span class="fc" id="L289">    }</span>

    @Override
    public List&lt;DtAerolinea&gt; obtenerAerolineasConRutasPendientes() {
<span class="fc" id="L293">        List&lt;DtAerolinea&gt; aerolineasConPendientes = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">        for (DtAerolinea aero : manejadorAerolinea.getDtAerolineas()) {</span>
<span class="fc" id="L295">            List&lt;RutaVuelo&gt; rutasPendientes = manejadorRutaVuelo.getRutasPorEstadoYAerolinea(</span>
<span class="fc" id="L296">                    aero.getNombre(), RutaVuelo.EstadoRuta.INGRESADA);</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">            if (!rutasPendientes.isEmpty()) {</span>
<span class="fc" id="L298">                aerolineasConPendientes.add(aero);</span>
            }
<span class="fc" id="L300">        }</span>
<span class="fc" id="L301">        return aerolineasConPendientes;</span>
    }

    @Override
    public List&lt;DtRutaVuelo&gt; obtenerRutasPendientesPorAerolinea(String nombreAerolinea) {
<span class="fc" id="L306">        List&lt;RutaVuelo&gt; rutasPendientes = manejadorRutaVuelo.getRutasPorEstadoYAerolinea(</span>
                nombreAerolinea, RutaVuelo.EstadoRuta.INGRESADA);

<span class="fc" id="L309">        List&lt;DtRutaVuelo&gt; dtRutasPendientes = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">        for (RutaVuelo ruta : rutasPendientes) {</span>
<span class="fc" id="L311">            dtRutasPendientes.add(ruta.getDtRutaVuelo());</span>
<span class="fc" id="L312">        }</span>
<span class="fc" id="L313">        return dtRutasPendientes;</span>
    }

    @Override
    public void aceptarRutaVuelo(String nombreRuta) {
<span class="fc" id="L318">        manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, RutaVuelo.EstadoRuta.CONFIRMADA, em);</span>
<span class="fc" id="L319">    }</span>

    @Override
    public void rechazarRutaVuelo(String nombreRuta) {
<span class="fc" id="L323">        manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, RutaVuelo.EstadoRuta.RECHAZADA, em);</span>
<span class="fc" id="L324">    }</span>

    @Override
    public RutaVuelo obtenerRuta(String nombreRuta) {
<span class="fc" id="L328">        return manejadorRutaVuelo.getRuta(nombreRuta);</span>
    }

    @Override
    public List&lt;DtRutaVuelo&gt; listarRutasPorAerolinea(String nombreAerolinea) {
<span class="fc" id="L333">        return manejadorAerolinea.obtenerRutaVueloDeAerolinea(nombreAerolinea);</span>
    }

    @Override
    public void altaVuelo(String nombreVuelo, String nombreAereolinea, String nombreRuta,
                          LocalDate fecha, int duracion, int asientosTurista,
                          int asientosEjecutivo, LocalDate fechaAlta) {

<span class="fc" id="L341">        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);</span>
<span class="fc bfc" id="L342" title="All 2 branches covered.">        if (ruta == null) {</span>
<span class="fc" id="L343">            throw new IllegalArgumentException(&quot;La ruta &quot; + nombreRuta + &quot; no existe.&quot;);</span>
        }

<span class="pc bpc" id="L346" title="1 of 2 branches missed.">        if (manejadorRutaVuelo.getVueloDeRuta(nombreRuta, nombreVuelo) != null) {</span>
<span class="nc" id="L347">            throw new IllegalArgumentException(&quot;Ya existe un vuelo con el nombre &quot; + nombreVuelo + &quot; en la ruta &quot; + nombreRuta);</span>
        }

<span class="fc" id="L350">        Vuelo vuelo = new Vuelo(nombreVuelo, nombreAereolinea, ruta, fecha, duracion,</span>
                asientosTurista, asientosEjecutivo, fechaAlta);

<span class="fc" id="L353">        manejadorVuelo.agregarVuelo(vuelo, em);</span>
<span class="fc" id="L354">        manejadorRutaVuelo.agregarVueloARuta(nombreRuta, vuelo, em);</span>
<span class="fc" id="L355">    }</span>

    public Vuelo obtenerVuelo(String nombreVuelo) {
<span class="fc" id="L358">        return manejadorVuelo.getVuelo(nombreVuelo);</span>
    }

    @Override
    public List&lt;DtVuelo&gt; listarVuelosPorRuta(String nombreRuta) {
<span class="fc" id="L363">        return manejadorRutaVuelo.obtenerVuelosPorRuta(nombreRuta);</span>
    }

    @Override
    public Vuelo verInfoVuelo(String nombreVuelo) {
<span class="fc" id="L368">        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);</span>
<span class="fc bfc" id="L369" title="All 2 branches covered.">        if (vuelo == null) {</span>
<span class="fc" id="L370">            throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);</span>
        }
<span class="fc" id="L372">        return vuelo;</span>
    }

    // --- RESERVA ---
    @Override
    public void crearYRegistrarReserva(String nicknameCliente, String nombreVuelo, LocalDate fechaReserva, double costo,
                                       TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra,
                                       List&lt;Pasajero&gt; pasajeros) {
<span class="fc" id="L380">        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);</span>
<span class="fc bfc" id="L381" title="All 2 branches covered.">        if (vuelo == null) {</span>
<span class="fc" id="L382">            throw new IllegalArgumentException(&quot;El vuelo no existe: &quot; + nombreVuelo);</span>
        }

<span class="pc bpc" id="L385" title="1 of 2 branches missed.">        if (vuelo.getReservas().containsKey(nicknameCliente)) {</span>
<span class="fc" id="L386">            throw new IllegalArgumentException(</span>
                    &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo +
                            &quot;. Debe elegir otro vuelo o ruta.&quot;
            );
        }

<span class="nc" id="L392">        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">        if (cliente != null) {</span>
<span class="nc bnc" id="L394" title="All 2 branches missed.">            for (DtReserva r : cliente.getReservas()) {</span>
<span class="nc bnc" id="L395" title="All 2 branches missed.">                if (r.getVuelo().equals(nombreVuelo)) {</span>
<span class="nc" id="L396">                    throw new IllegalArgumentException(</span>
                            &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo + &quot;.&quot;
                    );
                }
<span class="nc" id="L400">            }</span>
        }

        // CREAR RESERVA SIN ID - se generará automáticamente
<span class="nc" id="L404">        Reserva reserva = new Reserva(</span>
                costo, tipoAsiento, cantidadPasajes, unidadesEquipajeExtra, pasajeros, vuelo
        );

<span class="nc" id="L408">        registrarReservaVuelo(nicknameCliente, nombreVuelo, reserva);</span>
<span class="nc" id="L409">    }</span>

    @Override
    public void registrarReservaVuelo(String nicknameCliente, String nombreVuelo, Reserva reserva) {
<span class="fc" id="L413">        EntityTransaction tx = em.getTransaction();</span>
        try {
<span class="fc" id="L415">            tx.begin();</span>

<span class="fc" id="L417">            DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);</span>
<span class="fc" id="L418">            Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);</span>

<span class="fc bfc" id="L420" title="All 2 branches covered.">            if (cliente == null) {</span>
<span class="fc" id="L421">                throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
            }
<span class="fc bfc" id="L423" title="All 2 branches covered.">            if (vuelo == null) {</span>
<span class="fc" id="L424">                throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);</span>
            }

<span class="pc bpc" id="L427" title="1 of 2 branches missed.">            if (manejadorVuelo.tieneReservaDeCliente(nicknameCliente, vuelo)) {</span>
<span class="nc" id="L428">                throw new IllegalArgumentException(&quot;El cliente ya tiene una reserva para este vuelo&quot;);</span>
            }

            // Persistir reserva para generar ID automático
<span class="fc" id="L432">            em.persist(reserva);</span>
<span class="fc" id="L433">            em.flush(); // Forzar generación del ID</span>

            // Agregar reserva al vuelo y al cliente
<span class="fc" id="L436">            vuelo.agregarReserva(reserva);</span>
<span class="fc" id="L437">            manejadorCliente.agregarReserva(reserva, nicknameCliente, reserva.getId(), em);</span>
<span class="fc" id="L438">            manejadorVuelo.actualizarVuelo(vuelo, em); // Ahora sin transacción interna</span>

<span class="fc" id="L440">            tx.commit();</span>

<span class="fc" id="L442">        } catch (Exception e) {</span>
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">            if (tx.isActive()) {</span>
<span class="fc" id="L444">                tx.rollback();</span>
            }
<span class="fc" id="L446">            throw new RuntimeException(&quot;Error al registrar reserva: &quot; + e.getMessage(), e);</span>
<span class="fc" id="L447">        }</span>
<span class="fc" id="L448">    }</span>

    @Override
    public DtReserva obtenerReserva(Long idReserva, String nicknameCliente) { // Cambiado a Long
<span class="fc" id="L452">        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);</span>
        try {
<span class="fc bfc" id="L454" title="All 2 branches covered.">            if (cliente == null) {</span>
<span class="fc" id="L455">                throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
            }
<span class="pc bpc" id="L457" title="1 of 2 branches missed.">            for (DtReserva r : cliente.getReservas()) {</span>
<span class="pc bpc" id="L458" title="1 of 2 branches missed.">                if (r.getId().equals(idReserva)) {</span>
<span class="fc" id="L459">                    return r;</span>
                }
<span class="nc" id="L461">            }</span>
<span class="nc" id="L462">            throw new IllegalArgumentException(&quot;Reserva no encontrada&quot;);</span>
<span class="fc" id="L463">        } catch (Exception e) {</span>
<span class="fc" id="L464">            throw new IllegalArgumentException(&quot;Error al obtener la reserva: &quot; + e.getMessage());</span>
        }
    }

    // --- PAQUETES ---
    @Override
    public void altaPaquete(String nombre, String descripcion, int descuentoPorc, int periodoValidezDias) {
<span class="pc bpc" id="L471" title="1 of 2 branches missed.">        if (manejadorPaquete.obtenerPaquete(nombre) != null) {</span>
<span class="nc" id="L472">            throw new IllegalArgumentException(&quot;Ya existe un paquete con el nombre: &quot; + nombre);</span>
        }

<span class="pc bpc" id="L475" title="1 of 4 branches missed.">        if (nombre == null || nombre.trim().isEmpty()) {</span>
<span class="fc" id="L476">            throw new IllegalArgumentException(&quot;El nombre del paquete no puede estar vacío.&quot;);</span>
        }
<span class="fc bfc" id="L478" title="All 4 branches covered.">        if (descuentoPorc &lt; 0 || descuentoPorc &gt; 100) {</span>
<span class="fc" id="L479">            throw new IllegalArgumentException(&quot;El descuento debe estar entre 0 y 100 por ciento.&quot;);</span>
        }
<span class="fc bfc" id="L481" title="All 2 branches covered.">        if (periodoValidezDias &lt; 0) {</span>
<span class="fc" id="L482">            throw new IllegalArgumentException(&quot;El período de validez no puede ser negativo.&quot;);</span>
        }

<span class="fc" id="L485">        Paquete p = new Paquete(nombre.trim(), descripcion, descuentoPorc, periodoValidezDias);</span>
<span class="fc" id="L486">        manejadorPaquete.agregarPaquete(p, em);</span>
<span class="fc" id="L487">    }</span>

    @Override
    public List&lt;DtPaquete&gt; listarPaquetes() {
<span class="fc" id="L491">        return (List&lt;DtPaquete&gt;) manejadorPaquete.getPaquetes();</span>
    }

    @Override
    public void modificarDatosDeCliente(String nickname, String nombre, String apellido, String nacionalidad, LocalDate fechaNacimiento, TipoDoc tipoDoc, String numeroDocumento) {
<span class="fc" id="L496">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="pc bpc" id="L497" title="1 of 2 branches missed.">        if (cliente != null) {</span>
<span class="fc" id="L498">            cliente.setApellido(apellido);</span>
<span class="fc" id="L499">            cliente.setNombre(nombre);</span>
<span class="fc" id="L500">            cliente.setNacionalidad(nacionalidad);</span>
<span class="fc" id="L501">            cliente.setFechaNacimiento(fechaNacimiento);</span>
<span class="fc" id="L502">            cliente.setTipoDocumento(tipoDoc);</span>
<span class="fc" id="L503">            cliente.setNumeroDocumento(numeroDocumento);</span>
<span class="fc" id="L504">            manejadorCliente.modificarDatosCliente(cliente, em);</span>
        } else {
<span class="nc" id="L506">            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
        }
<span class="fc" id="L508">    }</span>

    @Override
    public void modificarDatosAerolinea(String nickname, String Descripcion, String URL) {
<span class="fc" id="L512">        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);</span>
<span class="fc bfc" id="L513" title="All 2 branches covered.">        if (aerolinea != null) {</span>
<span class="fc" id="L514">            aerolinea.setDescripcion(Descripcion);</span>
<span class="fc" id="L515">            aerolinea.setSitioWeb(URL);</span>
<span class="fc" id="L516">            manejadorAerolinea.modificarDatosAerolinea(aerolinea, em);</span>
        } else {
<span class="fc" id="L518">            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);</span>
        }
<span class="fc" id="L520">    }</span>

    @Override
    public List&lt;DtPaquete&gt; listarPaquetesDisp() {
<span class="fc" id="L524">        return manejadorPaquete.getPaquetesDisp();</span>
    }

    @Override
    public double calcularCostoReserva(String nombreVuelo, TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra) {
<span class="fc" id="L529">        ManejadorVuelo manejadorVuelo = ManejadorVuelo.getInstance();</span>
<span class="fc" id="L530">        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);</span>

<span class="fc bfc" id="L532" title="All 2 branches covered.">        if (vuelo == null) {</span>
<span class="fc" id="L533">            throw new IllegalArgumentException(&quot;Vuelo no encontrado: &quot; + nombreVuelo);</span>
        }

        double costoBase;
<span class="fc bfc" id="L537" title="All 2 branches covered.">        if (tipoAsiento == TipoAsiento.TURISTA) {</span>
<span class="fc" id="L538">            costoBase = 100.0;</span>
        } else {
<span class="fc" id="L540">            costoBase = 200.0;</span>
        }

<span class="fc" id="L543">        double costoPasajes = costoBase * cantidadPasajes;</span>
<span class="fc" id="L544">        double costoEquipaje = 30.0 * unidadesEquipajeExtra;</span>

<span class="fc" id="L546">        return costoPasajes + costoEquipaje;</span>
    }

    @Override
    public Pasajero crearPasajero(String nombre, String apellido) {
<span class="pc bpc" id="L551" title="1 of 4 branches missed.">        if (nombre == null || nombre.trim().isEmpty()) {</span>
<span class="fc" id="L552">            throw new IllegalArgumentException(&quot;El nombre del pasajero no puede estar vacío.&quot;);</span>
        }
<span class="pc bpc" id="L554" title="1 of 4 branches missed.">        if (apellido == null || apellido.trim().isEmpty()) {</span>
<span class="fc" id="L555">            throw new IllegalArgumentException(&quot;El apellido del pasajero no puede estar vacío.&quot;);</span>
        }
<span class="fc" id="L557">        return new Pasajero(nombre.trim(), apellido.trim());</span>
    }

    @Override
    public void compraPaquete(String nomPaquete, String nomCliente, int validezDias, LocalDate fechaC, double costo) {
<span class="fc" id="L562">        Paquete p = manejadorPaquete.obtenerPaquete(nomPaquete);</span>
<span class="fc bfc" id="L563" title="All 2 branches covered.">        if (p == null) {</span>
<span class="fc" id="L564">            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);</span>
        }

<span class="fc" id="L567">        DtCliente c = manejadorCliente.obtenerCliente(nomCliente);</span>
<span class="fc bfc" id="L568" title="All 2 branches covered.">        if (c == null) {</span>
<span class="fc" id="L569">            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
        }

<span class="fc bfc" id="L572" title="All 2 branches covered.">        for (CompraPaqLogica cp : p.getCompras()) {</span>
<span class="pc bpc" id="L573" title="1 of 2 branches missed.">            if (cp.getCliente().getNickname().equals(c.getNickname())) {</span>
<span class="fc" id="L574">                throw new IllegalArgumentException(&quot;Error, el cliente &quot; + c.getNombre() + &quot; ya compró el paquete &quot; + p.getNombre() + &quot;. Elija otro o cancele.&quot;);</span>
            }
<span class="nc" id="L576">        }</span>

        try {
<span class="fc" id="L579">            manejadorPaquete.compraPaquete(p, c, validezDias, fechaC, costo, em);</span>
<span class="fc" id="L580">            System.out.println(&quot;Paquete comprado correctamente.&quot;);</span>
<span class="nc" id="L581">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L582">            System.out.println(&quot;ERROR.&quot;);</span>
<span class="fc" id="L583">        }</span>
<span class="fc" id="L584">    }</span>

    @Override
    public void altaCategoria(String nomCat) {
<span class="fc" id="L588">        Categoria cat = manejadorCategoria.buscarCategorias(nomCat);</span>
<span class="fc bfc" id="L589" title="All 2 branches covered.">        if (cat != null) {</span>
<span class="fc" id="L590">            throw new IllegalArgumentException(&quot;Error, la categoria ya existe.&quot;);</span>
        }

        try {
<span class="fc" id="L594">            Categoria c = new Categoria(nomCat);</span>
<span class="fc" id="L595">            manejadorCategoria.agregarCategoria(c, em);</span>
<span class="fc" id="L596">            System.out.println(&quot;Categoria creada correctamente.&quot;);</span>
<span class="nc" id="L597">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L598">            System.out.println(&quot;ERROR.&quot;);</span>
<span class="fc" id="L599">        }</span>
<span class="fc" id="L600">    }</span>

    @Override
    public List&lt;Object&gt; obtenerDatosAdicionalesUsuario(String nickname) {
<span class="fc" id="L604">        List&lt;Object&gt; adicionales = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L605">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="fc bfc" id="L606" title="All 2 branches covered.">        if (cliente != null) {</span>
<span class="fc" id="L607">            adicionales.addAll(cliente.getReservas());</span>
<span class="fc" id="L608">            adicionales.addAll(cliente.getPaquetesComprados());</span>
<span class="fc" id="L609">            return adicionales;</span>
        }
<span class="fc" id="L611">        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);</span>
<span class="pc bpc" id="L612" title="1 of 2 branches missed.">        if (aerolinea != null) {</span>
<span class="fc" id="L613">            adicionales.addAll(aerolinea.getRutasVuelo());</span>
<span class="fc" id="L614">            return adicionales;</span>
        }
<span class="nc" id="L616">        return adicionales;</span>
    }

    @Override
    public List&lt;DtCiudad&gt; listarCiudades() {
<span class="fc" id="L621">        List&lt;DtCiudad&gt; dtCiudades = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L622" title="All 2 branches covered.">        for (Ciudad ciudad : manejadorCiudad.getCiudades()) {</span>
<span class="fc" id="L623">            dtCiudades.add(new DtCiudad(ciudad.getNombre(), ciudad.getPais()));</span>
<span class="fc" id="L624">        }</span>
<span class="fc" id="L625">        return dtCiudades;</span>
    }

    @Override
    public List&lt;DtCategoria&gt; listarCategorias() {
<span class="fc" id="L630">        List&lt;DtCategoria&gt; lista = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L631" title="All 2 branches covered.">        for (Categoria c : manejadorCategoria.getCategorias().values()) {</span>
<span class="fc" id="L632">            lista.add(new DtCategoria(c.getNombre()));</span>
<span class="fc" id="L633">        }</span>
<span class="fc" id="L634">        return lista;</span>
    }

    @Override
    public void altaRutaPaquete(String nombrePaquete, String nomRuta, int cantidadAsientos, TipoAsiento tipoAsiento) {
<span class="fc" id="L639">        Paquete p = manejadorPaquete.obtenerPaquete(nombrePaquete);</span>
<span class="fc bfc" id="L640" title="All 2 branches covered.">        if (p == null) {</span>
<span class="fc" id="L641">            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);</span>
        }

<span class="fc bfc" id="L644" title="All 2 branches covered.">        if (p.estaComprado()) {</span>
<span class="fc" id="L645">            throw new IllegalArgumentException(&quot;No se pueden agregar rutas a un paquete que ya ha sido comprado.&quot;);</span>
        }

<span class="fc" id="L648">        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nomRuta);</span>
<span class="pc bpc" id="L649" title="1 of 2 branches missed.">        if (ruta == null) {</span>
<span class="nc" id="L650">            throw new IllegalArgumentException(&quot;No se encontró la ruta con ese nombre.&quot;);</span>
        }

<span class="pc bpc" id="L653" title="1 of 2 branches missed.">        if (ruta.getEstado() != RutaVuelo.EstadoRuta.CONFIRMADA) {</span>
<span class="nc" id="L654">            throw new IllegalArgumentException(&quot;No se puede agregar una ruta que no esté CONFIRMADA al paquete. Ruta actual: &quot; + ruta.getEstado());</span>
        }

<span class="fc" id="L657">        manejadorPaquete.agregarRutaAPaquete(p, ruta, cantidadAsientos, tipoAsiento, em);</span>

<span class="fc" id="L659">        DtPaquete dtPaquete = obtenerDtPaquete(nombrePaquete);</span>
<span class="pc bpc" id="L660" title="1 of 2 branches missed.">        if (dtPaquete != null) {</span>
<span class="fc" id="L661">            DtRutaVuelo dtRuta = ruta.getDtRutaVuelo();</span>
<span class="fc" id="L662">            DtItemPaquete dtItem = new DtItemPaquete(dtRuta, cantidadAsientos, tipoAsiento.toString());</span>
<span class="fc" id="L663">            dtPaquete.getItems().add(dtItem);</span>
        }

<span class="fc" id="L666">        System.out.println(&quot;Ruta agregada al paquete correctamente.&quot;);</span>
<span class="fc" id="L667">    }</span>

    @Override
    public Paquete obtenerPaquete(String nombrePaquete) {
<span class="fc" id="L671">        Paquete paquete = manejadorPaquete.obtenerPaquete(nombrePaquete);</span>
<span class="fc bfc" id="L672" title="All 2 branches covered.">        if (paquete == null) {</span>
<span class="fc" id="L673">            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);</span>
        }
<span class="fc" id="L675">        return paquete;</span>
    }

    @Override
    public DtPaquete obtenerDtPaquete(String nombrePaquete) {
<span class="fc" id="L680">        DtPaquete paquete = manejadorPaquete.obtenerDtPaquete(nombrePaquete);</span>
<span class="fc bfc" id="L681" title="All 2 branches covered.">        if (paquete == null) {</span>
<span class="fc" id="L682">            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);</span>
        }
<span class="fc" id="L684">        return paquete;</span>
    }

    @Override
    public List&lt;DtAerolinea&gt; getAerolineas() {
<span class="nc" id="L689">        return manejadorAerolinea.getDtAerolineas();</span>
    }

    @Override
    public List&lt;DtPaquete&gt; getPaquetesDisp() {
<span class="nc" id="L694">        return manejadorPaquete.getPaquetes();</span>
    }

    @Override
    public List&lt;DtCliente&gt; getClientes() {
<span class="nc" id="L699">        return manejadorCliente.getClientes();</span>
    }

    @Override
    public List&lt;DtReserva&gt; getReservasCliente(String nickname) {
<span class="fc" id="L704">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="fc bfc" id="L705" title="All 2 branches covered.">        if (cliente != null) {</span>
<span class="fc" id="L706">            return cliente.getReservas();</span>
        } else {
<span class="fc" id="L708">            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
        }
    }

    @Override
    public List&lt;DtItemPaquete&gt; getDtItemRutasPaquete(String nombrePaquete) {
<span class="fc" id="L714">        List&lt;DtItemPaquete&gt; items = manejadorPaquete.obtenerDtItemsPaquete(nombrePaquete);</span>
<span class="pc bpc" id="L715" title="1 of 4 branches missed.">        if (items != null &amp;&amp; !items.isEmpty()) {</span>
<span class="fc" id="L716">            return items;</span>
        } else {
<span class="fc" id="L718">            throw new IllegalArgumentException(&quot;Paquete no encontrado o sin rutas asociadas&quot;);</span>
        }
    }


}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>