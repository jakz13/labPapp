<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Sistema.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MiProyectoSwing</a> &gt; <a href="index.source.html" class="el_package">logica</a> &gt; <span class="el_source">Sistema.java</span></div><h1>Sistema.java</h1><pre class="source lang-java linenums">package logica;

import jakarta.persistence.EntityManager;
import jakarta.persistence.EntityManagerFactory;
import jakarta.persistence.EntityTransaction;
import jakarta.persistence.Persistence;
import jakarta.persistence.PersistenceException;

import DataTypes.DtCliente;
import DataTypes.DtAerolinea;
import DataTypes.DtCiudad;
import DataTypes.DtCategoria;
import DataTypes.DtVuelo;
import DataTypes.DtReserva;
import DataTypes.DtPaquete;
import DataTypes.DtRutaVuelo;
import DataTypes.DtItemPaquete;


import java.time.LocalDate;
import java.util.List;
import java.util.ArrayList;

import java.util.logging.Level;
import java.util.logging.Logger;

/**
 * Implementación de la interfaz ISistema que actúa como fachada para la
 * lógica de negocio. Maneja inicialización, operaciones CRUD y coordinación
 * entre los manejadores (clientes, aerolíneas, rutas, vuelos, paquetes, etc.).
 */
public class Sistema implements ISistema {

<span class="fc" id="L34">    private static final Logger LOGGER = Logger.getLogger(Sistema.class.getName());</span>

    private EntityManagerFactory emf;
    private EntityManager entManager;

    private ManejadorCliente manejadorCliente;
    private ManejadorAerolinea manejadorAerolinea;
    private ManejadorCiudad manejadorCiudad;
    private ManejadorRutaVuelo manejadorRutaVuelo;
    private ManejadorVuelo manejadorVuelo;
    private ManejadorPaquete manejadorPaquete;
    private ManejadorCategoria manejadorCategoria;

<span class="fc" id="L47">    public Sistema() {</span>
<span class="fc" id="L48">        this.emf = Persistence.createEntityManagerFactory(&quot;LAB_PA&quot;);</span>
<span class="fc" id="L49">        this.entManager = emf.createEntityManager();</span>
<span class="fc" id="L50">        this.manejadorCliente = ManejadorCliente.getInstance();</span>
<span class="fc" id="L51">        this.manejadorPaquete = ManejadorPaquete.getInstance();</span>
<span class="fc" id="L52">        this.manejadorAerolinea = ManejadorAerolinea.getInstance();</span>
<span class="fc" id="L53">        this.manejadorRutaVuelo = ManejadorRutaVuelo.getInstance();</span>
<span class="fc" id="L54">        this.manejadorVuelo = ManejadorVuelo.getInstance();</span>
<span class="fc" id="L55">        this.manejadorCiudad = ManejadorCiudad.getInstance();</span>
<span class="fc" id="L56">        this.manejadorCategoria = ManejadorCategoria.getInstance();</span>

        // Precargar datos si la base está vacía

<span class="fc" id="L60">    }</span>

    /** Carga todos los datos desde la base de datos a los manejadores en memoria. */
    @Override
    public void cargarDesdeBd() {
<span class="fc" id="L65">        manejadorCliente.cargarClientesDesdeBD(entManager);</span>
<span class="fc" id="L66">        manejadorAerolinea.cargarAerolineasDesdeBD(entManager);</span>
<span class="fc" id="L67">        manejadorCiudad.cargarCiudadesDesdeBD(entManager);</span>
<span class="fc" id="L68">        manejadorRutaVuelo.cargarRutasDesdeBD(entManager);</span>
<span class="fc" id="L69">        manejadorVuelo.cargarVuelosDesdeBD(entManager);</span>
<span class="fc" id="L70">        manejadorPaquete.cargarPaquetesDesdeBD(entManager);</span>
<span class="fc" id="L71">        manejadorCategoria.cargarCategoriasDesdeBD(entManager);</span>
<span class="fc" id="L72">    }</span>

    // =================== USUARIOS CON CONTRASEÑA ===================

    /**
     * Alta de cliente con contraseña. Valida unicidad y persiste el cliente.
     */
    @Override
    public void altaCliente(String nickname, String nombre, String apellido, String correo,
                            LocalDate fechaNac, String nacionalidad, TipoDoc tipoDoc,
                            String numDoc, String password, String imagenUrl) {
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (manejadorAerolinea.obtenerAerolinea(nickname) == null</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">                &amp;&amp; manejadorCliente.obtenerCliente(nickname) == null) {</span>
<span class="fc" id="L85">            Cliente cliente = new Cliente(nickname, nombre, apellido, correo, fechaNac, nacionalidad, tipoDoc, numDoc, password, imagenUrl);</span>
<span class="fc" id="L86">            manejadorCliente.agregarCliente(cliente, entManager);</span>
<span class="fc" id="L87">        } else {</span>
<span class="fc" id="L88">            throw new IllegalArgumentException(&quot;Ya existe un usuario con ese nickname&quot;);</span>
        }
<span class="fc" id="L90">    }</span>

    /** Método de compatibilidad: indica que se debe usar la versión con contraseña. */
    public void altaCliente(String nickname, String nombre, String apellido, String correo,
                            LocalDate fechaNac, String nacionalidad, TipoDoc tipoDoc, String numDoc) {
<span class="fc" id="L95">        throw new UnsupportedOperationException(&quot;Use el método con contraseña: altaCliente(..., password)&quot;);</span>
    }

    /** Alta de aerolínea con contraseña y persistencia. */
    @Override
    public void altaAerolinea(String nickname, String nombre, String descripcion,
                              String email, String sitioWeb, String password, String imagenUrl) {
<span class="fc bfc" id="L102" title="All 2 branches covered.">        if (manejadorAerolinea.obtenerAerolinea(nickname) == null</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">                &amp;&amp; manejadorCliente.obtenerCliente(nickname) == null) {</span>
<span class="fc" id="L104">            Aerolinea aerolinea = new Aerolinea(nickname, nombre, email, password, descripcion, sitioWeb, imagenUrl);</span>
<span class="fc" id="L105">            manejadorAerolinea.agregarAerolinea(aerolinea, entManager);</span>
<span class="fc" id="L106">        } else {</span>
<span class="fc" id="L107">            throw new IllegalArgumentException(&quot;Ya existe un usuario con ese nickname&quot;);</span>
        }
<span class="fc" id="L109">    }</span>

    /** Método de compatibilidad para alta de aerolínea sin contraseña (no soportado). */
    public void altaAerolinea(String nickname, String nombre, String descripcion,
                              String email, String sitioWeb) {
<span class="fc" id="L114">        throw new UnsupportedOperationException(&quot;Use el método con contraseña: altaAerolinea(..., password)&quot;);</span>
    }

    /**
     * Actualiza la contraseña de un usuario (cliente o aerolínea) identificado por email.
     */
    @Override
    public void actualizarPassword(String email, String nuevaPassword) {
        try {
<span class="fc" id="L123">            manejadorCliente.actualizarPassword(email, nuevaPassword, entManager);</span>
<span class="fc" id="L124">            LOGGER.info(() -&gt; &quot;Contraseña actualizada para cliente: &quot; + email);</span>
<span class="fc" id="L125">            return;</span>
<span class="fc" id="L126">        } catch (IllegalArgumentException e) {</span>
            // Si no es cliente, continuar
<span class="pc" id="L128">            LOGGER.log(Level.FINE, () -&gt; &quot;El usuario con email &quot; + email + &quot; no es un cliente. Intentando con aerolínea...&quot;);</span>
        }

        try {
<span class="fc" id="L132">            manejadorAerolinea.actualizarPassword(email, nuevaPassword, entManager);</span>
<span class="fc" id="L133">            LOGGER.info(() -&gt; &quot;Contraseña actualizada para aerolínea: &quot; + email);</span>
<span class="fc" id="L134">            return;</span>
<span class="fc" id="L135">        } catch (IllegalArgumentException e) {</span>
            // Si no es aerolínea, lanzar error
<span class="pc" id="L137">            LOGGER.log(Level.FINE, () -&gt; &quot;El usuario con email &quot; + email + &quot; no es una aerolínea.&quot;);</span>
        }
<span class="fc" id="L139">        throw new IllegalArgumentException(&quot;Usuario no encontrado: &quot; + email);</span>
    }

    /** Modifica los datos completos de un cliente y persiste los cambios. */
    @Override
    public void modificarDatosClienteCompleto(String nickname, String nombre, String apellido,
                                              String nacionalidad, LocalDate fechaNacimiento, TipoDoc tipoDocumento,
                                              String numeroDocumento, String password, String imagenUrl) {
<span class="fc" id="L147">        manejadorCliente.modificarDatosClienteCompleto(nickname, nombre, apellido, nacionalidad, fechaNacimiento,</span>
                tipoDocumento, numeroDocumento, password, imagenUrl, entManager);
<span class="fc" id="L149">    }</span>

    /** Modifica los datos completos de una aerolínea y persiste los cambios. */
    @Override
    public void modificarDatosAerolineaCompleto(String nickname, String nombre, String descripcion,
                                                String sitioWeb, String password, String imagenUrl) {
<span class="fc" id="L155">        manejadorAerolinea.modificarDatosAerolineaCompleto(nickname, nombre, descripcion, sitioWeb, password, imagenUrl, entManager);</span>
<span class="fc" id="L156">    }</span>

    // =================== LOGIN ===================

    /** Verifica credenciales buscando primero en clientes y luego en aerolíneas. */
    @Override
    public boolean verificarLogin(String email, String password) {
        // Primero buscar como cliente
<span class="fc bfc" id="L164" title="All 2 branches covered.">        if (manejadorCliente.verificarLogin(email, password)) {</span>
<span class="fc" id="L165">            return true;</span>
        }
        // Si no es cliente, buscar como aerolínea
<span class="fc" id="L168">        return manejadorAerolinea.verificarLogin(email, password);</span>
    }

    /** Devuelve el tipo de usuario ('CLIENTE' o 'AEROLINEA') según el email. */
    @Override
    public String obtenerTipoUsuario(String email) {
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (manejadorCliente.obtenerClientePorEmail(email) != null) {</span>
<span class="fc" id="L175">            return &quot;CLIENTE&quot;;</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">        } else if (manejadorAerolinea.obtenerAerolineaPorEmail(email) != null) {</span>
<span class="fc" id="L177">            return &quot;AEROLINEA&quot;;</span>
        }
<span class="fc" id="L179">        return null;</span>
    }
// =================== MÉTODOS PARA IMÁGENES ===================

    /** Actualiza la URL de la imagen de un cliente. */
    @Override
    public void actualizarImagenCliente(String nickname, String imagenUrl) {
<span class="fc" id="L186">        manejadorCliente.actualizarImagenCliente(nickname, imagenUrl, entManager);</span>
<span class="fc" id="L187">    }</span>

    /** Actualiza la URL de la imagen de una aerolínea. */
    @Override
    public void actualizarImagenAerolinea(String nickname, String imagenUrl) {
<span class="fc" id="L192">        manejadorAerolinea.actualizarImagenAerolinea(nickname, imagenUrl, entManager);</span>
<span class="fc" id="L193">    }</span>

    /** Actualiza la imagen de una ruta y persiste el cambio. */
    @Override
    public void actualizarImagenRuta(String nombreRuta, String imagenUrl) {
<span class="fc" id="L198">        manejadorRutaVuelo.actualizarImagenRuta(nombreRuta, imagenUrl, entManager);</span>
<span class="fc" id="L199">    }</span>

    // Métodos para obtener URLs de imagen (si los necesitan)
    public String obtenerImagenCliente(String nickname) {
<span class="fc" id="L203">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        return cliente != null ? cliente.getImagenUrl() : null;</span>
    }

    public String obtenerImagenAerolinea(String nickname) {
<span class="fc" id="L208">        DtAerolinea aerolinea = manejadorAerolinea.getDtAerolineas().stream()</span>
<span class="fc" id="L209">                .filter(a -&gt; a.getNickname().equals(nickname))</span>
<span class="fc" id="L210">                .findFirst()</span>
<span class="fc" id="L211">                .orElse(null);</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">        return aerolinea != null ? aerolinea.getImagenUrl() : null;</span>
    }

    public String obtenerImagenRuta(String nombreRuta) {
<span class="fc" id="L216">        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">        return ruta != null ? ruta.getImagenUrl() : null;</span>
    }

    // ======================================


    @Override
    public List&lt;DtCliente&gt; listarClientes() {
<span class="fc" id="L225">        return manejadorCliente.getClientes();</span>
    }

    @Override
    public Cliente verInfoCliente(String nickname) {
<span class="fc" id="L230">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="fc" id="L231">        Cliente cliente1 = manejadorCliente.obtenerClientePorEmail(cliente.getEmail());</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (cliente1 != null) {</span>
<span class="fc" id="L233">            return cliente1;</span>
        } else {
<span class="fc" id="L235">            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
        }
    }

    @Override
    public DtCliente obtenerCliente(String nickname) {
<span class="fc" id="L241">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="fc" id="L242">        return cliente;</span>
    }

    @Override
    public Aerolinea verInfoAerolinea(String nickname) {
<span class="fc" id="L247">        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);</span>
<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (aerolinea != null) {</span>
<span class="fc" id="L249">            return aerolinea;</span>
        } else {
<span class="fc" id="L251">            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);</span>
        }
    }

    @Override
    public DtAerolinea obtenerAerolinea(String nickname) {
<span class="fc" id="L257">        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">        if (aerolinea == null) {</span>
<span class="fc" id="L259">            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);</span>
        }
<span class="fc" id="L261">        return new DtAerolinea(</span>
<span class="fc" id="L262">                aerolinea.getNickname(),</span>
<span class="fc" id="L263">                aerolinea.getNombre(),</span>
<span class="fc" id="L264">                aerolinea.getEmail(),</span>
<span class="fc" id="L265">                aerolinea.getDescripcion(),</span>
<span class="fc" id="L266">                aerolinea.getSitioWeb(),</span>
<span class="fc" id="L267">                aerolinea.getImagenUrl(),</span>
<span class="fc" id="L268">                aerolinea.getRutasVuelo()</span>
        );
    }

    @Override
    public List&lt;DtAerolinea&gt; listarAerolineas() {
<span class="fc" id="L274">        return manejadorAerolinea.getDtAerolineas();</span>
    }

    // --- CIUDADES ---
    @Override
    public void altaCiudad(String nombre, String pais) {
<span class="fc" id="L280">        String clave = nombre.trim().toLowerCase();</span>

<span class="fc bfc" id="L282" title="All 2 branches covered.">        if (manejadorCiudad.obtenerCiudad(clave) != null) {</span>
<span class="fc" id="L283">            throw new IllegalArgumentException(&quot;Ya existe una ciudad con el nombre: &quot; + nombre);</span>
        }

<span class="fc" id="L286">        Ciudad ciudad = new Ciudad(nombre, pais);</span>
<span class="fc" id="L287">        manejadorCiudad.agregarCiudad(ciudad, entManager);</span>
<span class="fc" id="L288">    }</span>

    @Override
    public void altaRutaVuelo(String nombre, String descripcion, String descripcionCorta, DtAerolinea aerolinea,
                              String ciudadOrigen, String ciudadDestino, String hora,
                              LocalDate fechaAlta, double costoTurista, double costoEjecutivo,
                              double costoEquipajeExtra, String[] categorias, String imagenUrl ) {

<span class="fc" id="L296">        Aerolinea aero = manejadorAerolinea.obtenerAerolinea(aerolinea.getNickname());</span>
<span class="fc bfc" id="L297" title="All 2 branches covered.">        if (aero == null) {</span>
<span class="fc" id="L298">            throw new IllegalArgumentException(&quot;No existe Aerolínea con nickname: &quot; + aerolinea.getNickname());</span>
        }

<span class="pc bpc" id="L301" title="1 of 2 branches missed.">        if (manejadorRutaVuelo.getRuta(nombre) != null) {</span>
<span class="nc" id="L302">            throw new IllegalArgumentException(&quot;Ya existe una ruta de vuelo con el nombre: &quot; + nombre);</span>
        }

<span class="fc bfc" id="L305" title="All 2 branches covered.">        if (ciudadOrigen.equalsIgnoreCase(ciudadDestino)) {</span>
<span class="fc" id="L306">            throw new IllegalArgumentException(&quot;La ciudad de origen y destino no pueden ser iguales.&quot;);</span>
        }

<span class="fc" id="L309">        List&lt;String&gt; categoriaValida = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">        for (String cat : categorias) {</span>
<span class="fc" id="L311">            Categoria categoria = manejadorCategoria.buscarCategorias(cat);</span>
<span class="fc bfc" id="L312" title="All 2 branches covered.">            if (categoria != null) {</span>
<span class="fc" id="L313">                categoriaValida.add(cat);</span>
            }
        }
<span class="fc bfc" id="L316" title="All 2 branches covered.">        if (categoriaValida.isEmpty()) {</span>
<span class="fc" id="L317">            throw new IllegalArgumentException(&quot;La ruta debe pertenecer a al menos una categoría válida.&quot;);</span>
        }

<span class="fc" id="L320">        RutaVuelo rutaVuelo = new RutaVuelo(nombre, descripcion, descripcionCorta, aero, ciudadOrigen, ciudadDestino,</span>
                hora, fechaAlta, costoTurista, costoEjecutivo,
                costoEquipajeExtra, categoriaValida, imagenUrl);

<span class="fc" id="L324">        manejadorRutaVuelo.agregarRutaVuelo(rutaVuelo, entManager);</span>
<span class="fc" id="L325">        manejadorAerolinea.agregarRutaVueloAAerolinea(aero.getNickname(), rutaVuelo, entManager);</span>
<span class="fc" id="L326">    }</span>

    @Override
    public List&lt;DtAerolinea&gt; obtenerAerolineasConRutasPendientes() {
<span class="fc" id="L330">        List&lt;DtAerolinea&gt; aerolineasConPendientes = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L331" title="All 2 branches covered.">        for (DtAerolinea aero : manejadorAerolinea.getDtAerolineas()) {</span>
<span class="fc" id="L332">            List&lt;RutaVuelo&gt; rutasPendientes = manejadorRutaVuelo.getRutasPorEstadoYAerolinea(</span>
<span class="fc" id="L333">                    aero.getNombre(), RutaVuelo.EstadoRuta.INGRESADA);</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">            if (!rutasPendientes.isEmpty()) {</span>
<span class="fc" id="L335">                aerolineasConPendientes.add(aero);</span>
            }
<span class="fc" id="L337">        }</span>

<span class="fc" id="L339">        return aerolineasConPendientes;</span>
    }

    @Override
    public List&lt;DtRutaVuelo&gt; obtenerRutasPendientesPorAerolinea(String nombreAerolinea) {
<span class="fc" id="L344">        List&lt;RutaVuelo&gt; rutasPendientes = manejadorRutaVuelo.getRutasPorEstadoYAerolinea(</span>
                nombreAerolinea, RutaVuelo.EstadoRuta.INGRESADA);

<span class="fc" id="L347">        List&lt;DtRutaVuelo&gt; dtRutasPendientes = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">        for (RutaVuelo ruta : rutasPendientes) {</span>
<span class="fc" id="L349">            dtRutasPendientes.add(ruta.getDtRutaVuelo());</span>
<span class="fc" id="L350">        }</span>
<span class="fc" id="L351">        return dtRutasPendientes;</span>
    }

    @Override
    public void aceptarRutaVuelo(String nombreRuta) {
<span class="fc" id="L356">        manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, RutaVuelo.EstadoRuta.CONFIRMADA, entManager);</span>
<span class="fc" id="L357">    }</span>

    @Override
    public void rechazarRutaVuelo(String nombreRuta) {
<span class="fc" id="L361">        manejadorRutaVuelo.cambiarEstadoRuta(nombreRuta, RutaVuelo.EstadoRuta.RECHAZADA, entManager);</span>
<span class="fc" id="L362">    }</span>

    @Override
    public RutaVuelo obtenerRuta(String nombreRuta) {
<span class="fc" id="L366">        return manejadorRutaVuelo.getRuta(nombreRuta);</span>
    }

    @Override
    public List&lt;DtRutaVuelo&gt; listarRutasPorAerolinea(String nombreAerolinea) {
<span class="fc" id="L371">        return manejadorAerolinea.obtenerRutaVueloDeAerolinea(nombreAerolinea);</span>
    }

    @Override
    public void altaVuelo(String nombreVuelo, String nombreAereolinea, String nombreRuta,
                          LocalDate fecha, int duracion, int asientosTurista,
                          int asientosEjecutivo, LocalDate fechaAlta, String imagenUrl) {

<span class="fc" id="L379">        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nombreRuta);</span>
<span class="fc bfc" id="L380" title="All 2 branches covered.">        if (ruta == null) {</span>
<span class="fc" id="L381">            throw new IllegalArgumentException(&quot;La ruta &quot; + nombreRuta + &quot; no existe.&quot;);</span>
        }

<span class="pc bpc" id="L384" title="1 of 2 branches missed.">        if (manejadorRutaVuelo.getVueloDeRuta(nombreRuta, nombreVuelo) != null) {</span>
<span class="nc" id="L385">            throw new IllegalArgumentException(&quot;Ya existe un vuelo con el nombre &quot; + nombreVuelo + &quot; en la ruta &quot; + nombreRuta);</span>
        }

<span class="fc" id="L388">        Vuelo vuelo = new Vuelo(nombreVuelo, nombreAereolinea, ruta, fecha, duracion,</span>
                asientosTurista, asientosEjecutivo, fechaAlta, imagenUrl);

<span class="fc" id="L391">        manejadorVuelo.agregarVuelo(vuelo, entManager);</span>
<span class="fc" id="L392">        manejadorRutaVuelo.agregarVueloARuta(nombreRuta, vuelo, entManager);</span>
<span class="fc" id="L393">    }</span>


    public Vuelo obtenerVuelo(String nombreVuelo) {
<span class="fc" id="L397">        return manejadorVuelo.getVuelo(nombreVuelo);</span>
    }

    @Override
    public List&lt;DtVuelo&gt; listarVuelosPorRuta(String nombreRuta) {
<span class="fc" id="L402">        return manejadorRutaVuelo.obtenerVuelosPorRuta(nombreRuta);</span>
    }

    @Override
    public DtVuelo verInfoVueloDt(String nombreVuelo) {
<span class="nc" id="L407">        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">        if (vuelo == null) {</span>
<span class="nc" id="L409">            throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);</span>
        }
<span class="nc" id="L411">        return vuelo.getDtVuelo();</span>
    }

    @Override
    public Vuelo verInfoVuelo(String nombreVuelo) {
<span class="fc" id="L416">        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);</span>
<span class="fc bfc" id="L417" title="All 2 branches covered.">        if (vuelo == null) {</span>
<span class="fc" id="L418">            throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);</span>
        }
<span class="fc" id="L420">        return vuelo;</span>
    }

    // --- RESERVA ---
    @Override
    public void crearYRegistrarReserva(String nicknameCliente, String nombreVuelo, LocalDate fechaReserva, double costo,
                                       TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra,
                                       List&lt;Pasajero&gt; pasajeros) {
<span class="fc" id="L428">        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);</span>
<span class="fc bfc" id="L429" title="All 2 branches covered.">        if (vuelo == null) {</span>
<span class="fc" id="L430">            throw new IllegalArgumentException(&quot;El vuelo no existe: &quot; + nombreVuelo);</span>
        }

<span class="pc bpc" id="L433" title="1 of 2 branches missed.">        if (ManejadorVuelo.getInstance().tieneReservaDeCliente(nicknameCliente, vuelo)) {</span>
<span class="nc" id="L434">            throw new IllegalArgumentException(</span>
                    &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo +
                            &quot;. Debe elegir otro vuelo o ruta.&quot;
            );
        }

<span class="fc" id="L440">        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);</span>
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">        if (cliente != null) {</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            for (DtReserva r : cliente.getReservas()) {</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">                if (r.getVuelo().equals(nombreVuelo)) {</span>
<span class="nc" id="L444">                    throw new IllegalArgumentException(</span>
                            &quot;El cliente &quot; + nicknameCliente + &quot; ya tiene una reserva para el vuelo &quot; + nombreVuelo + &quot;.&quot;
                    );
                }
<span class="nc" id="L448">            }</span>
        }

        // CREAR RESERVA SIN ID - se generará automáticamente
<span class="fc" id="L452">        Reserva reserva = new Reserva(</span>
                costo, tipoAsiento, cantidadPasajes, unidadesEquipajeExtra, pasajeros, vuelo
        );

<span class="nc" id="L456">        registrarReservaVuelo(nicknameCliente, nombreVuelo, reserva);</span>
<span class="nc" id="L457">    }</span>

    @Override
    public void registrarReservaVuelo(String nicknameCliente, String nombreVuelo, Reserva reserva) {
<span class="fc" id="L461">        EntityTransaction entTransaction = entManager.getTransaction();</span>
        try {
<span class="fc" id="L463">            entTransaction.begin();</span>

<span class="fc" id="L465">            DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);</span>
<span class="fc" id="L466">            Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);</span>

<span class="fc bfc" id="L468" title="All 2 branches covered.">            if (cliente == null) {</span>
<span class="fc" id="L469">                throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
            }
<span class="fc bfc" id="L471" title="All 2 branches covered.">            if (vuelo == null) {</span>
<span class="fc" id="L472">                throw new IllegalArgumentException(&quot;Vuelo no encontrado&quot;);</span>
            }

<span class="fc bfc" id="L475" title="All 2 branches covered.">            if (manejadorVuelo.tieneReservaDeCliente(nicknameCliente, vuelo)) {</span>
<span class="fc" id="L476">                throw new IllegalArgumentException(&quot;El cliente ya tiene una reserva para este vuelo&quot;);</span>
            }

            // Persistir reserva para generar ID automático
<span class="fc" id="L480">            entManager.persist(reserva);</span>
<span class="fc" id="L481">            entManager.flush(); // Forzar generación del ID</span>

            // Agregar reserva al vuelo y al cliente
<span class="fc" id="L484">            vuelo.agregarReserva(reserva);</span>
<span class="fc" id="L485">            manejadorCliente.agregarReserva(reserva, nicknameCliente, reserva.getId(), entManager);</span>
<span class="fc" id="L486">            manejadorVuelo.actualizarVuelo(vuelo, entManager); // Ahora sin transacción interna</span>

<span class="fc" id="L488">            entTransaction.commit();</span>

<span class="fc" id="L490">        } catch (PersistenceException e) {</span>
<span class="pc bpc" id="L491" title="1 of 2 branches missed.">            if (entTransaction.isActive()) {</span>
<span class="fc" id="L492">                entTransaction.rollback();</span>
            }
<span class="fc" id="L494">            throw new IllegalStateException(&quot;Error al registrar reserva: &quot; + e.getMessage(), e);</span>
<span class="fc" id="L495">        }</span>
<span class="fc" id="L496">    }</span>

    @Override
    public DtReserva obtenerReserva(Long idReserva, String nicknameCliente) { // Cambiado a Long
<span class="fc" id="L500">        DtCliente cliente = manejadorCliente.obtenerCliente(nicknameCliente);</span>
        try {
<span class="fc bfc" id="L502" title="All 2 branches covered.">            if (cliente == null) {</span>
<span class="fc" id="L503">                throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
            }
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">            for (DtReserva r : cliente.getReservas()) {</span>
<span class="pc bpc" id="L506" title="1 of 2 branches missed.">                if (r.getId().equals(idReserva)) {</span>
<span class="fc" id="L507">                    return r;</span>
                }
<span class="nc" id="L509">            }</span>
<span class="nc" id="L510">            throw new IllegalArgumentException(&quot;Reserva no encontrada&quot;);</span>
<span class="nc" id="L511">        } catch (PersistenceException e) {</span>
<span class="nc" id="L512">            throw new IllegalArgumentException(&quot;Error al obtener la reserva: &quot; + e.getMessage());</span>
        }
    }

    // --- PAQUETES ---
    @Override
    public void altaPaquete(String nombre, String descripcion, int descuentoPorc, int periodoValidezDias) {
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">        if (manejadorPaquete.obtenerPaquete(nombre) != null) {</span>
<span class="nc" id="L520">            throw new IllegalArgumentException(&quot;Ya existe un paquete con el nombre: &quot; + nombre);</span>
        }

<span class="pc bpc" id="L523" title="1 of 4 branches missed.">        if (nombre == null || nombre.trim().isEmpty()) {</span>
<span class="fc" id="L524">            throw new IllegalArgumentException(&quot;El nombre del paquete no puede estar vacío.&quot;);</span>
        }
<span class="fc bfc" id="L526" title="All 4 branches covered.">        if (descuentoPorc &lt; 0 || descuentoPorc &gt; 100) {</span>
<span class="fc" id="L527">            throw new IllegalArgumentException(&quot;El descuento debe estar entre 0 y 100 por ciento.&quot;);</span>
        }
<span class="fc bfc" id="L529" title="All 2 branches covered.">        if (periodoValidezDias &lt; 0) {</span>
<span class="fc" id="L530">            throw new IllegalArgumentException(&quot;El período de validez no puede ser negativo.&quot;);</span>
        }

<span class="fc" id="L533">        Paquete paquete = new Paquete(nombre.trim(), descripcion, descuentoPorc, periodoValidezDias);</span>
<span class="fc" id="L534">        manejadorPaquete.agregarPaquete(paquete, entManager);</span>
<span class="fc" id="L535">    }</span>

    @Override
    public List&lt;DtPaquete&gt; listarPaquetes() {
<span class="fc" id="L539">        return (List&lt;DtPaquete&gt;) manejadorPaquete.getPaquetes();</span>
    }

    @Override
    public void modificarDatosDeCliente(String nickname, String nombre, String apellido, String nacionalidad, LocalDate fechaNacimiento, TipoDoc tipoDoc, String numeroDocumento) {
<span class="fc" id="L544">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">        if (cliente != null) {</span>
<span class="fc" id="L546">            cliente.setApellido(apellido);</span>
<span class="fc" id="L547">            cliente.setNombre(nombre);</span>
<span class="fc" id="L548">            cliente.setNacionalidad(nacionalidad);</span>
<span class="fc" id="L549">            cliente.setFechaNacimiento(fechaNacimiento);</span>
<span class="fc" id="L550">            cliente.setTipoDocumento(tipoDoc);</span>
<span class="fc" id="L551">            cliente.setNumeroDocumento(numeroDocumento);</span>
<span class="fc" id="L552">            manejadorCliente.modificarDatosCliente(cliente, entManager);</span>
        } else {
<span class="nc" id="L554">            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
        }
<span class="fc" id="L556">    }</span>

    @Override
    public void modificarDatosAerolinea(String nickname, String descripcion, String url) {
<span class="fc" id="L560">        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);</span>
<span class="fc bfc" id="L561" title="All 2 branches covered.">        if (aerolinea != null) {</span>
<span class="fc" id="L562">            aerolinea.setDescripcion(descripcion);</span>
<span class="fc" id="L563">            aerolinea.setSitioWeb(url);</span>
<span class="fc" id="L564">            manejadorAerolinea.modificarDatosAerolinea(aerolinea, entManager);</span>
        } else {
<span class="fc" id="L566">            throw new IllegalArgumentException(&quot;Aerolínea no encontrada&quot;);</span>
        }
<span class="fc" id="L568">    }</span>

    @Override
    public List&lt;DtPaquete&gt; listarPaquetesDisp() {
<span class="fc" id="L572">        return manejadorPaquete.getPaquetesDisp();</span>
    }

    @Override
    public double calcularCostoReserva(String nombreVuelo, TipoAsiento tipoAsiento, int cantidadPasajes, int unidadesEquipajeExtra) {
<span class="fc" id="L577">        ManejadorVuelo manejadorVuelo = ManejadorVuelo.getInstance();</span>
<span class="fc" id="L578">        Vuelo vuelo = manejadorVuelo.getVuelo(nombreVuelo);</span>

<span class="fc bfc" id="L580" title="All 2 branches covered.">        if (vuelo == null) {</span>
<span class="fc" id="L581">            throw new IllegalArgumentException(&quot;Vuelo no encontrado: &quot; + nombreVuelo);</span>
        }

        double costoBase;
<span class="fc bfc" id="L585" title="All 2 branches covered.">        if (tipoAsiento == TipoAsiento.TURISTA) {</span>
<span class="fc" id="L586">            costoBase = 100.0;</span>
        } else {
<span class="fc" id="L588">            costoBase = 200.0;</span>
        }

<span class="fc" id="L591">        double costoPasajes = costoBase * cantidadPasajes;</span>
<span class="fc" id="L592">        double costoEquipaje = 30.0 * unidadesEquipajeExtra;</span>

<span class="fc" id="L594">        return costoPasajes + costoEquipaje;</span>
    }

    @Override
    public Pasajero crearPasajero(String nombre, String apellido) {
<span class="pc bpc" id="L599" title="1 of 4 branches missed.">        if (nombre == null || nombre.trim().isEmpty()) {</span>
<span class="fc" id="L600">            throw new IllegalArgumentException(&quot;El nombre del pasajero no puede estar vacío.&quot;);</span>
        }
<span class="pc bpc" id="L602" title="1 of 4 branches missed.">        if (apellido == null || apellido.trim().isEmpty()) {</span>
<span class="fc" id="L603">            throw new IllegalArgumentException(&quot;El apellido del pasajero no puede estar vacío.&quot;);</span>
        }
<span class="fc" id="L605">        return new Pasajero(nombre.trim(), apellido.trim());</span>
    }

    @Override
    public void compraPaquete(String nomPaquete, String nomCliente, int validezDias, LocalDate fechaC, double costo) {
<span class="fc" id="L610">        Paquete paquete = manejadorPaquete.obtenerPaquete(nomPaquete);</span>
<span class="fc bfc" id="L611" title="All 2 branches covered.">        if (paquete == null) {</span>
<span class="fc" id="L612">            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);</span>
        }

<span class="fc" id="L615">        DtCliente dtCliente = manejadorCliente.obtenerCliente(nomCliente);</span>
<span class="fc bfc" id="L616" title="All 2 branches covered.">        if (dtCliente == null) {</span>
<span class="fc" id="L617">            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
        }

<span class="fc bfc" id="L620" title="All 2 branches covered.">        for (CompraPaqLogica cp : paquete.getCompras()) {</span>
<span class="pc bpc" id="L621" title="1 of 2 branches missed.">            if (cp.getCliente().getNickname().equals(dtCliente.getNickname())) {</span>
<span class="fc" id="L622">                throw new IllegalArgumentException(&quot;Error, el cliente &quot; + dtCliente.getNombre() + &quot; ya compró el paquete &quot; + paquete.getNombre() + &quot;. Elija otro o cancele.&quot;);</span>
            }
<span class="nc" id="L624">        }</span>

        try {
<span class="fc" id="L627">            manejadorPaquete.compraPaquete(paquete, dtCliente, validezDias, fechaC, costo, entManager);</span>
<span class="fc" id="L628">            LOGGER.info(() -&gt; &quot;Paquete comprado correctamente para cliente: &quot; + dtCliente.getNickname() + &quot;, paquete: &quot; + paquete.getNombre());</span>
<span class="nc" id="L629">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L630">            LOGGER.log(Level.SEVERE, () -&gt; &quot;Error comprando paquete: &quot; + e.getMessage());</span>
<span class="nc" id="L631">            throw e;</span>
<span class="fc" id="L632">        }</span>
<span class="fc" id="L633">    }</span>

    @Override
    public void altaCategoria(String nomCat) {
<span class="fc" id="L637">        Categoria cat = manejadorCategoria.buscarCategorias(nomCat);</span>
<span class="fc bfc" id="L638" title="All 2 branches covered.">        if (cat != null) {</span>
<span class="fc" id="L639">            throw new IllegalArgumentException(&quot;Error, la categoria ya existe.&quot;);</span>
        }

        try {
<span class="fc" id="L643">            Categoria categoria = new Categoria(nomCat);</span>
<span class="fc" id="L644">            manejadorCategoria.agregarCategoria(categoria, entManager);</span>
<span class="fc" id="L645">            LOGGER.info(() -&gt; &quot;Categoría creada correctamente: &quot; + nomCat);</span>
<span class="nc" id="L646">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L647">            LOGGER.log(Level.SEVERE, () -&gt; &quot;Error creando categoría: &quot; + e.getMessage());</span>
<span class="nc" id="L648">            throw e;</span>
<span class="fc" id="L649">        }</span>
<span class="fc" id="L650">    }</span>

    @Override
    public List&lt;Object&gt; obtenerDatosAdicionalesUsuario(String nickname) {
<span class="fc" id="L654">        List&lt;Object&gt; adicionales = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L655">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="fc bfc" id="L656" title="All 2 branches covered.">        if (cliente != null) {</span>
<span class="fc" id="L657">            adicionales.addAll(cliente.getReservas());</span>
<span class="fc" id="L658">            adicionales.addAll(cliente.getPaquetesComprados());</span>
<span class="fc" id="L659">            return adicionales;</span>
        }
<span class="fc" id="L661">        Aerolinea aerolinea = manejadorAerolinea.obtenerAerolinea(nickname);</span>
<span class="pc bpc" id="L662" title="1 of 2 branches missed.">        if (aerolinea != null) {</span>
<span class="fc" id="L663">            adicionales.addAll(aerolinea.getRutasVuelo());</span>
<span class="fc" id="L664">            return adicionales;</span>
        }
<span class="nc" id="L666">        return adicionales;</span>
    }

    @Override
    public List&lt;DtCiudad&gt; listarCiudades() {
<span class="fc" id="L671">        List&lt;DtCiudad&gt; dtCiudades = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L672" title="All 2 branches covered.">        for (Ciudad ciudad : manejadorCiudad.getCiudades()) {</span>
<span class="fc" id="L673">            dtCiudades.add(new DtCiudad(ciudad.getNombre(), ciudad.getPais()));</span>
<span class="fc" id="L674">        }</span>
<span class="fc" id="L675">        return dtCiudades;</span>
    }

    @Override
    public List&lt;DtCategoria&gt; listarCategorias() {
<span class="fc" id="L680">        List&lt;DtCategoria&gt; lista = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L681" title="All 2 branches covered.">        for (Categoria c : manejadorCategoria.getCategorias().values()) {</span>
<span class="fc" id="L682">            lista.add(new DtCategoria(c.getNombre()));</span>
<span class="fc" id="L683">        }</span>
<span class="fc" id="L684">        return lista;</span>
    }

    @Override
    public void altaRutaPaquete(String nombrePaquete, String nomRuta, int cantidadAsientos, TipoAsiento tipoAsiento) {
<span class="fc" id="L689">        Paquete paquete = manejadorPaquete.obtenerPaquete(nombrePaquete);</span>
<span class="fc bfc" id="L690" title="All 2 branches covered.">        if (paquete == null) {</span>
<span class="fc" id="L691">            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);</span>
        }

<span class="fc bfc" id="L694" title="All 2 branches covered.">        if (paquete.estaComprado()) {</span>
<span class="fc" id="L695">            throw new IllegalArgumentException(&quot;No se pueden agregar rutas a un paquete que ya ha sido comprado.&quot;);</span>
        }

<span class="fc" id="L698">        RutaVuelo ruta = manejadorRutaVuelo.getRuta(nomRuta);</span>
<span class="pc bpc" id="L699" title="1 of 2 branches missed.">        if (ruta == null) {</span>
<span class="nc" id="L700">            throw new IllegalArgumentException(&quot;No se encontró la ruta con ese nombre.&quot;);</span>
        }

<span class="pc bpc" id="L703" title="1 of 2 branches missed.">        if (ruta.getEstado() != RutaVuelo.EstadoRuta.CONFIRMADA) {</span>
<span class="nc" id="L704">            throw new IllegalArgumentException(&quot;No se puede agregar una ruta que no esté CONFIRMADA al paquete. Ruta actual: &quot; + ruta.getEstado());</span>
        }

<span class="fc" id="L707">        manejadorPaquete.agregarRutaAPaquete(paquete, ruta, cantidadAsientos, tipoAsiento, entManager);</span>

<span class="fc" id="L709">        DtPaquete dtPaquete = obtenerDtPaquete(nombrePaquete);</span>
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">        if (dtPaquete != null) {</span>
<span class="fc" id="L711">            DtRutaVuelo dtRuta = ruta.getDtRutaVuelo();</span>
<span class="fc" id="L712">            DtItemPaquete dtItem = new DtItemPaquete(dtRuta, cantidadAsientos, tipoAsiento.toString());</span>
<span class="fc" id="L713">            dtPaquete.getItems().add(dtItem);</span>
        }
<span class="fc" id="L715">        LOGGER.info(() -&gt; &quot;Ruta agregada al paquete correctamente: &quot; + nombrePaquete + &quot;, ruta: &quot; + nomRuta);</span>
<span class="fc" id="L716">    }</span>

    @Override
    public Paquete obtenerPaquete(String nombrePaquete) {
<span class="fc" id="L720">        Paquete paquete = manejadorPaquete.obtenerPaquete(nombrePaquete);</span>
<span class="fc bfc" id="L721" title="All 2 branches covered.">        if (paquete == null) {</span>
<span class="fc" id="L722">            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);</span>
        }
<span class="fc" id="L724">        return paquete;</span>
    }

    @Override
    public DtPaquete obtenerDtPaquete(String nombrePaquete) {
<span class="fc" id="L729">        DtPaquete paquete = manejadorPaquete.obtenerDtPaquete(nombrePaquete);</span>
<span class="fc bfc" id="L730" title="All 2 branches covered.">        if (paquete == null) {</span>
<span class="fc" id="L731">            throw new IllegalArgumentException(&quot;Paquete no encontrado&quot;);</span>
        }
<span class="fc" id="L733">        return paquete;</span>
    }

    @Override
    public List&lt;DtAerolinea&gt; getAerolineas() {
<span class="nc" id="L738">        return manejadorAerolinea.getDtAerolineas();</span>
    }

    @Override
    public List&lt;DtPaquete&gt; getPaquetesDisp() {
<span class="nc" id="L743">        return manejadorPaquete.getPaquetes();</span>
    }

    @Override
    public List&lt;DtCliente&gt; getClientes() {
<span class="nc" id="L748">        return manejadorCliente.getClientes();</span>
    }

    @Override
    public List&lt;DtReserva&gt; getReservasCliente(String nickname) {
<span class="fc" id="L753">        DtCliente cliente = manejadorCliente.obtenerCliente(nickname);</span>
<span class="fc bfc" id="L754" title="All 2 branches covered.">        if (cliente != null) {</span>
<span class="fc" id="L755">            return cliente.getReservas();</span>
        } else {
<span class="fc" id="L757">            throw new IllegalArgumentException(&quot;Cliente no encontrado&quot;);</span>
        }
    }

    @Override
    public List&lt;DtItemPaquete&gt; getDtItemRutasPaquete(String nombrePaquete) {
<span class="fc" id="L763">        List&lt;DtItemPaquete&gt; items = manejadorPaquete.obtenerDtItemsPaquete(nombrePaquete);</span>
<span class="pc bpc" id="L764" title="1 of 4 branches missed.">        if (items != null &amp;&amp; !items.isEmpty()) {</span>
<span class="fc" id="L765">            return items;</span>
        } else {
<span class="fc" id="L767">            throw new IllegalArgumentException(&quot;Paquete no encontrado o sin rutas asociadas&quot;);</span>
        }
    }

    public List&lt;DtRutaVuelo&gt; listarRutasConfirmadas(int limite) {
<span class="fc" id="L772">        List&lt;DtRutaVuelo&gt; rutasConfirmadas = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L773">        List&lt;DtAerolinea&gt; aerolineas = listarAerolineas();</span>

<span class="fc bfc" id="L775" title="All 2 branches covered.">        for (DtAerolinea aerolinea : aerolineas) {</span>
            try {
<span class="fc" id="L777">                List&lt;DtRutaVuelo&gt; rutasAerolinea = listarRutasPorAerolinea(aerolinea.getNickname());</span>
<span class="fc bfc" id="L778" title="All 2 branches covered.">                for (DtRutaVuelo ruta : rutasAerolinea) {</span>
<span class="fc bfc" id="L779" title="All 2 branches covered.">                    if (&quot;CONFIRMADA&quot;.equals(ruta.getEstado())) {</span>
<span class="fc" id="L780">                        rutasConfirmadas.add(ruta);</span>
<span class="fc bfc" id="L781" title="All 2 branches covered.">                        if (rutasConfirmadas.size() &gt;= limite) {</span>
<span class="fc" id="L782">                            return rutasConfirmadas;</span>
                        }
                    }
<span class="fc" id="L785">                }</span>
<span class="nc" id="L786">            } catch (PersistenceException  e) {</span>
<span class="nc" id="L787">                continue;</span>
<span class="fc" id="L788">            }</span>
<span class="fc" id="L789">        }</span>
<span class="fc" id="L790">        return rutasConfirmadas;</span>
    }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>